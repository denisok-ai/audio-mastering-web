<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü—Ä–æ—Ñ–∏–ª—å ‚Äî Magic Master</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #080810; --bg2: #0c0c18;
      --surface: rgba(16,16,28,0.92); --surface2: rgba(22,22,38,0.97);
      --border: rgba(255,255,255,0.07);
      --text: #e8e8f0; --text-soft: #9898b8; --text-dim: #52527a;
      --accent: #6c4bff; --accent2: #a855f7; --accent-glow: rgba(108,75,255,0.35);
      --cyan: #22d3ee; --green: #34d399; --amber: #fbbf24; --red: #f87171;
      --r: 14px; --r-lg: 20px; --r-sm: 8px;
      --shadow: 0 4px 32px rgba(0,0,0,.55), 0 1px 0 rgba(255,255,255,.04) inset;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Space Grotesk', system-ui, sans-serif;
      background: var(--bg); color: var(--text);
      min-height: 100vh;
    }
    .bg {
      position: fixed; inset: 0; pointer-events: none; z-index: 0;
      background:
        radial-gradient(ellipse 70% 50% at 15% 5%, rgba(108,75,255,.12) 0%, transparent 55%),
        radial-gradient(ellipse 60% 40% at 85% 90%, rgba(168,85,247,.09) 0%, transparent 55%);
    }

    /* ‚îÄ‚îÄ Topbar ‚îÄ‚îÄ */
    .topbar {
      position: sticky; top: 0; z-index: 100;
      display: flex; align-items: center; justify-content: space-between;
      padding: .8rem 2rem;
      background: rgba(8,8,16,.85);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
    }
    .topbar-logo { font-weight: 700; font-size: 1.05rem; color: var(--accent2); text-decoration: none; }
    .topbar-nav { display: flex; gap: 1.2rem; align-items: center; }
    .topbar-nav a {
      color: var(--text-soft); text-decoration: none; font-size: .88rem; font-weight: 500;
      transition: color .15s;
    }
    .topbar-nav a:hover { color: var(--text); }
    .topbar-nav a.active { color: var(--accent2); }
    .btn-sm-nav {
      padding: .38rem .9rem; border-radius: var(--r-sm);
      background: rgba(108,75,255,.18); border: 1px solid rgba(108,75,255,.35);
      color: var(--accent2); font-size: .82rem; font-weight: 600; cursor: pointer;
      text-decoration: none; transition: background .15s;
    }
    .btn-sm-nav:hover { background: rgba(108,75,255,.32); }

    /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
    .container { max-width: 900px; margin: 0 auto; padding: 2.5rem 1.5rem 4rem; position: relative; z-index: 1; }
    .page-title { font-size: 1.7rem; font-weight: 700; margin-bottom: 2rem; }
    .page-title span { color: var(--accent2); }

    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      margin-bottom: 1.5rem;
    }
    .card-title {
      font-size: .8rem; font-weight: 700; letter-spacing: .08em;
      text-transform: uppercase; color: var(--text-dim); margin-bottom: 1.2rem;
    }

    /* ‚îÄ‚îÄ Info grid ‚îÄ‚îÄ */
    .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; }
    .info-item label { font-size: .75rem; color: var(--text-soft); display: block; margin-bottom: .25rem; }
    .info-item .val { font-size: 1rem; font-weight: 600; }

    /* ‚îÄ‚îÄ Tier badge ‚îÄ‚îÄ */
    .tier-badge {
      display: inline-flex; align-items: center; gap: .35rem;
      padding: .25rem .75rem; border-radius: 20px; font-size: .82rem; font-weight: 700;
    }
    .tier-free  { background: rgba(152,152,184,.12); color: var(--text-soft); border: 1px solid rgba(152,152,184,.2); }
    .tier-pro   { background: rgba(108,75,255,.15);  color: var(--accent2);   border: 1px solid rgba(108,75,255,.3); }
    .tier-studio{ background: rgba(251,191,36,.12);  color: var(--amber);     border: 1px solid rgba(251,191,36,.3); }

    /* ‚îÄ‚îÄ Sub status ‚îÄ‚îÄ */
    .sub-active  { color: var(--green); }
    .sub-expired { color: var(--red); }
    .sub-none    { color: var(--text-dim); }

    /* ‚îÄ‚îÄ Stats row ‚îÄ‚îÄ */
    .stats-row { display: flex; gap: 1.5rem; flex-wrap: wrap; }
    .stat-box {
      flex: 1; min-width: 120px;
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: var(--r); padding: 1rem 1.2rem; text-align: center;
    }
    .stat-box .n { font-size: 1.8rem; font-weight: 700; color: var(--accent2); font-family: 'JetBrains Mono', monospace; }
    .stat-box .l { font-size: .75rem; color: var(--text-soft); margin-top: .25rem; }

    /* ‚îÄ‚îÄ History table ‚îÄ‚îÄ */
    .history-table { width: 100%; border-collapse: collapse; font-size: .85rem; }
    .history-table th { text-align: left; padding: .5rem .75rem; color: var(--text-soft); font-weight: 600; font-size: .75rem; border-bottom: 1px solid var(--border); }
    .history-table td { padding: .55rem .75rem; border-bottom: 1px solid rgba(255,255,255,.04); }
    .history-table tr:last-child td { border-bottom: none; }
    .history-table tr:hover td { background: rgba(108,75,255,.05); }
    .mono { font-family: 'JetBrains Mono', monospace; font-size: .8em; }
    .empty-msg { text-align: center; padding: 2.5rem; color: var(--text-dim); }

    /* ‚îÄ‚îÄ Password form ‚îÄ‚îÄ */
    .form-col { display: flex; flex-direction: column; gap: .9rem; max-width: 400px; }
    .form-col label { font-size: .8rem; color: var(--text-soft); margin-bottom: .2rem; display: block; }
    .form-col input {
      width: 100%; background: var(--surface2); border: 1px solid var(--border);
      border-radius: var(--r-sm); padding: .65rem .9rem;
      color: var(--text); font-size: .9rem; outline: none; transition: border-color .15s;
    }
    .form-col input:focus { border-color: rgba(108,75,255,.5); }
    .btn-primary {
      display: inline-flex; align-items: center; gap: .45rem;
      padding: .65rem 1.4rem; border-radius: var(--r-sm);
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff; font-weight: 700; font-size: .9rem; border: none; cursor: pointer;
      transition: opacity .15s;
    }
    .btn-primary:hover { opacity: .88; }
    .btn-primary:disabled { opacity: .45; cursor: not-allowed; }
    .btn-outline {
      display: inline-flex; align-items: center; gap: .45rem;
      padding: .55rem 1.2rem; border-radius: var(--r-sm);
      background: transparent; border: 1px solid var(--border);
      color: var(--text-soft); font-size: .85rem; font-weight: 600; cursor: pointer;
      transition: border-color .15s, color .15s; text-decoration: none;
    }
    .btn-outline:hover { border-color: rgba(108,75,255,.4); color: var(--accent2); }

    /* ‚îÄ‚îÄ Danger zone ‚îÄ‚îÄ */
    .danger-zone { border-color: rgba(248,113,113,.18); }
    .danger-zone .card-title { color: var(--red); }

    /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
    .toast {
      position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 999;
      padding: .7rem 1.2rem; border-radius: var(--r-sm); font-size: .88rem; font-weight: 600;
      opacity: 0; transform: translateY(8px); transition: all .25s;
      pointer-events: none;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.ok  { background: rgba(52,211,153,.18); border: 1px solid rgba(52,211,153,.3); color: var(--green); }
    .toast.err { background: rgba(248,113,113,.18); border: 1px solid rgba(248,113,113,.3); color: var(--red); }
    .toast.inf { background: rgba(108,75,255,.18); border: 1px solid rgba(108,75,255,.35); color: var(--accent2); }

    /* ‚îÄ‚îÄ Subscription expiry warning ‚îÄ‚îÄ */
    .sub-warning {
      background: rgba(251,191,36,.08); border: 1px solid rgba(251,191,36,.25);
      border-radius: var(--r); padding: .8rem 1.2rem;
      color: var(--amber); font-size: .87rem; margin-bottom: 1.5rem;
    }
    .sub-expired-banner {
      background: rgba(248,113,113,.08); border: 1px solid rgba(248,113,113,.25);
      border-radius: var(--r); padding: .8rem 1.2rem;
      color: var(--red); font-size: .87rem; margin-bottom: 1.5rem;
    }

    @media (max-width: 600px) {
      .topbar { padding: .7rem 1rem; }
      .container { padding: 1.5rem 1rem 3rem; }
      .stats-row { gap: .8rem; }
    }
  </style>
</head>
<body>
<div class="bg"></div>

<!-- Topbar -->
<header class="topbar">
  <a href="/" class="topbar-logo">‚ú® Magic Master</a>
  <nav class="topbar-nav">
    <a href="/app">–ú–∞—Å—Ç–µ—Ä–∏–Ω–≥</a>
    <a href="/pricing">–¢–∞—Ä–∏—Ñ—ã</a>
    <a href="/profile" class="active">–ü—Ä–æ—Ñ–∏–ª—å</a>
    <a href="#" id="logoutLink" class="btn-sm-nav" style="display:none">–í—ã–π—Ç–∏</a>
  </nav>
</header>

<div class="container">
  <div class="page-title">–ú–æ–π <span>–ø—Ä–æ—Ñ–∏–ª—å</span></div>

  <!-- Subscription expiry banners -->
  <div id="subWarning" style="display:none" class="sub-warning">
    ‚ö†Ô∏è –í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç <strong id="subExpireDate"></strong>. <a href="/pricing" style="color:var(--amber)">–ü—Ä–æ–¥–ª–∏—Ç—å ‚Üí</a>
  </div>
  <div id="subExpiredBanner" style="display:none" class="sub-expired-banner">
    ‚ùå –í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞. –¢–∞—Ä–∏—Ñ –ø–æ–Ω–∏–∂–µ–Ω –¥–æ <strong>Free</strong>. <a href="/pricing" style="color:var(--red)">–û–±–Ω–æ–≤–∏—Ç—å ‚Üí</a>
  </div>

  <!-- Account info -->
  <div class="card" id="cardAccount">
    <div class="card-title">–ê–∫–∫–∞—É–Ω—Ç</div>
    <div class="info-grid">
      <div class="info-item">
        <label>Email</label>
        <div class="val" id="profileEmail">‚Äî</div>
      </div>
      <div class="info-item">
        <label>–¢–∞—Ä–∏—Ñ</label>
        <div class="val" id="profileTier">‚Äî</div>
      </div>
      <div class="info-item">
        <label>–ü–æ–¥–ø–∏—Å–∫–∞</label>
        <div class="val" id="profileSubStatus">‚Äî</div>
      </div>
      <div class="info-item">
        <label>–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ</label>
        <div class="val" id="profileSubExpires">‚Äî</div>
      </div>
      <div class="info-item">
        <label>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</label>
        <div class="val" id="profileCreatedAt">‚Äî</div>
      </div>
      <div class="info-item">
        <label>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</label>
        <div class="val" id="profileLastLogin">‚Äî</div>
      </div>
    </div>
    <div style="margin-top:1.2rem; display:flex; gap:.7rem; flex-wrap:wrap">
      <a href="/pricing" class="btn-outline">‚ö° –£–ª—É—á—à–∏—Ç—å —Ç–∞—Ä–∏—Ñ</a>
      <a href="/app" class="btn-outline">üéõ –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∏–Ω–≥</a>
    </div>
  </div>

  <!-- Statistics -->
  <div class="card">
    <div class="card-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
    <div class="stats-row" id="statsRow">
      <div class="stat-box"><div class="n" id="statTotal">‚Äî</div><div class="l">–ú–∞—Å—Ç–µ—Ä–∏–Ω–≥–æ–≤</div></div>
      <div class="stat-box"><div class="n" id="statAvgLufs">‚Äî</div><div class="l">–°—Ä–µ–¥–Ω–∏–π LUFS</div></div>
      <div class="stat-box"><div class="n" id="statAvgDelta">‚Äî</div><div class="l">–°—Ä. –∏–∑–º–µ–Ω–µ–Ω–∏–µ LUFS</div></div>
      <div class="stat-box"><div class="n" id="statHours">‚Äî</div><div class="l">–ß–∞—Å–æ–≤ –∞—É–¥–∏–æ</div></div>
    </div>
  </div>

  <!-- History -->
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.2rem">
      <div class="card-title" style="margin-bottom:0">–ò—Å—Ç–æ—Ä–∏—è –º–∞—Å—Ç–µ—Ä–∏–Ω–≥–æ–≤</div>
      <button class="btn-outline" id="btnExportHistory" style="padding:.3rem .8rem;font-size:.78rem">‚¨á CSV</button>
    </div>
    <div id="historyWrap">
      <p class="empty-msg">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</p>
    </div>
  </div>

  <!-- Change password -->
  <div class="card">
    <div class="card-title">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</div>
    <div class="form-col" id="passForm">
      <div>
        <label>–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
        <input type="password" id="oldPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
      </div>
      <div>
        <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
        <input type="password" id="newPass" placeholder="–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" autocomplete="new-password">
      </div>
      <div>
        <label>–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
        <input type="password" id="newPass2" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password">
      </div>
      <div>
        <button class="btn-primary" id="btnChangePass">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
      </div>
      <div id="passMsg" style="font-size:.82rem; min-height:1.1em"></div>
    </div>
  </div>

  <!-- API Keys (P52) ‚Äî –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è Pro/Studio -->
  <div class="card" id="apiKeysCard" style="display:none">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.2rem">
      <div class="card-title" style="margin-bottom:0">API-–∫–ª—é—á–∏</div>
      <button class="btn-outline" id="btnCreateKey" style="padding:.3rem .8rem;font-size:.78rem">+ –°–æ–∑–¥–∞—Ç—å –∫–ª—é—á</button>
    </div>
    <p style="font-size:.8rem;color:var(--text-soft);margin-bottom:1rem">
      –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ API-–∫–ª—é—á –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∞—Å—Ç–µ—Ä–∏–Ω–≥—É.<br>
      –ü–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ <code style="background:rgba(108,75,255,.15);padding:.1rem .4rem;border-radius:4px;font-size:.75rem">X-API-Key: &lt;–∫–ª—é—á&gt;</code> –≤–º–µ—Å—Ç–æ Bearer JWT.
    </p>
    <div id="apiKeysList" style="margin-bottom:1rem">
      <p style="color:var(--text-soft);font-size:.85rem">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</p>
    </div>
    <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è -->
    <div id="createKeyForm" style="display:none;background:rgba(108,75,255,.07);border:1px solid rgba(108,75,255,.2);border-radius:8px;padding:1rem;margin-top:.5rem">
      <label style="font-size:.8rem;color:var(--text-soft);display:block;margin-bottom:.4rem">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª—é—á–∞</label>
      <input id="newKeyName" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: DAW Integration" maxlength="100"
        style="width:100%;background:rgba(22,22,38,.9);border:1px solid var(--border);border-radius:8px;padding:.55rem .8rem;color:var(--text);font-size:.88rem;outline:none;margin-bottom:.7rem;font-family:inherit">
      <div style="display:flex;gap:.6rem">
        <button class="btn-primary" id="btnSaveKey" style="padding:.45rem 1rem;font-size:.85rem">–°–æ–∑–¥–∞—Ç—å</button>
        <button class="btn-outline" id="btnCancelKey" style="padding:.4rem .9rem;font-size:.82rem">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç (–Ω–æ–≤—ã–π –∫–ª—é—á) -->
    <div id="newKeyResult" style="display:none;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.25);border-radius:8px;padding:1rem;margin-top:.7rem">
      <div style="font-size:.78rem;color:#34d399;font-weight:700;margin-bottom:.5rem">‚ö† –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–ª—é—á ‚Äî –æ–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑!</div>
      <code id="newKeyValue" style="display:block;word-break:break-all;font-size:.8rem;background:rgba(0,0,0,.3);padding:.6rem .8rem;border-radius:6px;color:#e8e8f0;user-select:all;margin-bottom:.6rem"></code>
      <button class="btn-outline" id="btnCopyKey" style="padding:.3rem .8rem;font-size:.75rem">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
  </div>

</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
const API = '';
const token = localStorage.getItem('mm_token');

if (!token) {
  window.location.href = '/login.html?redirect=/profile';
}

function toast(msg, type = 'inf', ms = 3000) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `toast ${type} show`;
  setTimeout(() => { el.classList.remove('show'); }, ms);
}

function fmtDate(ts) {
  if (!ts) return '‚Äî';
  return new Date(ts * 1000).toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function fmtDateOnly(ts) {
  if (!ts) return '‚Äî';
  return new Date(ts * 1000).toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function fmtDuration(sec) {
  if (!sec) return '‚Äî';
  const m = Math.floor(sec / 60), s = Math.floor(sec % 60);
  return `${m}:${String(s).padStart(2, '0')}`;
}

function tierBadge(tier) {
  const map = { free: ['Free', 'tier-free'], pro: ['Pro', 'tier-pro'], studio: ['Studio', 'tier-studio'] };
  const [label, cls] = map[tier] || [tier, 'tier-free'];
  return `<span class="tier-badge ${cls}">${label}</span>`;
}

function subStatusHtml(status) {
  if (status === 'active')   return '<span class="sub-active">‚óè –ê–∫—Ç–∏–≤–Ω–∞</span>';
  if (status === 'expired')  return '<span class="sub-expired">‚úï –ò—Å—Ç–µ–∫–ª–∞</span>';
  if (status === 'cancelled')return '<span class="sub-expired">‚úï –û—Ç–º–µ–Ω–µ–Ω–∞</span>';
  return '<span class="sub-none">‚Äî</span>';
}

async function loadProfile() {
  try {
    const r = await fetch(API + '/api/auth/profile', {
      headers: { Authorization: 'Bearer ' + token }
    });
    if (r.status === 401) { window.location.href = '/login.html?redirect=/profile'; return; }
    const d = await r.json();

    document.getElementById('profileEmail').textContent = d.email || '‚Äî';
    document.getElementById('profileTier').innerHTML = tierBadge(d.tier || 'free');
    document.getElementById('profileSubStatus').innerHTML = subStatusHtml(d.subscription_status || 'none');
    document.getElementById('profileSubExpires').textContent = d.subscription_expires_at ? fmtDateOnly(d.subscription_expires_at) : '‚Äî';
    document.getElementById('profileCreatedAt').textContent = fmtDateOnly(d.created_at);
    document.getElementById('profileLastLogin').textContent = fmtDate(d.last_login_at);

    // Expiry banners
    if (d.subscription_expires_at) {
      const now = Date.now() / 1000;
      const diff = d.subscription_expires_at - now;
      if (d.subscription_status === 'expired' || diff < 0) {
        document.getElementById('subExpiredBanner').style.display = 'block';
      } else if (diff < 3 * 86400) {
        document.getElementById('subExpireDate').textContent = fmtDateOnly(d.subscription_expires_at);
        document.getElementById('subWarning').style.display = 'block';
      }
    }

    // Stats
    const s = d.stats || {};
    document.getElementById('statTotal').textContent = s.total_masterings ?? '0';
    document.getElementById('statAvgLufs').textContent = s.avg_after_lufs != null ? s.avg_after_lufs.toFixed(1) : '‚Äî';
    document.getElementById('statAvgDelta').textContent = s.avg_lufs_delta != null
      ? (s.avg_lufs_delta > 0 ? '+' : '') + s.avg_lufs_delta.toFixed(1)
      : '‚Äî';
    const totalSec = s.total_duration_sec || 0;
    document.getElementById('statHours').textContent = totalSec > 3600
      ? (totalSec / 3600).toFixed(1) + ' —á'
      : Math.round(totalSec / 60) + ' –º–∏–Ω';

    // Logout link
    document.getElementById('logoutLink').style.display = 'inline-flex';
    document.getElementById('logoutLink').addEventListener('click', e => {
      e.preventDefault();
      localStorage.removeItem('mm_token');
      window.location.href = '/';
    });

    // P52: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º API-–∫–ª—é—á–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è Pro/Studio
    if (d.tier === 'pro' || d.tier === 'studio') {
      const apiCard = document.getElementById('apiKeysCard');
      if (apiCard) apiCard.style.display = 'block';
      loadApiKeys();
    }

  } catch (e) {
    toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è: ' + e.message, 'err');
  }
}

async function loadHistory() {
  const wrap = document.getElementById('historyWrap');
  try {
    const r = await fetch(API + '/api/auth/history', {
      headers: { Authorization: 'Bearer ' + token }
    });
    const d = await r.json();
    const records = d.records || [];
    if (!records.length) {
      wrap.innerHTML = '<p class="empty-msg">–ú–∞—Å—Ç–µ—Ä–∏–Ω–≥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. <a href="/app" style="color:var(--accent2)">–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ä–≤—ã–π ‚Üí</a></p>';
      return;
    }
    wrap.innerHTML = `<table class="history-table">
      <thead>
        <tr>
          <th>–§–∞–π–ª</th>
          <th>–°—Ç–∏–ª—å</th>
          <th>–§–æ—Ä–º–∞—Ç</th>
          <th>–î–æ ‚Üí –ü–æ—Å–ª–µ LUFS</th>
          <th>–î–ª–∏–Ω–∞</th>
          <th>–î–∞—Ç–∞</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        ${records.map(r => `
          <tr>
            <td title="${r.filename}">${r.filename ? r.filename.replace(/^(.{22}).*(\.\w+)$/, '$1‚Ä¶$2') : '‚Äî'}</td>
            <td>${r.style || '‚Äî'}</td>
            <td class="mono">${(r.out_format || 'wav').toUpperCase()}</td>
            <td class="mono">${r.before_lufs != null ? r.before_lufs.toFixed(1) : '‚Äî'} ‚Üí ${r.after_lufs != null ? r.after_lufs.toFixed(1) : '‚Äî'}</td>
            <td class="mono">${fmtDuration(r.duration_sec)}</td>
            <td style="color:var(--text-soft);font-size:.8rem">${fmtDateOnly(r.created_at)}</td>
            <td><button class="btn-outline" style="padding:.25rem .6rem;font-size:.75rem" onclick="deleteRecord(${r.id}, this)">‚úï</button></td>
          </tr>
        `).join('')}
      </tbody>
    </table>`;
  } catch (e) {
    wrap.innerHTML = '<p class="empty-msg" style="color:var(--red)">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏</p>';
  }
}

async function deleteRecord(id, btn) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏?')) return;
  btn.disabled = true;
  try {
    const r = await fetch(API + '/api/auth/history/' + id, {
      method: 'DELETE',
      headers: { Authorization: 'Bearer ' + token }
    });
    if (r.ok) { toast('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞', 'ok'); loadHistory(); }
    else { const e = await r.json(); toast(e.detail || '–û—à–∏–±–∫–∞', 'err'); btn.disabled = false; }
  } catch (e) { toast('–û—à–∏–±–∫–∞: ' + e.message, 'err'); btn.disabled = false; }
}

document.getElementById('btnChangePass').addEventListener('click', async () => {
  const oldP = document.getElementById('oldPass').value;
  const newP = document.getElementById('newPass').value;
  const newP2 = document.getElementById('newPass2').value;
  const msg = document.getElementById('passMsg');
  msg.style.color = 'var(--red)';
  if (!oldP || !newP || !newP2) { msg.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'; return; }
  if (newP !== newP2) { msg.textContent = '–ù–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç'; return; }
  if (newP.length < 6) { msg.textContent = '–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤'; return; }
  const btn = document.getElementById('btnChangePass');
  btn.disabled = true;
  try {
    const r = await fetch(API + '/api/auth/change-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
      body: JSON.stringify({ old_password: oldP, new_password: newP })
    });
    const d = await r.json();
    if (r.ok) {
      msg.style.color = 'var(--green)';
      msg.textContent = '‚úì –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω';
      document.getElementById('oldPass').value = '';
      document.getElementById('newPass').value = '';
      document.getElementById('newPass2').value = '';
      toast('–ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω', 'ok');
    } else {
      msg.textContent = d.detail || '–û—à–∏–±–∫–∞';
    }
  } catch (e) {
    msg.textContent = '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞';
  }
  btn.disabled = false;
});

// P42: CSV-—ç–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏
document.getElementById('btnExportHistory').addEventListener('click', () => {
  fetch(API + '/api/auth/history/export.csv', { headers: { Authorization: 'Bearer ' + token } })
    .then(r => {
      if (!r.ok) throw new Error('–û—à–∏–±–∫–∞ ' + r.status);
      return r.blob();
    })
    .then(blob => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'mastering_history.csv'; a.click();
      setTimeout(() => URL.revokeObjectURL(url), 2000);
      toast('CSV —Å–∫–∞—á–∞–Ω', 'ok');
    })
    .catch(e => toast('–û—à–∏–±–∫–∞: ' + e.message, 'err'));
});

// ‚îÄ‚îÄ‚îÄ P52: API Keys ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadApiKeys() {
  const wrap = document.getElementById('apiKeysList');
  if (!wrap) return;
  try {
    const d = await fetch(API + '/api/auth/api-keys', { headers: { Authorization: 'Bearer ' + token } });
    if (d.status === 403) { wrap.innerHTML = ''; return; }
    const data = await d.json();
    const keys = data.keys || [];
    if (!keys.length) {
      wrap.innerHTML = '<p style="color:var(--text-soft);font-size:.83rem">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª—é—á–µ–π.</p>';
      return;
    }
    wrap.innerHTML = `<table style="width:100%;border-collapse:collapse;font-size:.8rem">
      <thead><tr>
        <th style="text-align:left;padding:.3rem .5rem;color:var(--text-soft);font-weight:500">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
        <th style="text-align:left;padding:.3rem .5rem;color:var(--text-soft);font-weight:500">–ü—Ä–µ—Ñ–∏–∫—Å</th>
        <th style="text-align:left;padding:.3rem .5rem;color:var(--text-soft);font-weight:500">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</th>
        <th style="text-align:left;padding:.3rem .5rem;color:var(--text-soft);font-weight:500">–°—Ç–∞—Ç—É—Å</th>
        <th></th>
      </tr></thead>
      <tbody>
      ${keys.map(k => `<tr style="border-top:1px solid rgba(255,255,255,.05)">
        <td style="padding:.4rem .5rem">${k.name}</td>
        <td style="padding:.4rem .5rem"><code style="font-size:.75rem;opacity:.7">${k.prefix}</code></td>
        <td style="padding:.4rem .5rem;color:var(--text-soft)">${k.last_used_at ? new Date(k.last_used_at * 1000).toLocaleDateString('ru') : '‚Äî'}</td>
        <td style="padding:.4rem .5rem">${k.is_active ? '<span style="color:#34d399">‚óè</span> –ê–∫—Ç–∏–≤–µ–Ω' : '<span style="color:#f87171">‚óè</span> –û—Ç–æ–∑–≤–∞–Ω'}</td>
        <td style="padding:.4rem .5rem"><button class="btn-outline" style="padding:.2rem .5rem;font-size:.72rem" onclick="revokeKey(${k.id})">–û—Ç–æ–∑–≤–∞—Ç—å</button></td>
      </tr>`).join('')}
      </tbody>
    </table>`;
  } catch (e) { wrap.innerHTML = '<p style="color:#f87171;font-size:.83rem">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>'; }
}

async function revokeKey(id) {
  if (!confirm('–û—Ç–æ–∑–≤–∞—Ç—å –∫–ª—é—á?')) return;
  const r = await fetch(API + '/api/auth/api-keys/' + id, { method: 'DELETE', headers: { Authorization: 'Bearer ' + token } });
  if (r.ok) { toast('–ö–ª—é—á –æ—Ç–æ–∑–≤–∞–Ω', 'ok'); loadApiKeys(); } else { toast('–û—à–∏–±–∫–∞', 'err'); }
}

document.getElementById('btnCreateKey')?.addEventListener('click', () => {
  document.getElementById('createKeyForm').style.display = 'block';
  document.getElementById('newKeyResult').style.display = 'none';
  document.getElementById('newKeyName').focus();
});
document.getElementById('btnCancelKey')?.addEventListener('click', () => {
  document.getElementById('createKeyForm').style.display = 'none';
});
document.getElementById('btnSaveKey')?.addEventListener('click', async () => {
  const name = document.getElementById('newKeyName').value.trim() || 'My API Key';
  const r = await fetch(API + '/api/auth/api-keys', {
    method: 'POST',
    headers: { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' },
    body: JSON.stringify({ name }),
  });
  const data = await r.json();
  if (!r.ok) { toast(data.detail || '–û—à–∏–±–∫–∞', 'err'); return; }
  document.getElementById('createKeyForm').style.display = 'none';
  document.getElementById('newKeyValue').textContent = data.key;
  document.getElementById('newKeyResult').style.display = 'block';
  loadApiKeys();
});
document.getElementById('btnCopyKey')?.addEventListener('click', () => {
  const val = document.getElementById('newKeyValue').textContent;
  navigator.clipboard.writeText(val).then(() => toast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!', 'ok')).catch(() => {});
});

// Init
loadProfile();
loadHistory();
</script>
</body>
</html>
