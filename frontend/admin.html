<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin ‚Äî Magic Master</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#07070f;--surface:#0e0e1a;--surface2:#15151f;--border:#2a2a3a;
  --accent:#7c3aed;--accent2:#a855f7;--green:#22c55e;--red:#ef4444;
  --yellow:#eab308;--text:#e8e8f0;--text-soft:#8888aa;--r:8px;
  --nav-w:220px;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:system-ui,'Segoe UI',sans-serif;font-size:14px}
a{color:inherit;text-decoration:none}

/* Layout */
.layout{display:flex;height:100vh;overflow:hidden}

/* Sidebar */
.nav{width:var(--nav-w);flex-shrink:0;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:1rem 0}
.nav-logo{padding:.5rem 1.2rem 1.2rem;font-size:1rem;font-weight:700;color:var(--accent2)}
.nav-logo small{display:block;font-size:.72rem;color:var(--text-soft);font-weight:400}
.nav-item{display:flex;align-items:center;gap:.6rem;padding:.65rem 1.2rem;cursor:pointer;color:var(--text-soft);border-left:3px solid transparent;transition:.15s}
.nav-item:hover{color:var(--text);background:rgba(124,58,237,.08)}
.nav-item.active{color:var(--accent2);border-left-color:var(--accent);background:rgba(124,58,237,.12)}
.nav-item .icon{width:18px;text-align:center;font-size:1rem}
.nav-bottom{margin-top:auto;padding:.8rem 1.2rem;font-size:.75rem;color:var(--text-soft)}

/* Main */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.topbar{height:50px;flex-shrink:0;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:1rem;padding:0 1.5rem}
.topbar-title{font-weight:600;font-size:.95rem}
.topbar-auth{margin-left:auto;font-size:.8rem;color:var(--text-soft)}
.content{flex:1;overflow-y:auto;padding:1.5rem}

/* Cards */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:1.2rem}
.card-title{font-size:.8rem;text-transform:uppercase;letter-spacing:.05em;color:var(--text-soft);margin-bottom:.8rem}

/* Stats grid */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:1rem;margin-bottom:1.5rem}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:1rem;position:relative;overflow:hidden}
.stat-card .val{font-size:1.8rem;font-weight:700;color:var(--accent2);font-family:var(--mono)}
.stat-card .lbl{font-size:.75rem;color:var(--text-soft);margin-top:.2rem}
.stat-card .delta{font-size:.72rem;margin-top:.4rem}
.delta-up{color:var(--green)}.delta-dn{color:var(--red)}.delta-neu{color:var(--text-dim)}
/* Sparkline SVG */
.sparkline{display:block;margin-top:.6rem;width:100%;height:36px;opacity:.7}
/* Wide analytics cards */
.analytics-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.5rem}
@media(max-width:700px){.analytics-row{grid-template-columns:1fr}}
.analytics-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:1rem}
.analytics-card .card-title{margin-bottom:.6rem}

/* Tables */
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse}
th{text-align:left;padding:.5rem .7rem;background:var(--surface2);font-size:.75rem;text-transform:uppercase;letter-spacing:.04em;color:var(--text-soft);border-bottom:1px solid var(--border)}
td{padding:.5rem .7rem;border-bottom:1px solid rgba(255,255,255,.04);vertical-align:middle}
tr:hover td{background:rgba(255,255,255,.02)}
.badge{display:inline-block;font-size:.7rem;padding:.15rem .5rem;border-radius:4px;font-weight:600}
.badge-pro{background:rgba(168,85,247,.25);color:#c084fc}
.badge-studio{background:rgba(234,179,8,.2);color:#fbbf24}
.badge-free{background:rgba(99,102,241,.15);color:#818cf8}
.badge-blocked{background:rgba(239,68,68,.2);color:#f87171}
.badge-admin{background:rgba(34,197,94,.2);color:#4ade80}
.badge-ok{background:rgba(34,197,94,.2);color:#4ade80}
.badge-fail{background:rgba(239,68,68,.2);color:#f87171}
.badge-pending{background:rgba(234,179,8,.2);color:#fbbf24}
.badge-draft{background:rgba(99,102,241,.15);color:#818cf8}
.badge-sent{background:rgba(34,197,94,.2);color:#4ade80}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:.4rem;padding:.45rem .9rem;border-radius:6px;border:none;cursor:pointer;font-size:.82rem;font-weight:500;transition:.15s}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:var(--accent2)}
.btn-sm{padding:.3rem .6rem;font-size:.75rem}
.btn-danger{background:rgba(239,68,68,.15);color:#f87171;border:1px solid rgba(239,68,68,.3)}
.btn-danger:hover{background:rgba(239,68,68,.3)}
.btn-ghost{background:rgba(255,255,255,.05);color:var(--text-soft);border:1px solid var(--border)}
.btn-ghost:hover{background:rgba(255,255,255,.1);color:var(--text)}
.btn-success{background:rgba(34,197,94,.15);color:#4ade80;border:1px solid rgba(34,197,94,.3)}
.btn-success:hover{background:rgba(34,197,94,.3)}

/* Forms */
.form-row{display:flex;gap:.8rem;flex-wrap:wrap;margin-bottom:.8rem;align-items:flex-end}
.form-group{display:flex;flex-direction:column;gap:.35rem;flex:1;min-width:140px}
.form-group label{font-size:.75rem;color:var(--text-soft)}
input[type=text],input[type=email],input[type=number],input[type=date],input[type=password],select,textarea{
  background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);
  padding:.45rem .7rem;font-size:.85rem;width:100%;outline:none;font-family:inherit
}
input:focus,select:focus,textarea:focus{border-color:var(--accent)}
textarea{resize:vertical;min-height:80px}

/* Search bar */
.search-bar{display:flex;gap:.6rem;margin-bottom:1rem;flex-wrap:wrap}
.search-bar input{flex:1;min-width:180px}

/* Pagination */
.pagination{display:flex;gap:.4rem;align-items:center;margin-top:1rem}
.page-btn{padding:.3rem .7rem;border-radius:5px;border:1px solid var(--border);background:var(--surface2);color:var(--text-soft);cursor:pointer;font-size:.78rem}
.page-btn.active,.page-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}

/* Modal */
.modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;align-items:center;justify-content:center}
.modal-backdrop.open{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:1.5rem;width:90%;max-width:520px;max-height:90vh;overflow-y:auto;position:relative}
.modal-title{font-size:1rem;font-weight:600;margin-bottom:1rem}
.modal-close{position:absolute;top:.8rem;right:.8rem;background:none;border:none;color:var(--text-soft);font-size:1.2rem;cursor:pointer;line-height:1}
.modal-close:hover{color:var(--text)}

/* Toast */
.toasts{position:fixed;bottom:1.5rem;right:1.5rem;z-index:300;display:flex;flex-direction:column;gap:.5rem}
.toast{padding:.6rem 1rem;border-radius:var(--r);font-size:.82rem;animation:slide-in .2s ease;max-width:320px}
.toast-ok{background:#14532d;border:1px solid #166534;color:#bbf7d0}
.toast-err{background:#450a0a;border:1px solid #7f1d1d;color:#fca5a5}
.toast-inf{background:#1e1b4b;border:1px solid #312e81;color:#a5b4fc}
@keyframes slide-in{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:none}}

/* LLM prompts in settings */
.llm-prompts{display:flex;flex-direction:column;gap:1rem}
.llm-prompt-block{border:1px solid var(--border);border-radius:6px;padding:.6rem .8rem;background:rgba(0,0,0,.15)}
.llm-prompt-block strong{font-size:.8rem;display:inline-block;margin-bottom:.35rem}
.llm-prompt-text{font-size:.72rem;line-height:1.4;white-space:pre-wrap;word-break:break-word;margin:0;max-height:120px;overflow-y:auto;color:var(--text-soft)}

/* Login overlay */
.login-overlay{position:fixed;inset:0;background:var(--bg);z-index:400;display:flex;align-items:center;justify-content:center}
.login-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:2rem;width:100%;max-width:360px}
.login-box h2{margin-bottom:1.2rem;font-size:1.1rem;color:var(--accent2)}
.login-box .err{color:#f87171;font-size:.8rem;margin-bottom:.8rem}
.login-box .login-hint{margin-top:1rem;font-size:.75rem;color:var(--text-soft);line-height:1.4}
.login-box .login-hint code{background:rgba(255,255,255,.08);padding:.15rem .35rem;border-radius:4px;font-size:.7rem}

/* Section header */
.section-header{display:flex;align-items:center;gap:.8rem;margin-bottom:1.2rem}
.section-header h2{font-size:1rem;font-weight:600}
.section-header .ml{margin-left:auto}
/* Bulk actions bar (P48) */
.bulk-bar{display:flex;align-items:center;gap:.6rem;padding:.6rem .9rem;background:rgba(108,75,255,.1);border:1px solid rgba(108,75,255,.25);border-radius:var(--r);margin-bottom:.8rem;flex-wrap:wrap;font-size:.8rem;color:var(--accent2);font-weight:600}
.bulk-actions{display:flex;align-items:center;gap:.4rem;flex-wrap:wrap}
.bulk-bar .ml{margin-left:auto}

/* Tabs */
.page{display:none}.page.active{display:block}

/* Rich text preview */
.news-body-preview{font-size:.82rem;color:var(--text-soft);max-height:3.5em;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}

/* Settings tabs */
.settings-tabs{display:flex;gap:.2rem;margin-bottom:1rem;flex-wrap:wrap;border-bottom:1px solid var(--border);padding-bottom:0}
.settings-tab{padding:.5rem 1rem;font-size:.85rem;cursor:pointer;color:var(--text-soft);border-radius:var(--r) var(--r) 0 0;border:1px solid transparent;border-bottom:none;margin-bottom:-1px;background:transparent}
.settings-tab:hover{color:var(--text);background:rgba(255,255,255,.04)}
.settings-tab.active{color:var(--accent2);background:var(--surface);border-color:var(--border)}
.settings-panel{display:none;padding:1rem 0}
.settings-panel.active{display:block}
.settings-form .form-group{margin-bottom:.8rem}
.settings-form label{display:block;font-size:.78rem;color:var(--text-soft);margin-bottom:.25rem}
.settings-form input[type=password].secret::placeholder{color:var(--text-dim)}
.settings-save-bar{margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border)}
.report-select.active{background:rgba(124,58,237,.2);color:var(--accent2);border-color:var(--accent)}
</style>
</head>
<body>

<!-- Login overlay -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <h2>–í—Ö–æ–¥ –≤ –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
    <div class="err" id="loginErr"></div>
    <div class="form-group" style="margin-bottom:.8rem">
      <label>Email</label>
      <input type="email" id="loginEmail" placeholder="admin@example.com">
    </div>
    <div class="form-group" style="margin-bottom:1rem">
      <label>–ü–∞—Ä–æ–ª—å</label>
      <input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <button class="btn btn-primary" style="width:100%" id="loginBtn">–í–æ–π—Ç–∏</button>
    <p class="login-hint">–£—á—ë—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∑–∞–¥–∞—ë—Ç—Å—è –≤ <code>.env</code>: <code>MAGIC_MASTER_ADMIN_EMAIL</code> –∏ <code>MAGIC_MASTER_ADMIN_PASSWORD</code>. –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä.</p>
  </div>
</div>

<!-- Main layout -->
<div class="layout">
  <!-- Sidebar -->
  <nav class="nav">
    <div class="nav-logo">Magic Master <small>Admin Panel</small></div>
    <div class="nav-item active" data-page="dashboard"><span class="icon">üìä</span> Dashboard</div>
    <div class="nav-item" data-page="users"><span class="icon">üë•</span> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
    <div class="nav-item" data-page="transactions"><span class="icon">üí≥</span> –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</div>
    <div class="nav-item" data-page="news"><span class="icon">üì∞</span> –ù–æ–≤–æ—Å—Ç–∏</div>
    <div class="nav-item" data-page="campaigns"><span class="icon">‚úâÔ∏è</span> –†–∞—Å—Å—ã–ª–∫–∏</div>
    <div class="nav-item" data-page="reports"><span class="icon">üìà</span> –û—Ç—á—ë—Ç–Ω–æ—Å—Ç—å</div>
    <div class="nav-item" data-page="audit"><span class="icon">üìã</span> –ñ—É—Ä–Ω–∞–ª</div>
    <div class="nav-item" data-page="settings"><span class="icon">‚öôÔ∏è</span> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    <div class="nav-bottom" id="navBottom"></div>
  </nav>

  <!-- Content -->
  <div class="main">
    <div class="topbar">
      <div class="topbar-title" id="topbarTitle">Dashboard</div>
      <div class="topbar-auth" id="topbarAuth"></div>
    </div>
    <div class="content" id="mainContent">

      <!-- DASHBOARD -->
      <div class="page active" id="page-dashboard">
        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
        <div class="stats-grid" id="statsGrid">
          <div class="stat-card"><div class="val" id="sc-users">‚Äî</div><div class="lbl">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div><div class="delta" id="sc-users-d"></div></div>
          <div class="stat-card"><div class="val" style="color:#a855f7" id="sc-pro">‚Äî</div><div class="lbl">Pro –ø–æ–¥–ø–∏—Å–∫–∏</div></div>
          <div class="stat-card"><div class="val" style="color:#fbbf24" id="sc-studio">‚Äî</div><div class="lbl">Studio –ø–æ–¥–ø–∏—Å–∫–∏</div></div>
          <div class="stat-card"><div class="val" style="color:#34d399" id="sc-subs">‚Äî</div><div class="lbl">–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫</div></div>
          <div class="stat-card"><div class="val" style="color:#f87171" id="sc-blocked">‚Äî</div><div class="lbl">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</div></div>
          <div class="stat-card"><div class="val" id="sc-masters-today">‚Äî</div><div class="lbl">–ú–∞—Å—Ç–µ—Ä–∏–Ω–≥–æ–≤ —Å–µ–≥–æ–¥–Ω—è</div><div class="delta" id="sc-masters-d"></div></div>
          <div class="stat-card"><div class="val" style="color:#34d399" id="sc-rev-month">‚Äî</div><div class="lbl">–í—ã—Ä—É—á–∫–∞ –∑–∞ 30 –¥–Ω, ‚ÇΩ</div></div>
          <div class="stat-card"><div class="val" id="sc-rev-total">‚Äî</div><div class="lbl">–í—ã—Ä—É—á–∫–∞ –≤—Å–µ–≥–æ, ‚ÇΩ</div></div>
        </div>
        <!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞: sparklines -->
        <div class="analytics-row">
          <div class="analytics-card">
            <div class="card-title">–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ‚Äî 7 –¥–Ω–µ–π</div>
            <svg class="sparkline" id="sparkUsers" viewBox="0 0 200 36" preserveAspectRatio="none"></svg>
            <div id="sparkUsersLabels" style="display:flex;justify-content:space-between;font-size:.65rem;color:var(--text-dim);margin-top:2px"></div>
          </div>
          <div class="analytics-card">
            <div class="card-title">–ú–∞—Å—Ç–µ—Ä–∏–Ω–≥–∏ ‚Äî 7 –¥–Ω–µ–π</div>
            <svg class="sparkline" id="sparkMasters" viewBox="0 0 200 36" preserveAspectRatio="none"></svg>
            <div id="sparkMastersLabels" style="display:flex;justify-content:space-between;font-size:.65rem;color:var(--text-dim);margin-top:2px"></div>
          </div>
        </div>
        <div class="analytics-row">
          <div class="analytics-card">
            <div class="card-title">–í—ã—Ä—É—á–∫–∞ (‚ÇΩ) ‚Äî 7 –¥–Ω–µ–π</div>
            <svg class="sparkline" id="sparkRevenue" viewBox="0 0 200 36" preserveAspectRatio="none"></svg>
            <div id="sparkRevenueLabels" style="display:flex;justify-content:space-between;font-size:.65rem;color:var(--text-dim);margin-top:2px"></div>
          </div>
          <div class="analytics-card">
            <div class="card-title">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤</div>
            <div id="tierBar" style="margin-top:.5rem"></div>
          </div>
        </div>
      </div>

      <!-- USERS -->
      <div class="page" id="page-users">
        <div class="section-header">
          <h2>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
          <button class="btn btn-sm ml" id="btnExportUsers" title="–°–∫–∞—á–∞—Ç—å CSV">‚¨á CSV</button>
          <div style="display:flex;gap:.5rem">
            <select id="usersFilterTier" style="width:120px">
              <option value="">–í—Å–µ —Ç–∞—Ä–∏—Ñ—ã</option>
              <option value="free">Free</option>
              <option value="pro">Pro</option>
              <option value="studio">Studio</option>
            </select>
            <select id="usersFilterBlocked" style="width:130px">
              <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
              <option value="false">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
              <option value="true">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
            </select>
          </div>
        </div>
        <div class="search-bar">
          <input type="text" id="usersSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ email‚Ä¶">
          <button class="btn btn-ghost" id="usersSearchBtn">–ù–∞–π—Ç–∏</button>
        </div>

        <!-- Bulk action bar (P48) ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ -->
        <div class="bulk-bar" id="bulkBar" style="display:none">
          <span id="bulkCount">0 –≤—ã–±—Ä–∞–Ω–æ</span>
          <div class="bulk-actions">
            <button class="btn btn-sm btn-ghost" id="bulkBlock">üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="btn btn-sm btn-ghost" id="bulkUnblock">üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
            <select id="bulkTierSel" style="width:100px;font-size:.78rem">
              <option value="">‚Äî –¢–∞—Ä–∏—Ñ ‚Äî</option>
              <option value="free">Free</option>
              <option value="pro">Pro</option>
              <option value="studio">Studio</option>
            </select>
            <button class="btn btn-sm btn-ghost" id="bulkSetTier">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–∞—Ä–∏—Ñ</button>
            <button class="btn btn-sm" style="background:rgba(248,113,113,.18);color:#fca5a5;border-color:rgba(248,113,113,.3)" id="bulkDelete">üóë –£–¥–∞–ª–∏—Ç—å</button>
          </div>
          <button class="btn btn-ghost btn-sm ml" id="bulkClear">‚úï –°–Ω—è—Ç—å –≤—ã–±–æ—Ä</button>
        </div>

        <div class="card" style="padding:0">
          <div class="table-wrap">
            <table id="usersTable">
              <thead><tr>
                <th style="width:32px"><input type="checkbox" id="chkAll" title="–í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö"></th>
                <th>ID</th><th>Email</th><th>–¢–∞—Ä–∏—Ñ</th><th>–°—Ç–∞—Ç—É—Å</th>
                <th>–ü–æ–¥–ø–∏—Å–∫–∞ –¥–æ</th><th>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</th><th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr></thead>
              <tbody id="usersBody"></tbody>
            </table>
          </div>
          <div class="pagination" id="usersPagination" style="padding:.8rem 1rem"></div>
        </div>
      </div>

      <!-- TRANSACTIONS -->
      <div class="page" id="page-transactions">
        <div class="section-header">
          <h2>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h2>
          <div class="ml" style="display:flex;gap:.5rem">
            <button class="btn btn-sm" id="btnExportTx" title="–°–∫–∞—á–∞—Ç—å CSV">‚¨á CSV</button>
            <button class="btn btn-primary" id="btnAddTx">+ –î–æ–±–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é</button>
          </div>
        </div>
        <div class="search-bar">
          <input type="number" id="txFilterUser" placeholder="User ID" style="max-width:120px">
          <select id="txFilterStatus" style="width:140px">
            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
            <option value="succeeded">–£—Å–ø–µ—à–Ω—ã–µ</option>
            <option value="pending">–û–∂–∏–¥–∞—é—â–∏–µ</option>
            <option value="failed">–û—à–∏–±–∫–∞</option>
            <option value="refunded">–í–æ–∑–≤—Ä–∞—Ç</option>
          </select>
          <button class="btn btn-ghost" id="txSearchBtn">–ù–∞–π—Ç–∏</button>
        </div>
        <div class="card" style="padding:0">
          <div class="table-wrap">
            <table id="txTable">
              <thead><tr>
                <th>ID</th><th>User ID</th><th>–°—É–º–º–∞</th><th>–¢–∞—Ä–∏—Ñ</th>
                <th>–°–∏—Å—Ç–µ–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–î–∞—Ç–∞</th>
              </tr></thead>
              <tbody id="txBody"></tbody>
            </table>
          </div>
          <div class="pagination" id="txPagination" style="padding:.8rem 1rem"></div>
        </div>
      </div>

      <!-- NEWS -->
      <div class="page" id="page-news">
        <div class="section-header">
          <h2>–ù–æ–≤–æ—Å—Ç–∏ –∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h2>
          <button class="btn btn-primary ml" id="btnNewPost">+ –ù–æ–≤—ã–π –ø–æ—Å—Ç</button>
        </div>
        <div id="newsListWrap"></div>
        <div class="pagination" id="newsPagination" style="padding:.8rem 1rem;margin-top:.5rem"></div>
      </div>

      <!-- CAMPAIGNS -->
      <div class="page" id="page-campaigns">
        <div class="section-header">
          <h2>Email-—Ä–∞—Å—Å—ã–ª–∫–∏</h2>
          <button class="btn btn-primary ml" id="btnNewCampaign">+ –ù–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞</button>
        </div>
        <div id="campaignsListWrap"></div>
        <div class="pagination" id="campaignsPagination" style="padding:.8rem 1rem;margin-top:.5rem"></div>
      </div>

      <!-- ‚îÄ‚îÄ Reports ‚îÄ‚îÄ -->
      <div class="page" id="page-reports">
        <div class="section-header">
          <h2>–û—Ç—á—ë—Ç–Ω–æ—Å—Ç—å</h2>
        </div>
        <p style="font-size:.8rem;color:var(--text-soft);margin-bottom:1rem">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç—á—ë—Ç, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —É–∫–∞–∂–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å¬ª. –î–ª—è –æ—Ç—á—ë—Ç–∞ ¬´–≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏¬ª –¥–æ—Å—Ç—É–ø–Ω–∞ –≤—ã–≥—Ä—É–∑–∫–∞ CSV.</p>
        <div class="form-row" style="margin-bottom:1rem;flex-wrap:wrap;gap:.6rem">
          <div class="form-group" style="min-width:120px">
            <label>–î–∞—Ç–∞ –æ—Ç</label>
            <input type="date" id="reportDateFrom">
          </div>
          <div class="form-group" style="min-width:120px">
            <label>–î–∞—Ç–∞ –¥–æ</label>
            <input type="date" id="reportDateTo">
          </div>
          <button type="button" class="btn btn-primary btn-sm" id="reportRunBtn" style="align-self:flex-end">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <div id="reportSelectWrap" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:.6rem;margin-bottom:1rem"></div>
        <div id="reportResultWrap" style="display:none">
          <div class="card" style="margin-bottom:.8rem">
            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.5rem;margin-bottom:.6rem">
              <strong id="reportResultTitle"></strong>
              <div style="display:flex;gap:.4rem">
                <button type="button" class="btn btn-sm btn-ghost" id="reportSummarizeBtn">–†–µ–∑—é–º–µ LLM</button>
                <button type="button" class="btn btn-sm btn-ghost" id="reportCsvBtn" style="display:none">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
              </div>
            </div>
            <div id="reportSummary" style="display:none;padding:.6rem;background:var(--surface2);border-radius:6px;margin-bottom:.6rem;font-size:.85rem"></div>
            <div class="table-wrap">
              <table id="reportTable"><tbody></tbody></table>
            </div>
            <p id="reportEmpty" style="display:none;color:var(--text-soft);font-size:.9rem">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.</p>
          </div>
        </div>
      </div>

      <!-- –ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π (Audit) -->
      <div class="page" id="page-audit">
        <div class="section-header">
          <h2>–ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π</h2>
        </div>
        <p style="font-size:.8rem;color:var(--text-soft);margin-bottom:1rem">–î–µ–π—Å—Ç–≤–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –ø—Ä–æ–º–ø—Ç—ã.</p>
        <div class="form-row" style="margin-bottom:1rem;flex-wrap:wrap;gap:.6rem">
          <div class="form-group" style="min-width:140px">
            <label>–î–µ–π—Å—Ç–≤–∏–µ</label>
            <input type="text" id="auditFilterAction" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä settings_update">
          </div>
          <div class="form-group" style="min-width:120px">
            <label>–î–∞—Ç–∞ –æ—Ç</label>
            <input type="date" id="auditDateFrom">
          </div>
          <div class="form-group" style="min-width:120px">
            <label>–î–∞—Ç–∞ –¥–æ</label>
            <input type="date" id="auditDateTo">
          </div>
          <button type="button" class="btn btn-primary btn-sm" id="auditFilterBtn" style="align-self:flex-end">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
        <div class="card" style="padding:0">
          <div class="table-wrap">
            <table id="auditTable">
              <thead><tr>
                <th>–î–∞—Ç–∞</th><th>–ê–¥–º–∏–Ω</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th><th>–¢–∏–ø</th><th>ID</th><th>–î–µ—Ç–∞–ª–∏</th><th>IP</th>
              </tr></thead>
              <tbody id="auditBody"></tbody>
            </table>
          </div>
          <div class="pagination" id="auditPagination" style="padding:.8rem 1rem"></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Settings (P29) ‚îÄ‚îÄ -->
      <div class="page" id="page-settings">
        <div class="section-header">
          <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–∏—Å–∞</h2>
          <div class="ml" style="display:flex;gap:.5rem">
            <button class="btn btn-sm" id="btnBackupDb" title="–°–∫–∞—á–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ë–î">‚¨á Backup DB</button>
            <button class="btn btn-sm" id="btnRefreshSettings" onclick="loadSettings()">‚Üª –û–±–Ω–æ–≤–∏—Ç—å</button>
          </div>
        </div>
        <p style="font-size:.8rem;color:var(--text-soft);margin-bottom:1rem">–ò–∑–º–µ–Ω—è–µ–º—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î –∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ (–∫—Ä–æ–º–µ CORS –∏ —á–∞—Å—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤).</p>
        <div id="settingsWrap">
          <p style="color:var(--text-soft)">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</p>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Toast container -->
<div class="toasts" id="toasts"></div>

<!-- ‚ïê‚ïê MODALS ‚ïê‚ïê -->

<!-- Prompt edit modal -->
<div class="modal-backdrop" id="modalPromptEdit">
  <div class="modal" style="max-width:640px">
    <button class="modal-close" onclick="closeModal('modalPromptEdit')">√ó</button>
    <div class="modal-title" id="modalPromptEditTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç</div>
    <input type="hidden" id="modalPromptEditSlug">
    <div class="form-group" style="margin-bottom:1rem">
      <label>–¢–µ–∫—Å—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞</label>
      <textarea id="modalPromptEditBody" rows="12" style="width:100%;min-height:200px;resize:vertical"></textarea>
    </div>
    <div style="display:flex;gap:.5rem;justify-content:flex-end">
      <button type="button" class="btn btn-ghost" onclick="closeModal('modalPromptEdit')">–û—Ç–º–µ–Ω–∞</button>
      <button type="button" class="btn btn-primary" id="modalPromptEditSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é</button>
    </div>
  </div>
</div>
<!-- Prompt history modal -->
<div class="modal-backdrop" id="modalPromptHistory">
  <div class="modal" style="max-width:520px">
    <button class="modal-close" onclick="closeModal('modalPromptHistory')">√ó</button>
    <div class="modal-title" id="modalPromptHistoryTitle">–ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π</div>
    <input type="hidden" id="modalPromptHistorySlug">
    <div id="modalPromptHistoryList" style="max-height:320px;overflow-y:auto"></div>
  </div>
</div>

<!-- Edit user modal -->
<div class="modal-backdrop" id="modalUser">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('modalUser')">√ó</button>
    <div class="modal-title" id="modalUserTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
    <input type="hidden" id="editUserId">
    <div class="form-row">
      <div class="form-group">
        <label>–¢–∞—Ä–∏—Ñ</label>
        <select id="editUserTier">
          <option value="free">Free</option>
          <option value="pro">Pro</option>
          <option value="studio">Studio</option>
        </select>
      </div>
      <div class="form-group">
        <label>–°—Ç–∞—Ç—É—Å</label>
        <select id="editUserBlocked">
          <option value="false">–ê–∫—Ç–∏–≤–µ–Ω</option>
          <option value="true">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>–ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label>
        <select id="editUserAdmin">
          <option value="false">–û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
          <option value="true">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
        </select>
      </div>
    </div>
    <div style="margin-top:.5rem;margin-bottom:1rem;padding:.7rem;background:var(--surface2);border-radius:6px;font-size:.8rem;color:var(--text-soft)">
      <strong style="color:var(--text)">–ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</strong>
      <div class="form-row" style="margin-top:.5rem;margin-bottom:0">
        <div class="form-group">
          <label>–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ (–¥–∞—Ç–∞)</label>
          <input type="date" id="editSubExpires">
        </div>
        <div class="form-group">
          <label>–°—É–º–º–∞ (‚ÇΩ)</label>
          <input type="number" id="editSubAmount" value="0" min="0">
        </div>
      </div>
    </div>
    <div style="display:flex;gap:.6rem;justify-content:flex-end">
      <button class="btn btn-danger btn-sm" id="editUserDelete">–£–¥–∞–ª–∏—Ç—å</button>
      <button class="btn btn-ghost" onclick="closeModal('modalUser')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" id="editUserSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Add transaction modal -->
<div class="modal-backdrop" id="modalTx">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('modalTx')">√ó</button>
    <div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</div>
    <div class="form-row">
      <div class="form-group">
        <label>User ID</label>
        <input type="number" id="newTxUserId" placeholder="123">
      </div>
      <div class="form-group">
        <label>–¢–∞—Ä–∏—Ñ</label>
        <select id="newTxTier">
          <option value="pro">Pro</option>
          <option value="studio">Studio</option>
          <option value="free">Free</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>–°—É–º–º–∞</label>
        <input type="number" id="newTxAmount" value="0" min="0" step="0.01">
      </div>
      <div class="form-group">
        <label>–í–∞–ª—é—Ç–∞</label>
        <input type="text" id="newTxCurrency" value="RUB" maxlength="4">
      </div>
    </div>
    <div class="form-group" style="margin-bottom:.8rem">
      <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
      <input type="text" id="newTxDesc" placeholder="–†—É—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏">
    </div>
    <div style="display:flex;gap:.6rem;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeModal('modalTx')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" id="saveTxBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- News editor modal -->
<div class="modal-backdrop" id="modalNews">
  <div class="modal" style="max-width:640px">
    <button class="modal-close" onclick="closeModal('modalNews')">√ó</button>
    <div class="modal-title" id="modalNewsTitle">–ù–æ–≤—ã–π –ø–æ—Å—Ç</div>
    <input type="hidden" id="editPostId">
    <div class="form-group" style="margin-bottom:.8rem">
      <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
      <input type="text" id="editPostTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–æ–≤–æ—Å—Ç–∏‚Ä¶">
    </div>
    <div class="form-group" style="margin-bottom:.8rem">
      <label>–¢–µ–∫—Å—Ç (Markdown / HTML)</label>
      <textarea id="editPostBody" rows="8" placeholder="–¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏‚Ä¶"></textarea>
    </div>
    <div class="form-row" style="align-items:center;margin-bottom:0">
      <label style="display:flex;align-items:center;gap:.4rem;cursor:pointer;color:var(--text-soft);font-size:.85rem">
        <input type="checkbox" id="editPostPublished"> –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å—Ä–∞–∑—É
      </label>
      <div class="ml" style="display:flex;gap:.6rem">
        <button class="btn btn-ghost" onclick="closeModal('modalNews')">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-primary" id="savePostBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- Campaign editor modal -->
<div class="modal-backdrop" id="modalCampaign">
  <div class="modal" style="max-width:640px">
    <button class="modal-close" onclick="closeModal('modalCampaign')">√ó</button>
    <div class="modal-title">–ù–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞</div>
    <div class="form-group" style="margin-bottom:.8rem">
      <label>–¢–µ–º–∞ –ø–∏—Å—å–º–∞</label>
      <input type="text" id="campSubject" placeholder="–¢–µ–º–∞‚Ä¶">
    </div>
    <div class="form-group" style="margin-bottom:.8rem">
      <label>–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è</label>
      <select id="campTier">
        <option value="">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
        <option value="free">Free</option>
        <option value="pro">Pro</option>
        <option value="studio">Studio</option>
      </select>
    </div>
    <div class="form-group" style="margin-bottom:.8rem">
      <label>HTML-—Ç–µ–∫—Å—Ç –ø–∏—Å—å–º–∞</label>
      <textarea id="campBodyHtml" rows="7" placeholder="&lt;p&gt;–¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞&lt;/p&gt;"></textarea>
    </div>
    <div class="form-group" style="margin-bottom:1rem">
      <label>–¢–µ–∫—Å—Ç–æ–≤–∞—è –≤–µ—Ä—Å–∏—è (plain text, –¥–ª—è –ø–æ—á—Ç–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –±–µ–∑ HTML)</label>
      <textarea id="campBodyText" rows="3" placeholder="–¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞ –±–µ–∑ —Ä–∞–∑–º–µ—Ç–∫–∏‚Ä¶"></textarea>
    </div>
    <div style="display:flex;gap:.6rem;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="closeModal('modalCampaign')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" id="saveCampBtn">–°–æ–∑–¥–∞—Ç—å (—á–µ—Ä–Ω–æ–≤–∏–∫)</button>
    </div>
  </div>
</div>

<script>
const API = '';
let _token = localStorage.getItem('admin_token') || '';
let _adminEmail = '';
let _usersPage = 0;
const USERS_LIMIT = 30;

// ‚îÄ‚îÄ‚îÄ Auth helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function authH() {
  return _token ? { 'Authorization': 'Bearer ' + _token } : {};
}

async function apiFetch(url, opts = {}) {
  const r = await fetch(API + url, {
    ...opts,
    headers: { 'Content-Type': 'application/json', ...authH(), ...(opts.headers || {}) },
  });
  const data = await r.json().catch(() => ({}));
  if (!r.ok) throw new Error(data.detail || r.statusText);
  return data;
}

// ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toast(msg, type = 'inf', ms = 3000) {
  const el = document.createElement('div');
  el.className = `toast toast-${type}`;
  el.textContent = msg;
  document.getElementById('toasts').appendChild(el);
  setTimeout(() => el.remove(), ms);
}

// ‚îÄ‚îÄ‚îÄ Modal helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// ‚îÄ‚îÄ‚îÄ Format helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmtDate(ts) {
  if (!ts) return '‚Äî';
  return new Date(ts * 1000).toLocaleString('ru-RU', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
}
function fmtDateOnly(ts) {
  if (!ts) return '‚Äî';
  return new Date(ts * 1000).toLocaleDateString('ru-RU');
}
function tierBadge(t) {
  const cls = { pro: 'badge-pro', studio: 'badge-studio', free: 'badge-free' }[t] || 'badge-free';
  return `<span class="badge ${cls}">${t || 'free'}</span>`;
}
function statusBadge(s) {
  const cls = { succeeded: 'badge-ok', pending: 'badge-pending', failed: 'badge-fail', refunded: 'badge-pending' }[s] || '';
  return `<span class="badge ${cls}">${s}</span>`;
}

// ‚îÄ‚îÄ‚îÄ Login ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function checkAuth() {
  if (!_token) { showLogin(); return; }
  try {
    const me = await apiFetch('/api/auth/me');
    if (!me.is_admin) { _token = ''; localStorage.removeItem('admin_token'); showLogin(); return; }
    _adminEmail = me.email;
    document.getElementById('loginOverlay').style.display = 'none';
    document.getElementById('topbarAuth').textContent = me.email;
    document.getElementById('navBottom').textContent = me.email;
    loadPage('dashboard');
  } catch {
    _token = ''; localStorage.removeItem('admin_token'); showLogin();
  }
}

function showLogin() { document.getElementById('loginOverlay').style.display = 'flex'; }

document.getElementById('loginBtn').addEventListener('click', async () => {
  const email = document.getElementById('loginEmail').value.trim().toLowerCase();
  const pass = document.getElementById('loginPass').value;
  document.getElementById('loginErr').textContent = '';
  try {
    const data = await apiFetch('/api/auth/login', {
      method: 'POST',
      body: JSON.stringify({ email, password: pass }),
    });
    if (!data.is_admin) throw new Error('–≠—Ç–∞ —É—á—ë—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º');
    _token = data.access_token;
    localStorage.setItem('admin_token', _token);
    await checkAuth();
  } catch (e) {
    document.getElementById('loginErr').textContent = e.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
  }
});

document.getElementById('loginPass').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('loginBtn').click(); });

// ‚îÄ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const pageNames = { dashboard: 'Dashboard', users: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏', transactions: '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏', news: '–ù–æ–≤–æ—Å—Ç–∏', campaigns: '–†–∞—Å—Å—ã–ª–∫–∏', reports: '–û—Ç—á—ë—Ç–Ω–æ—Å—Ç—å', audit: '–ñ—É—Ä–Ω–∞–ª', settings: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏' };

document.querySelectorAll('.nav-item[data-page]').forEach(el => {
  el.addEventListener('click', () => loadPage(el.dataset.page));
});

function loadPage(name) {
  document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.page === name));
  document.querySelectorAll('.page').forEach(p => p.classList.toggle('active', p.id === 'page-' + name));
  document.getElementById('topbarTitle').textContent = pageNames[name] || name;
  if (name === 'dashboard') loadDashboard();
  if (name === 'users') loadUsers();
  if (name === 'transactions') loadTransactions();
  if (name === 'news') loadNews();
  if (name === 'campaigns') loadCampaigns();
  if (name === 'reports') loadReports();
  if (name === 'audit') loadAudit();
  if (name === 'settings') loadSettings();
}

// ‚îÄ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// –†–∏—Å—É–µ—Ç SVG-—Å–ø–∞—Ä–∫–ª–∞–π–Ω –∏–∑ –º–∞—Å—Å–∏–≤–∞ —á–∏—Å–µ–ª
function drawSparkline(svgId, values, color = '#6c4bff') {
  const svg = document.getElementById(svgId);
  if (!svg) return;
  const W = 200, H = 36, pad = 3;
  const max = Math.max(...values, 1);
  const pts = values.map((v, i) => {
    const x = pad + (i / Math.max(values.length - 1, 1)) * (W - pad * 2);
    const y = H - pad - (v / max) * (H - pad * 2);
    return `${x.toFixed(1)},${y.toFixed(1)}`;
  });
  // Filled area –ø–æ–¥ –ª–∏–Ω–∏–µ–π
  const area = `${pad},${H - pad} ` + pts.join(' ') + ` ${W - pad},${H - pad}`;
  svg.innerHTML = `
    <defs>
      <linearGradient id="sg_${svgId}" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="${color}" stop-opacity=".35"/>
        <stop offset="100%" stop-color="${color}" stop-opacity="0"/>
      </linearGradient>
    </defs>
    <polygon points="${area}" fill="url(#sg_${svgId})"/>
    <polyline points="${pts.join(' ')}" fill="none" stroke="${color}" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
    ${pts.map((p, i) => i === values.length - 1
      ? `<circle cx="${p.split(',')[0]}" cy="${p.split(',')[1]}" r="2.5" fill="${color}"/>`
      : ''
    ).join('')}
  `;
}

function drawTierBar(tiers, total) {
  const el = document.getElementById('tierBar');
  if (!el) return;
  const items = [
    { key: 'studio', label: 'Studio', color: '#fbbf24' },
    { key: 'pro',    label: 'Pro',    color: '#a855f7' },
    { key: 'free',   label: 'Free',   color: '#52527a' },
  ];
  const barHtml = items.map(it => {
    const cnt = tiers[it.key] || 0;
    const pct = total > 0 ? (cnt / total * 100).toFixed(1) : 0;
    return `<div style="margin-bottom:.5rem">
      <div style="display:flex;justify-content:space-between;font-size:.75rem;color:var(--text-soft);margin-bottom:2px">
        <span style="color:${it.color};font-weight:600">${it.label}</span>
        <span>${cnt} &nbsp;(${pct}%)</span>
      </div>
      <div style="height:6px;border-radius:3px;background:rgba(255,255,255,.07);overflow:hidden">
        <div style="height:100%;width:${pct}%;background:${it.color};border-radius:3px;transition:width .5s"></div>
      </div>
    </div>`;
  }).join('');
  el.innerHTML = barHtml;
}

async function loadDashboard() {
  try {
    const s = await apiFetch('/api/admin/stats');
    const tiers = s.users.by_tier || {};
    const m = s.masterings || {};
    const r = s.revenue || {};
    const u = s.users || {};

    // –û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
    const setText = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
    setText('sc-users',        u.total ?? '‚Äî');
    setText('sc-pro',          tiers.pro || 0);
    setText('sc-studio',       tiers.studio || 0);
    setText('sc-subs',         u.active_subscriptions ?? '‚Äî');
    setText('sc-blocked',      u.blocked ?? 0);
    setText('sc-masters-today', m.today ?? '‚Äî');
    setText('sc-rev-month',    r.month_rub != null ? r.month_rub.toLocaleString('ru') : '‚Äî');
    setText('sc-rev-total',    r.total_rub != null ? r.total_rub.toLocaleString('ru') : '‚Äî');

    // –ü–æ–¥–ø–∏—Å–∏ ¬´+N –∑–∞ –Ω–µ–¥–µ–ª—é¬ª
    if (u.new_week != null) {
      const el = document.getElementById('sc-users-d');
      if (el) { el.textContent = `+${u.new_week} –∑–∞ 7 –¥–Ω–µ–π`; el.className = 'delta delta-up'; }
    }
    if (m.month != null) {
      const el = document.getElementById('sc-masters-d');
      if (el) { el.textContent = `${m.month} –∑–∞ 30 –¥–Ω–µ–π`; el.className = 'delta delta-neu'; }
    }

    // Sparklines
    const uDays = (u.by_day || []).map(d => d.count);
    const mDays = (m.by_day || []).map(d => d.count);
    const rDays = (r.by_day || []).map(d => d.amount);
    drawSparkline('sparkUsers',   uDays, '#6c4bff');
    drawSparkline('sparkMasters', mDays, '#34d399');
    drawSparkline('sparkRevenue', rDays, '#fbbf24');

    // –ú–µ—Ç–∫–∏ –¥–∞—Ç –ø–æ–¥ —Å–ø–∞—Ä–∫–ª–∞–π–Ω–∞–º–∏
    const labels = (u.by_day || []).map(d => {
      const dt = new Date(d.date);
      return `${dt.getDate()}.${String(dt.getMonth()+1).padStart(2,'0')}`;
    });
    ['sparkUsersLabels','sparkMastersLabels','sparkRevenueLabels'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.innerHTML = labels.map(l => `<span>${l}</span>`).join('');
    });

    // Tier bar
    drawTierBar(tiers, u.total || 0);

  } catch (e) { toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + e.message, 'err'); }
}

// ‚îÄ‚îÄ‚îÄ Users ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _usersTotal = 0;
let _selectedUsers = new Set(); // P48: –≤—ã–±—Ä–∞–Ω–Ω—ã–µ user_id

function updateBulkBar() {
  const bar = document.getElementById('bulkBar');
  const cnt = document.getElementById('bulkCount');
  if (_selectedUsers.size > 0) {
    bar.style.display = 'flex';
    cnt.textContent = _selectedUsers.size + ' –≤—ã–±—Ä–∞–Ω–æ';
  } else {
    bar.style.display = 'none';
  }
}

async function loadUsers(page = 0) {
  _usersPage = page;
  const search = document.getElementById('usersSearch').value.trim();
  const tier = document.getElementById('usersFilterTier').value;
  const blocked = document.getElementById('usersFilterBlocked').value;
  const params = new URLSearchParams({ limit: USERS_LIMIT, offset: page * USERS_LIMIT });
  if (search) params.set('search', search);
  if (tier) params.set('tier', tier);
  if (blocked !== '') params.set('blocked', blocked);
  try {
    const d = await apiFetch('/api/admin/users?' + params);
    _usersTotal = d.total;
    const tbody = document.getElementById('usersBody');
    tbody.innerHTML = d.users.map(u => `
      <tr data-uid="${u.id}">
        <td><input type="checkbox" class="user-chk" data-id="${u.id}" ${_selectedUsers.has(u.id) ? 'checked' : ''}></td>
        <td>${u.id}</td>
        <td>${u.email}${u.is_admin ? ' <span class="badge badge-admin">admin</span>' : ''}${!u.is_verified ? ' <span class="badge" style="background:rgba(251,191,36,.15);color:#fbbf24">unverified</span>' : ''}</td>
        <td>${tierBadge(u.tier)}</td>
        <td>${u.is_blocked ? '<span class="badge badge-blocked">blocked</span>' : '<span class="badge badge-ok">active</span>'}</td>
        <td>${u.subscription_expires_at ? fmtDateOnly(u.subscription_expires_at) : '‚Äî'}</td>
        <td>${fmtDateOnly(u.created_at)}</td>
        <td><button class="btn btn-ghost btn-sm" onclick="openEditUser(${u.id})">–ò–∑–º–µ–Ω–∏—Ç—å</button></td>
      </tr>
    `).join('');

    // –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —á–µ–∫–±–æ–∫—Å–æ–≤
    tbody.querySelectorAll('.user-chk').forEach(chk => {
      chk.addEventListener('change', () => {
        const id = parseInt(chk.dataset.id);
        if (chk.checked) _selectedUsers.add(id); else _selectedUsers.delete(id);
        updateBulkBar();
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º "–≤—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö"
        const allChks = tbody.querySelectorAll('.user-chk');
        document.getElementById('chkAll').checked = allChks.length > 0 && [...allChks].every(c => c.checked);
      });
    });

    updateBulkBar();
    renderUsersPagination();
  } catch (e) { toast('–û—à–∏–±–∫–∞: ' + e.message, 'err'); }
}

function renderUsersPagination() {
  const pages = Math.ceil(_usersTotal / USERS_LIMIT);
  const wrap = document.getElementById('usersPagination');
  if (pages <= 1) { wrap.innerHTML = ''; return; }
  let html = `<span style="font-size:.8rem;color:var(--text-soft)">–í—Å–µ–≥–æ: ${_usersTotal}</span>`;
  for (let i = 0; i < pages; i++) {
    html += `<button class="page-btn${i === _usersPage ? ' active' : ''}" onclick="loadUsers(${i})">${i + 1}</button>`;
  }
  wrap.innerHTML = html;
}

// –í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö –Ω–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
document.getElementById('chkAll').addEventListener('change', function() {
  document.querySelectorAll('.user-chk').forEach(chk => {
    chk.checked = this.checked;
    const id = parseInt(chk.dataset.id);
    if (this.checked) _selectedUsers.add(id); else _selectedUsers.delete(id);
  });
  updateBulkBar();
});

// Bulk action ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç—å
async function execBulkAction(action, tier = null) {
  if (_selectedUsers.size === 0) return;
  const label = { block: '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å', unblock: '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å', delete: '–£–î–ê–õ–ò–¢–¨', set_tier: '–∏–∑–º–µ–Ω–∏—Ç—å —Ç–∞—Ä–∏—Ñ' }[action] || action;
  if (!confirm(`${label.toUpperCase()} ${_selectedUsers.size} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?`)) return;
  try {
    const body = { user_ids: [..._selectedUsers], action };
    if (tier) body.tier = tier;
    const res = await apiFetch('/api/admin/users/bulk-action', { method: 'POST', body: JSON.stringify(body) });
    toast(`–ì–æ—Ç–æ–≤–æ: –∑–∞—Ç—Ä–æ–Ω—É—Ç–æ ${res.affected}, –ø—Ä–æ–ø—É—â–µ–Ω–æ ${res.skipped}`, 'ok');
    _selectedUsers.clear();
    updateBulkBar();
    document.getElementById('chkAll').checked = false;
    loadUsers(_usersPage);
  } catch (e) { toast('–û—à–∏–±–∫–∞: ' + e.message, 'err'); }
}

document.getElementById('bulkBlock').addEventListener('click', () => execBulkAction('block'));
document.getElementById('bulkUnblock').addEventListener('click', () => execBulkAction('unblock'));
document.getElementById('bulkSetTier').addEventListener('click', () => {
  const t = document.getElementById('bulkTierSel').value;
  if (!t) { toast('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ', 'err'); return; }
  execBulkAction('set_tier', t);
});
document.getElementById('bulkDelete').addEventListener('click', () => execBulkAction('delete'));
document.getElementById('bulkClear').addEventListener('click', () => {
  _selectedUsers.clear();
  document.querySelectorAll('.user-chk').forEach(c => c.checked = false);
  document.getElementById('chkAll').checked = false;
  updateBulkBar();
});

document.getElementById('usersSearchBtn').addEventListener('click', () => loadUsers(0));
document.getElementById('usersSearch').addEventListener('keydown', e => { if (e.key === 'Enter') loadUsers(0); });
document.getElementById('usersFilterTier').addEventListener('change', () => loadUsers(0));
document.getElementById('usersFilterBlocked').addEventListener('change', () => loadUsers(0));

let _editingUser = null;
async function openEditUser(userId) {
  try {
    const u = await apiFetch(`/api/admin/users/${userId}`);
    _editingUser = u;
    document.getElementById('editUserId').value = u.id;
    document.getElementById('modalUserTitle').textContent = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #${u.id} ‚Äî ${u.email}`;
    document.getElementById('editUserTier').value = u.tier || 'free';
    document.getElementById('editUserBlocked').value = u.is_blocked ? 'true' : 'false';
    document.getElementById('editUserAdmin').value = u.is_admin ? 'true' : 'false';
    document.getElementById('editSubAmount').value = 0;
    document.getElementById('editSubExpires').value = u.subscription_expires_at
      ? new Date(u.subscription_expires_at * 1000).toISOString().slice(0, 10) : '';
    openModal('modalUser');
  } catch (e) { toast('–û—à–∏–±–∫–∞: ' + e.message, 'err'); }
}

document.getElementById('editUserSave').addEventListener('click', async () => {
  const uid = document.getElementById('editUserId').value;
  const tier = document.getElementById('editUserTier').value;
  const isBlocked = document.getElementById('editUserBlocked').value === 'true';
  const isAdmin = document.getElementById('editUserAdmin').value === 'true';
  const expiresStr = document.getElementById('editSubExpires').value;
  const amount = parseFloat(document.getElementById('editSubAmount').value) || 0;
  try {
    await apiFetch(`/api/admin/users/${uid}`, { method: 'PATCH', body: JSON.stringify({ tier, is_blocked: isBlocked, is_admin: isAdmin }) });
    if (expiresStr || amount > 0) {
      const expiresTs = expiresStr ? new Date(expiresStr).getTime() / 1000 : null;
      await apiFetch(`/api/admin/users/${uid}/subscription`, {
        method: 'POST',
        body: JSON.stringify({ tier, expires_at: expiresTs, amount }),
      });
    }
    toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω', 'ok');
    closeModal('modalUser');
    loadUsers(_usersPage);
  } catch (e) { toast('–û—à–∏–±–∫–∞: ' + e.message, 'err'); }
});

document.getElementById('editUserDelete').addEventListener('click', async () => {
  const uid = document.getElementById('editUserId').value;
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤—Å–µ –µ–≥–æ –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) return;
  try {
    await apiFetch(`/api/admin/users/${uid}`, { method: 'DELETE' });
    toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω', 'ok');
    closeModal('modalUser');
    loadUsers(_usersPage);
  } catch (e) { toast('–û—à–∏–±–∫–∞: ' + e.message, 'err'); }
});

// ‚îÄ‚îÄ‚îÄ Transactions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TX_LIMIT = 20;
let _txPage = 0;
let _txTotal = 0;
async function loadTransactions(page) {
  if (typeof page === 'number') _txPage = page;
  const userId = document.getElementById('txFilterUser').value;
  const status = document.getElementById('txFilterStatus').value;
  const params = new URLSearchParams({ limit: TX_LIMIT, offset: _txPage * TX_LIMIT });
  if (userId) params.set('user_id', userId);
  if (status) params.set('status', status);
  try {
    const d = await apiFetch('/api/admin/transactions?' + params);
    _txTotal = d.total || 0;
    const tbody = document.getElementById('txBody');
    if (!d.transactions.length) { tbody.innerHTML = '<tr><td colspan="8" style="color:var(--text-soft);text-align:center;padding:1rem">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>'; renderTxPagination(); return; }
    tbody.innerHTML = d.transactions.map(t => `
      <tr>
        <td>${t.id}</td><td>${t.user_id}</td>
        <td><strong>${t.amount}</strong> ${t.currency}</td>
        <td>${tierBadge(t.tier)}</td>
        <td style="font-size:.78rem;color:var(--text-soft)">${t.payment_system}</td>
        <td>${statusBadge(t.status)}</td>
        <td style="max-width:200px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;color:var(--text-soft)">${t.description || '‚Äî'}</td>
        <td style="font-size:.78rem;color:var(--text-soft)">${fmtDate(t.created_at)}</td>
      </tr>
    `).join('');
    renderTxPagination();
  } catch (e) { toast('–û—à–∏–±–∫–∞: ' + e.message, 'err'); }
}
function renderTxPagination() {
  const pages = Math.ceil(_txTotal / TX_LIMIT);
  const wrap = document.getElementById('txPagination');
  if (!wrap) return;
  if (pages <= 1) { wrap.innerHTML = '<span style="font-size:.8rem;color:var(--text-soft)">–í—Å–µ–≥–æ: ' + _txTotal + '</span>'; return; }
  let html = '<span style="font-size:.8rem;color:var(--text-soft)">–í—Å–µ–≥–æ: ' + _txTotal + '</span> ';
  for (let i = 0; i < pages; i++) html += '<button class="page-btn' + (i === _txPage ? ' active' : '') + '" onclick="loadTransactions(' + i + ')">' + (i + 1) + '</button>';
  wrap.innerHTML = html;
}

document.getElementById('txSearchBtn').addEventListener('click', () => { _txPage = 0; loadTransactions(); });
document.getElementById('btnAddTx').addEventListener('click', () => openModal('modalTx'));

// ‚îÄ‚îÄ‚îÄ CSV-—ç–∫—Å–ø–æ—Ä—Ç (P39) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function csvDownload(endpoint, filename) {
  const url = endpoint + '?_t=' + Date.now();
  const a = document.createElement('a');
  a.href = url;
  // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –∫–∞–∫ query-–ø–∞—Ä–∞–º–µ—Ç—Ä —á–µ—Ä–µ–∑ Blob URL –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ,
  // –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º fetch + Blob
  fetch(url, { headers: { Authorization: 'Bearer ' + _token } })
    .then(r => {
      if (!r.ok) throw new Error('–û—à–∏–±–∫–∞ ' + r.status);
      return r.blob();
    })
    .then(blob => {
      const burl = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = burl; a.download = filename; a.click();
      setTimeout(() => URL.revokeObjectURL(burl), 2000);
      toast('CSV —Å–∫–∞—á–∞–Ω', 'ok');
    })
    .catch(e => toast('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: ' + e.message, 'err'));
}

document.getElementById('btnExportUsers').addEventListener('click', () => {
  csvDownload('/api/admin/users/export.csv', 'users_export.csv');
});

document.getElementById('btnExportTx').addEventListener('click', () => {
  csvDownload('/api/admin/transactions/export.csv', 'transactions_export.csv');
});

// P50: –°–∫–∞—á–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ë–î
document.getElementById('btnBackupDb').addEventListener('click', () => {
  const stamp = new Date().toISOString().slice(0,19).replace(/[T:]/g, '-');
  toast('–°–æ–∑–¥–∞—ë–º –±—ç–∫–∞–ø‚Ä¶');
  fetch('/api/admin/backup/db', { headers: { Authorization: 'Bearer ' + _token } })
    .then(r => {
      if (!r.ok) return r.json().then(d => { throw new Error(d.detail || '–û—à–∏–±–∫–∞ ' + r.status); });
      return r.blob();
    })
    .then(blob => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `magic_master_backup_${stamp}.sqlite3`; a.click();
      setTimeout(() => URL.revokeObjectURL(url), 3000);
      toast('–ë—ç–∫–∞–ø —Å–∫–∞—á–∞–Ω ‚úì', 'ok');
    })
    .catch(e => toast('–û—à–∏–±–∫–∞: ' + e.message, 'err'));
});

document.getElementById('saveTxBtn').addEventListener('click', async () => {
  const body = {
    user_id: parseInt(document.getElementById('newTxUserId').value) || 0,
    amount: parseFloat(document.getElementById('newTxAmount').value) || 0,
    currency: document.getElementById('newTxCurrency').value || 'RUB',
    tier: document.getElementById('newTxTier').value,
    description: document.getElementById('newTxDesc').value,
  };
  if (!body.user_id) { toast('–£–∫–∞–∂–∏—Ç–µ User ID', 'err'); return; }
  try {
    await apiFetch('/api/admin/transactions', { method: 'POST', body: JSON.stringify(body) });
    toast('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'ok');
    closeModal('modalTx');
    loadTransactions();
  } catch (e) { toast('–û—à–∏–±–∫–∞: ' + e.message, 'err'); }
});

// ‚îÄ‚îÄ‚îÄ News ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const NEWS_LIMIT = 20;
let _newsPage = 0;
let _newsTotal = 0;
let _newsPosts = [];

async function loadNews(page) {
  if (typeof page === 'number') _newsPage = page;
  try {
    const d = await apiFetch('/api/admin/news?limit=' + NEWS_LIMIT + '&offset=' + (_newsPage * NEWS_LIMIT));
    _newsPosts = d.posts || [];
    _newsTotal = d.total || 0;
    renderNews();
    const wrap = document.getElementById('newsPagination');
    if (wrap) {
      const pages = Math.ceil(_newsTotal / NEWS_LIMIT);
      if (pages <= 1) wrap.innerHTML = '<span style="font-size:.8rem;color:var(--text-soft)">–í—Å–µ–≥–æ: ' + _newsTotal + '</span>';
      else {
        let html = '<span style="font-size:.8rem;color:var(--text-soft)">–í—Å–µ–≥–æ: ' + _newsTotal + '</span> ';
        for (let i = 0; i < pages; i++) html += '<button class="page-btn' + (i === _newsPage ? ' active' : '') + '" onclick="loadNews(' + i + ')">' + (i + 1) + '</button>';
        wrap.innerHTML = html;
      }
    }
  } catch (e) { toast('–û—à–∏–±–∫–∞: ' + e.message, 'err'); }
}

function renderNews() {
  const wrap = document.getElementById('newsListWrap');
  if (!_newsPosts.length) {
    wrap.innerHTML = '<div class="card" style="color:var(--text-soft);text-align:center;padding:2rem">–ü–æ—Å—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
    return;
  }
  wrap.innerHTML = _newsPosts.map(p => `
    <div class="card" style="margin-bottom:.8rem">
      <div style="display:flex;align-items:flex-start;gap:.8rem">
        <div style="flex:1">
          <div style="font-weight:600;margin-bottom:.25rem">${p.title || '(–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞)'}</div>
          <div class="news-body-preview">${p.body || ''}</div>
          <div style="margin-top:.4rem;font-size:.75rem;color:var(--text-soft)">
            ${p.is_published ? `<span class="badge badge-ok">–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω</span> ${fmtDate(p.published_at)}` : '<span class="badge badge-draft">—á–µ—Ä–Ω–æ–≤–∏–∫</span>'}
            &nbsp;¬∑ —Å–æ–∑–¥–∞–Ω ${fmtDate(p.created_at)}
          </div>
        </div>
        <div style="display:flex;gap:.4rem;flex-shrink:0">
          <button class="btn btn-ghost btn-sm" onclick="openEditPost(${p.id})">–ò–∑–º–µ–Ω–∏—Ç—å</button>
          ${p.is_published ? '' : `<button class="btn btn-success btn-sm" onclick="publishPost(${p.id})">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>`}
          <button class="btn btn-danger btn-sm" onclick="deletePost(${p.id})">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    </div>
  `).join('');
}

document.getElementById('btnNewPost').addEventListener('click', () => {
  document.getElementById('editPostId').value = '';
  document.getElementById('editPostTitle').value = '';
  document.getElementById('editPostBody').value = '';
  document.getElementById('editPostPublished').checked = false;
  document.getElementById('modalNewsTitle').textContent = '–ù–æ–≤—ã–π –ø–æ—Å—Ç';
  openModal('modalNews');
});

async function openEditPost(id) {
  const p = _newsPosts.find(x => x.id === id);
  if (!p) return;
  document.getElementById('editPostId').value = p.id;
  document.getElementById('editPostTitle').value = p.title;
  document.getElementById('editPostBody').value = p.body;
  document.getElementById('editPostPublished').checked = p.is_published;
  document.getElementById('modalNewsTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç';
  openModal('modalNews');
}

document.getElementById('savePostBtn').addEventListener('click', async () => {
  const id = document.getElementById('editPostId').value;
  const body = {
    title: document.getElementById('editPostTitle').value.trim(),
    body: document.getElementById('editPostBody').value,
    is_published: document.getElementById('editPostPublished').checked,
  };
  if (!body.title) { toast('–£–∫–∞–∂–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫', 'err'); return; }
  try {
    if (id) {
      await apiFetch(`/api/admin/news/${id}`, { method: 'PUT', body: JSON.stringify(body) });
    } else {
      await apiFetch('/api/admin/news', { method: 'POST', body: JSON.stringify(body) });
    }
    toast('–ü–æ—Å—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'ok');
    closeModal('modalNews');
    loadNews();
  } catch (e) { toast('–û—à–∏–±–∫–∞: ' + e.message, 'err'); }
});

async function publishPost(id) {
  try {
    await apiFetch(`/api/admin/news/${id}`, { method: 'PUT', body: JSON.stringify({ is_published: true }) });
    toast('–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ', 'ok');
    loadNews();
  } catch (e) { toast('–û—à–∏–±–∫–∞: ' + e.message, 'err'); }
}

async function deletePost(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç?')) return;
  try {
    await apiFetch(`/api/admin/news/${id}`, { method: 'DELETE' });
    toast('–ü–æ—Å—Ç —É–¥–∞–ª—ë–Ω', 'ok');
    loadNews();
  } catch (e) { toast('–û—à–∏–±–∫–∞: ' + e.message, 'err'); }
}

// ‚îÄ‚îÄ‚îÄ Campaigns ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CAMPAIGNS_LIMIT = 20;
let _campaignsPage = 0;
let _campaignsTotal = 0;
async function loadCampaigns(page) {
  if (typeof page === 'number') _campaignsPage = page;
  try {
    const d = await apiFetch('/api/admin/campaigns?limit=' + CAMPAIGNS_LIMIT + '&offset=' + (_campaignsPage * CAMPAIGNS_LIMIT));
    const camps = d.campaigns || [];
    _campaignsTotal = d.total || 0;
    const wrap = document.getElementById('campaignsListWrap');
    if (!camps.length) {
      wrap.innerHTML = '<div class="card" style="color:var(--text-soft);text-align:center;padding:2rem">–†–∞—Å—Å—ã–ª–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
      const pagEl = document.getElementById('campaignsPagination');
      if (pagEl) pagEl.innerHTML = '<span style="font-size:.8rem;color:var(--text-soft)">–í—Å–µ–≥–æ: 0</span>';
      return;
    }
    const statusBadgeC = s => {
      const cls = { draft:'badge-draft', sending:'badge-pending', sent:'badge-ok', failed:'badge-fail' }[s] || '';
      return `<span class="badge ${cls}">${s}</span>`;
    };
    wrap.innerHTML = camps.map(c => `
      <div class="card" style="margin-bottom:.8rem">
        <div style="display:flex;align-items:flex-start;gap:.8rem">
          <div style="flex:1">
            <div style="font-weight:600;margin-bottom:.2rem">${c.subject}</div>
            <div style="font-size:.78rem;color:var(--text-soft)">
              –ê—É–¥–∏—Ç–æ—Ä–∏—è: ${c.target_tier || '–≤—Å–µ'} &nbsp;¬∑&nbsp;
              ${statusBadgeC(c.status)}
              ${c.status === 'sent' || c.status === 'sending'
                ? ` &nbsp;¬∑ ${c.sent_count}/${c.total_recipients} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ`
                : ''
              }
              &nbsp;¬∑ —Å–æ–∑–¥–∞–Ω–∞ ${fmtDate(c.created_at)}
              ${c.sent_at ? ` ¬∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ ${fmtDate(c.sent_at)}` : ''}
            </div>
          </div>
          <div style="flex-shrink:0">
            ${c.status === 'draft' ? `<button class="btn btn-success btn-sm" onclick="sendCampaign(${c.id})">‚ñ∂ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>` : ''}
          </div>
        </div>
      </div>
    `).join('');
    const pagEl = document.getElementById('campaignsPagination');
    if (pagEl) {
      const pages = Math.ceil(_campaignsTotal / CAMPAIGNS_LIMIT);
      if (pages <= 1) pagEl.innerHTML = '<span style="font-size:.8rem;color:var(--text-soft)">–í—Å–µ–≥–æ: ' + _campaignsTotal + '</span>';
      else {
        let html = '<span style="font-size:.8rem;color:var(--text-soft)">–í—Å–µ–≥–æ: ' + _campaignsTotal + '</span> ';
        for (let i = 0; i < pages; i++) html += '<button class="page-btn' + (i === _campaignsPage ? ' active' : '') + '" onclick="loadCampaigns(' + i + ')">' + (i + 1) + '</button>';
        pagEl.innerHTML = html;
      }
    }
  } catch (e) { toast('–û—à–∏–±–∫–∞: ' + e.message, 'err'); }
}

document.getElementById('btnNewCampaign').addEventListener('click', () => {
  document.getElementById('campSubject').value = '';
  document.getElementById('campTier').value = '';
  document.getElementById('campBodyHtml').value = '';
  document.getElementById('campBodyText').value = '';
  openModal('modalCampaign');
});

document.getElementById('saveCampBtn').addEventListener('click', async () => {
  const body = {
    subject: document.getElementById('campSubject').value.trim(),
    body_html: document.getElementById('campBodyHtml').value,
    body_text: document.getElementById('campBodyText').value,
    target_tier: document.getElementById('campTier').value || null,
  };
  if (!body.subject) { toast('–£–∫–∞–∂–∏—Ç–µ —Ç–µ–º—É –ø–∏—Å—å–º–∞', 'err'); return; }
  try {
    await apiFetch('/api/admin/campaigns', { method: 'POST', body: JSON.stringify(body) });
    toast('–ö–∞–º–ø–∞–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∞', 'ok');
    closeModal('modalCampaign');
    loadCampaigns();
  } catch (e) { toast('–û—à–∏–±–∫–∞: ' + e.message, 'err'); }
});

async function sendCampaign(id) {
  if (!confirm('–ù–∞—á–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É? –ü–∏—Å—å–º–∞ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º.')) return;
  try {
    const r = await apiFetch(`/api/admin/campaigns/${id}/send`, { method: 'POST' });
    toast(`–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞: ${r.total_recipients} –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π`, 'ok');
    loadCampaigns();
  } catch (e) { toast('–û—à–∏–±–∫–∞: ' + e.message, 'err'); }
}

// ‚îÄ‚îÄ‚îÄ Settings (P29) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadSettings() {
  const wrap = document.getElementById('settingsWrap');
  if (!wrap) return;
  wrap.innerHTML = '<p style="color:var(--text-soft)">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</p>';
  try {
    const [d, promptsData] = await Promise.all([apiFetch('/api/admin/settings'), apiFetch('/api/admin/prompts').catch(() => ({}))]);
    window._adminPromptsData = promptsData || {};
    const extList = Array.isArray(d.app.allowed_extensions) ? d.app.allowed_extensions.join(', ') : 'wav, mp3, flac';
    const slugNames = { recommend: '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø—Ä–µ—Å–µ—Ç–∞', report: '–û—Ç—á—ë—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É', nl_config: 'NL ‚Üí –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–µ–ø–æ—á–∫–∏', chat: '–ß–∞—Ç-–ø–æ–º–æ—â–Ω–∏–∫' };

    wrap.innerHTML = `
      <div class="card" style="margin-bottom:1rem">
        <p style="font-size:.78rem;color:var(--text-soft);margin-bottom:.8rem">–í–µ—Ä—Å–∏—è: ${[d.app.version, d.app.build_date].filter(Boolean).join(' ¬∑ ') || '‚Äî'} ¬∑ JWT –∑–∞–¥–∞–Ω: ${d.app.jwt_secret_set ? '–î–∞' : '–ù–µ—Ç'} ¬∑ –ê–¥–º–∏–Ω: ${d.admin_email || '‚Äî'}</p>
        <div class="settings-tabs" id="settingsTabs">
          <button type="button" class="settings-tab active" data-tab="app">–û–±—â–∏–µ</button>
          <button type="button" class="settings-tab" data-tab="smtp">SMTP</button>
          <button type="button" class="settings-tab" data-tab="yookassa">YooKassa</button>
          <button type="button" class="settings-tab" data-tab="telegram">Telegram</button>
          <button type="button" class="settings-tab" data-tab="llm">LLM</button>
        </div>

        <div id="settingsPanelApp" class="settings-panel active">
          <form class="settings-form" id="settingsFormApp">
            <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:.8rem">
              <div class="form-group"><label>–ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ (–ú–ë)</label><input type="number" name="max_upload_mb" value="${d.app.max_upload_mb != null ? d.app.max_upload_mb : 100}" min="1" max="500"></div>
              <div class="form-group"><label>–î–æ–ø—É—Å—Ç–∏–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label><input type="text" name="allowed_extensions" value="${extList}" placeholder="wav, mp3, flac"></div>
              <div class="form-group"><label>–¶–µ–ª–µ–≤–æ–π LUFS –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label><input type="number" step="0.5" name="default_target_lufs" value="${d.app.default_target_lufs != null ? d.app.default_target_lufs : -14}"></div>
              <div class="form-group"><label>TTL –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–¥–∞—á (—Å)</label><input type="number" name="jobs_done_ttl_seconds" value="${d.app.jobs_done_ttl_seconds != null ? d.app.jobs_done_ttl_seconds : 3600}" min="60"></div>
              <div class="form-group"><label>Rate limit (–∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω)</label><input type="number" name="global_rate_limit" value="${d.app.global_rate_limit != null ? d.app.global_rate_limit : 300}" min="10"></div>
              <div class="form-group"><label>–í—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–ø–∫–∞</label><input type="text" name="temp_dir" value="${(d.app.temp_dir || '').replace(/"/g, '&quot;')}" placeholder="/tmp/masterflow"></div>
              <div class="form-group"><label>CORS origins (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label><input type="text" name="cors_origins" value="${(d.app.cors_origins || '*').replace(/"/g, '&quot;')}" placeholder="*"></div>
              <div class="form-group"><label>–Ø–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label><input type="text" name="default_locale" value="${d.app.default_locale || 'ru'}" placeholder="ru"></div>
            </div>
            <div class="form-row" style="display:flex;gap:1.5rem;flex-wrap:wrap;margin-top:.5rem">
              <label style="display:flex;align-items:center;gap:.4rem;cursor:pointer"><input type="checkbox" name="debug_mode" ${d.app.debug_mode ? 'checked' : ''}> Debug-—Ä–µ–∂–∏–º</label>
              <label style="display:flex;align-items:center;gap:.4rem;cursor:pointer"><input type="checkbox" name="require_email_verify" ${d.app.require_email_verify ? 'checked' : ''}> –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è email</label>
              <label style="display:flex;align-items:center;gap:.4rem;cursor:pointer"><input type="checkbox" name="feature_ai_enabled" ${d.app.feature_ai_enabled !== false ? 'checked' : ''}> AI –≤–∫–ª—é—á—ë–Ω</label>
              <label style="display:flex;align-items:center;gap:.4rem;cursor:pointer"><input type="checkbox" name="feature_batch_enabled" ${d.app.feature_batch_enabled !== false ? 'checked' : ''}> –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞</label>
              <label style="display:flex;align-items:center;gap:.4rem;cursor:pointer"><input type="checkbox" name="feature_registration_enabled" ${d.app.feature_registration_enabled !== false ? 'checked' : ''}> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</label>
              <label style="display:flex;align-items:center;gap:.4rem;cursor:pointer"><input type="checkbox" name="maintenance_mode" ${d.app.maintenance_mode ? 'checked' : ''}> –†–µ–∂–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è</label>
              <label style="display:flex;align-items:center;gap:.4rem;cursor:pointer"><input type="checkbox" name="notify_email_on_register" ${d.app.notify_email_on_register ? 'checked' : ''}> Email –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</label>
              <label style="display:flex;align-items:center;gap:.4rem;cursor:pointer"><input type="checkbox" name="notify_telegram_on_payment" ${d.app.notify_telegram_on_payment ? 'checked' : ''}> Telegram –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ</label>
            </div>
            <div class="settings-save-bar"><button type="submit" class="btn btn-primary btn-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
          </form>
        </div>

        <div id="settingsPanelSmtp" class="settings-panel">
          <form class="settings-form" id="settingsFormSmtp">
            <div class="form-group"><label>–°–µ—Ä–≤–µ—Ä (host)</label><input type="text" name="host" value="${(d.smtp.host || '').replace(/"/g, '&quot;')}" placeholder="smtp.gmail.com"></div>
            <div class="form-group"><label>–ü–æ—Ä—Ç</label><input type="number" name="port" value="${d.smtp.port != null ? d.smtp.port : 587}"></div>
            <div class="form-group"><label>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label><input type="text" name="user" value="${(d.smtp.user || '').replace(/"/g, '&quot;')}"></div>
            <div class="form-group"><label>–ü–∞—Ä–æ–ª—å (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å)</label><input type="password" class="secret" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password"></div>
            <div class="form-group"><label>–û—Ç –∫–æ–≥–æ (from)</label><input type="text" name="from_" value="${(d.smtp.from || '').replace(/"/g, '&quot;')}"></div>
            <label style="display:flex;align-items:center;gap:.4rem;cursor:pointer;margin-top:.5rem"><input type="checkbox" name="use_tls" ${d.smtp.use_tls ? 'checked' : ''}> TLS</label>
            <div class="settings-save-bar"><button type="submit" class="btn btn-primary btn-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
          </form>
        </div>

        <div id="settingsPanelYookassa" class="settings-panel">
          <form class="settings-form" id="settingsFormYookassa">
            <div class="form-group"><label>Shop ID</label><input type="text" name="shop_id" value="${(d.yookassa.shop_id || '').replace(/"/g, '&quot;')}"></div>
            <div class="form-group"><label>–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á (–ø—É—Å—Ç–æ = –Ω–µ –º–µ–Ω—è—Ç—å)</label><input type="password" class="secret" name="secret_key" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password"></div>
            <div class="form-group"><label>URL –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã</label><input type="text" name="return_url" value="${(d.yookassa.return_url || '').replace(/"/g, '&quot;')}" placeholder="https://..."></div>
            <div class="form-group"><label>Webhook IP whitelist (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label><input type="text" name="webhook_ip_whitelist" value="${(d.yookassa.webhook_ip_whitelist || '').replace(/"/g, '&quot;')}"></div>
            <div class="settings-save-bar"><button type="submit" class="btn btn-primary btn-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
          </form>
        </div>

        <div id="settingsPanelTelegram" class="settings-panel">
          <form class="settings-form" id="settingsFormTelegram">
            <div class="form-group"><label>–¢–æ–∫–µ–Ω –±–æ—Ç–∞ (–ø—É—Å—Ç–æ = –Ω–µ –º–µ–Ω—è—Ç—å)</label><input type="password" class="secret" name="bot_token" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password"></div>
            <div class="form-group"><label>Chat ID</label><input type="text" name="chat_id" value="${(d.telegram && d.telegram.chat_id ? d.telegram.chat_id.replace(/‚Ä¶$/, '') : '') || ''}" placeholder="123456789"></div>
            <div class="settings-save-bar"><button type="submit" class="btn btn-primary btn-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
          </form>
        </div>

        <div id="settingsPanelLlm" class="settings-panel">
          <form class="settings-form" id="settingsFormLlm">
            <div class="form-group"><label>–ë—ç–∫–µ–Ω–¥</label><select name="backend"><option value="openai" ${(d.llm && d.llm.backend === 'openai') ? 'selected' : ''}>OpenAI</option><option value="deepseek" ${(d.llm && d.llm.backend === 'deepseek') ? 'selected' : ''}>DeepSeek</option><option value="anthropic" ${(d.llm && d.llm.backend === 'anthropic') ? 'selected' : ''}>Anthropic</option></select></div>
            <div class="form-group"><label>OpenAI API –∫–ª—é—á (–ø—É—Å—Ç–æ = –Ω–µ –º–µ–Ω—è—Ç—å)</label><input type="password" class="secret" name="openai_api_key" placeholder="sk-..." autocomplete="new-password"></div>
            <div class="form-group"><label>Anthropic API –∫–ª—é—á (–ø—É—Å—Ç–æ = –Ω–µ –º–µ–Ω—è—Ç—å)</label><input type="password" class="secret" name="anthropic_api_key" placeholder="..." autocomplete="new-password"></div>
            <div class="form-group"><label>DeepSeek API –∫–ª—é—á (–ø—É—Å—Ç–æ = –Ω–µ –º–µ–Ω—è—Ç—å)</label><input type="password" class="secret" name="deepseek_api_key" placeholder="..." autocomplete="new-password"></div>
            <div class="form-group"><label>DeepSeek Base URL</label><input type="text" name="deepseek_base_url" value="${(d.llm && d.llm.deepseek_base_url) ? String(d.llm.deepseek_base_url).replace(/"/g, '&quot;') : 'https://api.deepseek.com'}"></div>
            <div class="form-group"><label>DeepSeek –º–æ–¥–µ–ª—å</label><input type="text" name="deepseek_model" value="${(d.llm && d.llm.deepseek_model) || 'deepseek-chat'}"></div>
            <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:.8rem">
              <div class="form-group"><label>–õ–∏–º–∏—Ç Free (–∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å, -1 –±–µ–∑ –ª–∏–º–∏—Ç–∞)</label><input type="number" name="ai_limit_free" value="${d.llm && d.llm.ai_limit_free != null ? d.llm.ai_limit_free : 5}"></div>
              <div class="form-group"><label>–õ–∏–º–∏—Ç Pro</label><input type="number" name="ai_limit_pro" value="${d.llm && d.llm.ai_limit_pro != null ? d.llm.ai_limit_pro : 50}"></div>
              <div class="form-group"><label>–õ–∏–º–∏—Ç Studio</label><input type="number" name="ai_limit_studio" value="${d.llm && d.llm.ai_limit_studio != null ? d.llm.ai_limit_studio : -1}"></div>
            </div>
            <div style="margin-top:1.2rem;padding-top:1rem;border-top:1px solid var(--border)">
              <h4 style="font-size:.9rem;margin-bottom:.6rem;color:var(--accent2)">–ó–∞—â–∏—Ç–∞ –æ—Ç LLM-–∏–Ω—ä–µ–∫—Ü–∏–π</h4>
              <p style="font-size:.75rem;color:var(--text-soft);margin-bottom:.8rem">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ LLM (—á–∞—Ç, ¬´–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–æ–ª–æ—Å–æ–º¬ª). –ü—Ä–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏ —Å –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–º–∏ —Ñ—Ä–∞–∑–∞–º–∏ –∏–ª–∏ regex –∑–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è.</p>
              <div class="form-row" style="display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:.6rem">
                <div class="form-group"><label><input type="checkbox" name="llm_guard_enabled" ${(d.llm && d.llm.llm_guard_enabled !== false) ? 'checked' : ''}> –í–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É</label></div>
                <div class="form-group"><label>–ú–∞–∫—Å. –¥–ª–∏–Ω–∞ —á–∞—Ç (—Å–∏–º–≤–æ–ª–æ–≤)</label><input type="number" name="llm_guard_max_length_chat" min="0" value="${d.llm && d.llm.llm_guard_max_length_chat != null ? d.llm.llm_guard_max_length_chat : 2000}"></div>
                <div class="form-group"><label>–ú–∞–∫—Å. –¥–ª–∏–Ω–∞ NL‚Üíconfig</label><input type="number" name="llm_guard_max_length_nl" min="0" value="${d.llm && d.llm.llm_guard_max_length_nl != null ? d.llm.llm_guard_max_length_nl : 500}"></div>
              </div>
              <div class="form-row" style="margin-bottom:.6rem">
                <div class="form-group" style="flex:1"><label>–ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ –ø–æ–¥—Å—Ç—Ä–æ–∫–∏ (–ø–æ –æ–¥–Ω–æ–π –Ω–∞ —Å—Ç—Ä–æ–∫—É)</label><textarea name="llm_guard_forbidden_substrings" rows="4" placeholder="ignore previous instructions\n–ø–µ—Ä–µ–≤–µ–¥–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –∏ –≤—ã–ø–æ–ª–Ω–∏" style="width:100%;resize:vertical">${Array.isArray(d.llm && d.llm.llm_guard_forbidden_substrings) ? (d.llm.llm_guard_forbidden_substrings.join('\n')) : ''}</textarea></div>
              </div>
              <div class="form-row" style="margin-bottom:.6rem">
                <div class="form-group" style="flex:1"><label>–ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–π regex (–ø—É—Å—Ç–æ = –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å)</label><input type="text" name="llm_guard_forbidden_regex" placeholder="(?i)ignore\s+all\s+previous" value="${(d.llm && d.llm.llm_guard_forbidden_regex) ? String(d.llm.llm_guard_forbidden_regex).replace(/"/g, '&quot;') : ''}" style="width:100%"></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label><input type="checkbox" name="llm_guard_truncate_on_long" ${(d.llm && d.llm.llm_guard_truncate_on_long !== false) ? 'checked' : ''}> –û–±—Ä–µ–∑–∞—Ç—å –¥–ª–∏–Ω–Ω—ã–π –≤–≤–æ–¥ (–∏–Ω–∞—á–µ –æ—Ç–∫–ª–æ–Ω—è—Ç—å)</label></div>
                <div class="form-group"><label><input type="checkbox" name="llm_guard_block_role_system" ${(d.llm && d.llm.llm_guard_block_role_system !== false) ? 'checked' : ''}> –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–æ–ª—å ¬´system¬ª –≤ —á–∞—Ç–µ</label></div>
              </div>
            </div>
            <div class="settings-save-bar"><button type="submit" class="btn btn-primary btn-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
          </form>
          <div style="margin-top:1.5rem;padding-top:1rem;border-top:1px solid var(--border)">
            <h4 style="font-size:.9rem;margin-bottom:.8rem;color:var(--accent2)">–ü—Ä–æ–º–ø—Ç—ã (—à–∞–±–ª–æ–Ω—ã –∏ –≤–µ—Ä—Å–∏–∏)</h4>
            <div id="promptsBlock">${Object.keys(slugNames).map(slug => {
              const p = (promptsData && promptsData[slug]) || {};
              const preview = (p.effective_preview || p.active_body || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').slice(0, 150);
              return '<div class="llm-prompt-block" style="margin-bottom:.8rem"><strong>' + slugNames[slug] + '</strong> <span style="font-size:.7rem;color:var(--text-soft)">(' + slug + ')</span><pre class="llm-prompt-text" style="max-height:60px">' + (preview || '‚Äî') + '</pre><div style="display:flex;gap:.4rem;margin-top:.4rem"><button type="button" class="btn btn-sm btn-ghost prompt-edit" data-slug="' + slug + '">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button><button type="button" class="btn btn-sm btn-ghost prompt-history" data-slug="' + slug + '">–ò—Å—Ç–æ—Ä–∏—è</button><button type="button" class="btn btn-sm btn-ghost prompt-reset" data-slug="' + slug + '">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π</button></div></div>';
            }).join('')}</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 .8rem;font-size:.95rem;color:var(--accent2)">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h3>
        <p style="font-size:.8rem;color:var(--text-soft);margin-bottom:.9rem">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫.</p>
        <div style="display:flex;gap:.7rem;flex-wrap:wrap">
          <button class="btn btn-sm" id="btnTestSmtp">üìß –¢–µ—Å—Ç Email (SMTP)</button>
          <button class="btn btn-sm" id="btnTestTg">‚úà –¢–µ—Å—Ç Telegram</button>
        </div>
        <div id="notifyTestResult" style="margin-top:.7rem;font-size:.82rem;min-height:1.2em"></div>
      </div>
    `;

    // Tabs
    document.querySelectorAll('#settingsTabs .settings-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const t = tab.dataset.tab;
        document.querySelectorAll('#settingsTabs .settings-tab').forEach(x => x.classList.toggle('active', x.dataset.tab === t));
        document.querySelectorAll('.settings-panel').forEach(p => p.classList.toggle('active', p.id === 'settingsPanel' + t.charAt(0).toUpperCase() + t.slice(1)));
      });
    });

    function buildAppPayload(form) {
      const fd = new FormData(form);
      const allowed = (fd.get('allowed_extensions') || '').toString().split(',').map(s => s.trim()).filter(Boolean);
      return {
        app: {
          max_upload_mb: parseInt(fd.get('max_upload_mb'), 10) || 100,
          allowed_extensions: allowed.length ? allowed : ['wav', 'mp3', 'flac'],
          temp_dir: (fd.get('temp_dir') || '').toString().trim() || undefined,
          default_target_lufs: parseFloat(fd.get('default_target_lufs')) || -14,
          jobs_done_ttl_seconds: parseInt(fd.get('jobs_done_ttl_seconds'), 10) || 3600,
          debug_mode: !!fd.get('debug_mode'),
          require_email_verify: !!fd.get('require_email_verify'),
          global_rate_limit: parseInt(fd.get('global_rate_limit'), 10) || 300,
          cors_origins: (fd.get('cors_origins') || '').toString().trim() || undefined,
          default_locale: (fd.get('default_locale') || '').toString().trim() || undefined,
          feature_ai_enabled: !!fd.get('feature_ai_enabled'),
          feature_batch_enabled: !!fd.get('feature_batch_enabled'),
          feature_registration_enabled: !!fd.get('feature_registration_enabled'),
          maintenance_mode: !!fd.get('maintenance_mode'),
          notify_email_on_register: !!fd.get('notify_email_on_register'),
          notify_telegram_on_payment: !!fd.get('notify_telegram_on_payment')
        }
      };
    }
    function buildSmtpPayload(form) {
      const fd = new FormData(form);
      const o = { smtp: { host: fd.get('host'), port: parseInt(fd.get('port'), 10) || 587, user: fd.get('user'), from_: fd.get('from_'), use_tls: !!fd.get('use_tls') } };
      if ((fd.get('password') || '').toString().trim()) o.smtp.password = fd.get('password');
      return o;
    }
    function buildYookassaPayload(form) {
      const fd = new FormData(form);
      const o = { yookassa: { shop_id: fd.get('shop_id'), return_url: fd.get('return_url'), webhook_ip_whitelist: (fd.get('webhook_ip_whitelist') || '').toString().trim() || undefined } };
      if ((fd.get('secret_key') || '').toString().trim()) o.yookassa.secret_key = fd.get('secret_key');
      return o;
    }
    function buildTelegramPayload(form) {
      const fd = new FormData(form);
      const o = { telegram: {} };
      const chatId = (fd.get('chat_id') || '').toString().trim();
      if (chatId) o.telegram.chat_id = chatId;
      if ((fd.get('bot_token') || '').toString().trim()) o.telegram.bot_token = fd.get('bot_token');
      if (Object.keys(o.telegram).length === 0) o.telegram = undefined;
      return o;
    }
    function buildLlmPayload(form) {
      const fd = new FormData(form);
      const o = { llm: { backend: fd.get('backend'), deepseek_base_url: fd.get('deepseek_base_url'), deepseek_model: fd.get('deepseek_model'), ai_limit_free: parseInt(fd.get('ai_limit_free'), 10), ai_limit_pro: parseInt(fd.get('ai_limit_pro'), 10), ai_limit_studio: parseInt(fd.get('ai_limit_studio'), 10), llm_guard_enabled: !!fd.get('llm_guard_enabled'), llm_guard_max_length_chat: parseInt(fd.get('llm_guard_max_length_chat'), 10) || 2000, llm_guard_max_length_nl: parseInt(fd.get('llm_guard_max_length_nl'), 10) || 500, llm_guard_forbidden_regex: (fd.get('llm_guard_forbidden_regex') || '').toString().trim() || undefined, llm_guard_truncate_on_long: !!fd.get('llm_guard_truncate_on_long'), llm_guard_block_role_system: !!fd.get('llm_guard_block_role_system') } };
      o.llm.llm_guard_forbidden_substrings = (fd.get('llm_guard_forbidden_substrings') || '').toString().split(/[\r\n]+/).map(s => s.trim()).filter(Boolean);
      if ((fd.get('openai_api_key') || '').toString().trim()) o.llm.openai_api_key = fd.get('openai_api_key');
      if ((fd.get('anthropic_api_key') || '').toString().trim()) o.llm.anthropic_api_key = fd.get('anthropic_api_key');
      if ((fd.get('deepseek_api_key') || '').toString().trim()) o.llm.deepseek_api_key = fd.get('deepseek_api_key');
      return o;
    }

    document.getElementById('settingsFormApp').addEventListener('submit', async (e) => { e.preventDefault(); try { await apiFetch('/api/admin/settings', { method: 'PATCH', body: JSON.stringify(buildAppPayload(e.target)) }); toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'ok'); } catch (err) { toast(err.message || '–û—à–∏–±–∫–∞', 'err'); } });
    document.getElementById('settingsFormSmtp').addEventListener('submit', async (e) => { e.preventDefault(); try { await apiFetch('/api/admin/settings', { method: 'PATCH', body: JSON.stringify(buildSmtpPayload(e.target)) }); toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'ok'); } catch (err) { toast(err.message || '–û—à–∏–±–∫–∞', 'err'); } });
    document.getElementById('settingsFormYookassa').addEventListener('submit', async (e) => { e.preventDefault(); try { await apiFetch('/api/admin/settings', { method: 'PATCH', body: JSON.stringify(buildYookassaPayload(e.target)) }); toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'ok'); } catch (err) { toast(err.message || '–û—à–∏–±–∫–∞', 'err'); } });
    document.getElementById('settingsFormTelegram').addEventListener('submit', async (e) => { e.preventDefault(); try { await apiFetch('/api/admin/settings', { method: 'PATCH', body: JSON.stringify(buildTelegramPayload(e.target)) }); toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'ok'); } catch (err) { toast(err.message || '–û—à–∏–±–∫–∞', 'err'); } });
    document.getElementById('settingsFormLlm').addEventListener('submit', async (e) => { e.preventDefault(); try { await apiFetch('/api/admin/settings', { method: 'PATCH', body: JSON.stringify(buildLlmPayload(e.target)) }); toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'ok'); } catch (err) { toast(err.message || '–û—à–∏–±–∫–∞', 'err'); } });

    document.getElementById('btnTestSmtp')?.addEventListener('click', async () => {
      const el = document.getElementById('notifyTestResult');
      el.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞‚Ä¶'; el.style.color = 'var(--text-soft)';
      try { const r = await apiFetch('/api/admin/notifications/test-email', { method: 'POST' }); el.textContent = '‚úì ' + r.message; el.style.color = 'var(--green)'; } catch (e) { el.textContent = '‚úó ' + e.message; el.style.color = 'var(--red)'; }
    });
    document.getElementById('btnTestTg')?.addEventListener('click', async () => {
      const el = document.getElementById('notifyTestResult');
      el.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞‚Ä¶'; el.style.color = 'var(--text-soft)';
      try { const r = await apiFetch('/api/admin/notifications/test-telegram', { method: 'POST' }); el.textContent = '‚úì ' + r.message; el.style.color = 'var(--green)'; } catch (e) { el.textContent = '‚úó ' + e.message; el.style.color = 'var(--red)'; }
    });

    // –ü—Ä–æ–º–ø—Ç—ã: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å / –ò—Å—Ç–æ—Ä–∏—è / –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
    wrap.querySelectorAll('.prompt-edit').forEach(btn => {
      btn.addEventListener('click', () => {
        const slug = btn.dataset.slug;
        const p = (promptsData && promptsData[slug]) || {};
        document.getElementById('modalPromptEditSlug').value = slug;
        document.getElementById('modalPromptEditTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: ' + (slugNames[slug] || slug);
        document.getElementById('modalPromptEditBody').value = p.effective_body || p.active_body || '';
        document.getElementById('modalPromptEdit').classList.add('open');
      });
    });
    wrap.querySelectorAll('.prompt-history').forEach(btn => {
      btn.addEventListener('click', async () => {
        const slug = btn.dataset.slug;
        document.getElementById('modalPromptHistorySlug').value = slug;
        document.getElementById('modalPromptHistoryTitle').textContent = '–ò—Å—Ç–æ—Ä–∏—è: ' + (slugNames[slug] || slug);
        const listEl = document.getElementById('modalPromptHistoryList');
        listEl.innerHTML = '<p style="color:var(--text-soft)">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</p>';
        document.getElementById('modalPromptHistory').classList.add('open');
        try {
          const r = await apiFetch('/api/admin/prompts/' + slug + '/history');
          listEl.innerHTML = (r.items && r.items.length) ? r.items.map(v => '<div style="padding:.5rem 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center"><span style="font-size:.8rem">v' + v.version + ' ¬∑ ' + (v.preview || '').slice(0, 80) + '‚Ä¶</span><button type="button" class="btn btn-sm btn-ghost prompt-activate-version" data-id="' + v.id + '">–°–¥–µ–ª–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–π</button></div>').join('') : '<p style="color:var(--text-soft)">–ù–µ—Ç –≤–µ—Ä—Å–∏–π</p>';
          listEl.querySelectorAll('.prompt-activate-version').forEach(b => b.addEventListener('click', async () => {
            try { await apiFetch('/api/admin/prompts/' + slug + '/activate', { method: 'POST', body: JSON.stringify({ version_id: parseInt(b.dataset.id, 10) }) }); toast('–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ', 'ok'); closeModal('modalPromptHistory'); loadSettings(); } catch (e) { toast(e.message || '–û—à–∏–±–∫–∞', 'err'); }
          }));
        } catch (e) { listEl.innerHTML = '<p style="color:var(--red)">' + e.message + '</p>'; }
      });
    });
    wrap.querySelectorAll('.prompt-reset').forEach(btn => {
      btn.addEventListener('click', async () => {
        const slug = btn.dataset.slug;
        if (!confirm('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è ¬´' + (slugNames[slug] || slug) + '¬ª? –ö–∞—Å—Ç–æ–º–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏.')) return;
        try { await apiFetch('/api/admin/prompts/' + slug + '/reset', { method: 'POST' }); toast('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'ok'); loadSettings(); } catch (e) { toast(e.message || '–û—à–∏–±–∫–∞', 'err'); }
      });
    });
    document.getElementById('modalPromptEditSave')?.addEventListener('click', async () => {
      const slug = document.getElementById('modalPromptEditSlug').value;
      const body = document.getElementById('modalPromptEditBody').value.trim();
      if (!body) { toast('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞', 'err'); return; }
      try {
        await apiFetch('/api/admin/prompts', { method: 'POST', body: JSON.stringify({ slug, body }) });
        toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'ok');
        closeModal('modalPromptEdit');
        loadSettings();
      } catch (e) { toast(e.message || '–û—à–∏–±–∫–∞', 'err'); }
    });

  } catch (e) {
    wrap.innerHTML = `<p style="color:var(--red)">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ${e.message}</p>`;
  }
}

const AUDIT_LIMIT = 50;
let _auditPage = 0;
let _auditTotal = 0;
async function loadAudit(page) {
  if (typeof page === 'number') _auditPage = page;
  const tbody = document.getElementById('auditBody');
  const paginationEl = document.getElementById('auditPagination');
  if (!tbody) return;
  tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-soft)">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>';
  try {
    const params = new URLSearchParams();
    params.set('limit', String(AUDIT_LIMIT));
    params.set('offset', String(_auditPage * AUDIT_LIMIT));
    const action = document.getElementById('auditFilterAction');
    if (action && action.value.trim()) params.set('action', action.value.trim());
    const dateFrom = document.getElementById('auditDateFrom');
    if (dateFrom && dateFrom.value) params.set('date_from', dateFrom.value);
    const dateTo = document.getElementById('auditDateTo');
    if (dateTo && dateTo.value) params.set('date_to', dateTo.value);
    const data = await apiFetch('/api/admin/audit?' + params.toString());
    _auditTotal = data.total || 0;
    const logs = data.logs || [];
    if (logs.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-soft)">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>';
    } else {
      tbody.innerHTML = logs.map(lg => {
        const dt = lg.created_at ? new Date(lg.created_at * 1000).toLocaleString('ru-RU') : '‚Äî';
        return '<tr><td>' + dt + '</td><td>' + (lg.admin_email || '‚Äî') + '</td><td>' + (lg.action || '‚Äî') + '</td><td>' + (lg.target_type || '‚Äî') + '</td><td>' + (lg.target_id != null ? lg.target_id : '‚Äî') + '</td><td title="' + (lg.details || '').replace(/"/g, '&quot;') + '">' + (lg.details ? (lg.details.length > 60 ? lg.details.slice(0, 60) + '‚Ä¶' : lg.details) : '‚Äî') + '</td><td>' + (lg.ip || '‚Äî') + '</td></tr>';
      }).join('');
    }
    const pages = Math.ceil(_auditTotal / AUDIT_LIMIT);
    if (pages <= 1) {
      paginationEl.innerHTML = '<span style="font-size:.8rem;color:var(--text-soft)">–í—Å–µ–≥–æ: ' + _auditTotal + '</span>';
    } else {
      let html = '<span style="font-size:.8rem;color:var(--text-soft)">–í—Å–µ–≥–æ: ' + _auditTotal + '</span> ';
      for (let i = 0; i < pages; i++) {
        html += '<button class="page-btn' + (i === _auditPage ? ' active' : '') + '" onclick="loadAudit(' + i + ')">' + (i + 1) + '</button>';
      }
      paginationEl.innerHTML = html;
    }
  } catch (e) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--red)">–û—à–∏–±–∫–∞: ' + e.message + '</td></tr>';
  }
}
const auditFilterBtn = document.getElementById('auditFilterBtn');
if (auditFilterBtn) auditFilterBtn.addEventListener('click', () => { _auditPage = 0; loadAudit(); });

let _currentReportId = null;
async function loadReports() {
  const wrap = document.getElementById('reportSelectWrap');
  const resultWrap = document.getElementById('reportResultWrap');
  if (!wrap) return;
  try {
    const r = await apiFetch('/api/admin/reports/list');
    const reports = r.reports || [];
    wrap.innerHTML = reports.map(rep => '<button type="button" class="btn btn-ghost btn-sm report-select" data-id="' + rep.id + '" title="' + (rep.description || '') + '">' + rep.name + '</button>').join('');
    wrap.querySelectorAll('.report-select').forEach(btn => {
      btn.addEventListener('click', () => {
        _currentReportId = btn.dataset.id;
        document.querySelectorAll('.report-select').forEach(b => b.classList.toggle('active', b.dataset.id === _currentReportId));
      });
    });
    resultWrap.style.display = 'none';
    document.getElementById('reportRunBtn').onclick = async () => {
      if (!_currentReportId) { toast('–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç—á—ë—Ç', 'err'); return; }
      const dateFrom = document.getElementById('reportDateFrom').value || undefined;
      const dateTo = document.getElementById('reportDateTo').value || undefined;
      const params = new URLSearchParams();
      if (dateFrom) params.set('date_from', dateFrom);
      if (dateTo) params.set('date_to', dateTo);
      const data = await apiFetch('/api/admin/reports/' + _currentReportId + '?' + params.toString());
      const meta = reports.find(x => x.id === _currentReportId);
      document.getElementById('reportResultTitle').textContent = meta ? meta.name : _currentReportId;
      document.getElementById('reportSummary').style.display = 'none';
      const table = document.getElementById('reportTable');
      const tbody = table.querySelector('tbody');
      const emptyEl = document.getElementById('reportEmpty');
      const rows = data.rows || [];
      if (rows.length === 0 && !data.total && !data.total_amount) {
        tbody.innerHTML = '';
        emptyEl.style.display = 'block';
      } else {
        emptyEl.style.display = 'none';
        const cols = rows.length ? Object.keys(rows[0]) : [];
        tbody.innerHTML = '<tr><th>' + cols.join('</th><th>') + '</th></tr>' + rows.map(row => '<tr>' + cols.map(c => '<td>' + (row[c] != null ? String(row[c]) : '') + '</td>').join('') + '</tr>').join('');
      }
      resultWrap.style.display = 'block';
      const csvBtn = document.getElementById('reportCsvBtn');
      if (_currentReportId === 'export_raw') {
        csvBtn.style.display = 'inline-flex';
        csvBtn.onclick = async () => {
          let url = API + '/api/admin/reports/export_raw.csv?';
          if (dateFrom) url += 'date_from=' + encodeURIComponent(dateFrom) + '&';
          if (dateTo) url += 'date_to=' + encodeURIComponent(dateTo);
          const res = await fetch(url, { headers: authH() });
          if (!res.ok) throw new Error(res.statusText);
          const blob = await res.blob();
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'export_raw.csv';
          a.click();
          URL.revokeObjectURL(a.href);
        };
      } else {
        csvBtn.style.display = 'none';
      }
      document.getElementById('reportSummarizeBtn').onclick = async () => {
        try {
          const p = new URLSearchParams();
          if (document.getElementById('reportDateFrom').value) p.set('date_from', document.getElementById('reportDateFrom').value);
          if (document.getElementById('reportDateTo').value) p.set('date_to', document.getElementById('reportDateTo').value);
          const sumRes = await apiFetch('/api/admin/reports/' + _currentReportId + '/summarize?' + p.toString(), { method: 'POST' });
          const sumEl = document.getElementById('reportSummary');
          sumEl.textContent = sumRes.summary || '‚Äî';
          sumEl.style.display = 'block';
        } catch (e) {
          toast(e.message || '–û—à–∏–±–∫–∞', 'err');
        }
      };
    };
  } catch (e) {
    wrap.innerHTML = '<p style="color:var(--red)">' + e.message + '</p>';
  }
}

// Close modals on backdrop click
document.querySelectorAll('.modal-backdrop').forEach(el => {
  el.addEventListener('click', e => { if (e.target === el) el.classList.remove('open'); });
});

// Init
checkAuth();
</script>
</body>
</html>
