<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Magic Master — профессиональный мастеринг</title>
  <!-- PWA (P49) -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#6c4bff">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Magic Master">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <script>window.__MAGIC_MASTER_DEBUG__=false;</script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* ═══════════════════════ DESIGN TOKENS — MusicTechPro ═══════════════════════ */
    :root {
      /* Фон: глубокий, насыщенный */
      --bg:          #040408;
      --bg-grid:     #08080f;
      --surface:     rgba(10,10,18,0.96);
      --surface-2:   rgba(16,16,28,0.98);
      --surface-3:   rgba(20,20,36,0.95);
      --border:      rgba(255,255,255,0.06);
      --border-soft: rgba(255,255,255,0.04);

      /* Текст */
      --text:        #eeeef8;
      --text-soft:   #8888aa;
      --text-dim:    #44445e;
      --text-mono:   'JetBrains Mono', 'Fira Mono', monospace;

      /* Основные акценты — глубокий фиолетовый */
      --accent:      #7c3aed;
      --accent-2:    #a855f7;
      --accent-3:    #db2777;
      --accent-glow: rgba(124,58,237,0.4);

      /* Статусы и анализ */
      --cyan:        #06b6d4;
      --cyan-glow:   rgba(6,182,212,0.3);
      --green:       #10b981;
      --green-glow:  rgba(16,185,129,0.28);
      --red:         #ef4444;
      --red-glow:    rgba(239,68,68,0.28);
      --amber:       #f59e0b;
      --amber-glow:  rgba(245,158,11,0.28);

      /* PRO-функции — уникальный цвет для каждой */
      --pro-denoiser:      #06b6d4;   /* Spectral Denoiser — циан */
      --pro-denoiser-bg:   rgba(6,182,212,0.06);
      --pro-denoiser-glow: rgba(6,182,212,0.25);
      --pro-deesser:       #10b981;   /* De-esser — изумрудный */
      --pro-deesser-bg:    rgba(16,185,129,0.06);
      --pro-deesser-glow:  rgba(16,185,129,0.25);
      --pro-transient:     #f59e0b;   /* Transient Designer — янтарный */
      --pro-transient-bg:  rgba(245,158,11,0.06);
      --pro-transient-glow:rgba(245,158,11,0.25);
      --pro-parallel:      #ef4444;   /* Parallel Compression — красный */
      --pro-parallel-bg:   rgba(239,68,68,0.06);
      --pro-parallel-glow: rgba(239,68,68,0.25);
      --pro-dynEQ:         #8b5cf6;   /* Dynamic EQ — пурпурный */
      --pro-dynEQ-bg:      rgba(139,92,246,0.06);
      --pro-dynEQ-glow:    rgba(139,92,246,0.25);

      --r-sm: 8px;
      --r:    12px;
      --r-lg: 18px;
      --shadow: 0 6px 40px rgba(0,0,0,0.7), 0 1px 0 rgba(255,255,255,0.03) inset;
      --shadow-sm: 0 2px 16px rgba(0,0,0,0.4);
    }

    /* ═══════════════════════ BASE ═══════════════════════ */
    *, *::before, *::after { box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    /* a11y: видимый фокус для навигации с клавиатуры */
    button:focus-visible, a:focus-visible, [tabindex]:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    body {
      font-family: 'Space Grotesk', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 1rem 4rem;
      overflow-x: hidden;
    }

    /* ═══════════════════════ BACKGROUND ═══════════════════════ */
    .bg-layer {
      position: fixed; inset: 0; pointer-events: none; z-index: 0;
    }
    .bg-layer::before {
      content: '';
      position: absolute; inset: 0;
      background:
        radial-gradient(ellipse 90% 55% at 15% -5%,  rgba(108,75,255,0.13) 0%, transparent 55%),
        radial-gradient(ellipse 65% 45% at 85% 105%, rgba(34,211,238,0.07) 0%, transparent 55%),
        linear-gradient(180deg, var(--bg-grid) 0%, var(--bg) 100%);
    }
    .bg-layer::after {
      content: '';
      position: absolute; inset: 0;
      background-image:
        linear-gradient(rgba(255,255,255,0.016) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.016) 1px, transparent 1px);
      background-size: 44px 44px;
    }

    /* ═══════════════════════ LAYOUT ═══════════════════════ */
    .page { width: 100%; max-width: 520px; position: relative; z-index: 1; }

    /* ═══════════════════════ HEADER ═══════════════════════ */
    .header { position: relative; padding: 2.75rem 0 1.75rem; text-align: center; }
    .logo {
      display: inline-flex; align-items: center; gap: 0.55rem;
      margin-bottom: 1.1rem;
    }
    .logo-icon {
      width: 36px; height: 36px; border-radius: 10px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 18px var(--accent-glow), 0 2px 8px rgba(0,0,0,0.4);
      flex-shrink: 0;
    }
    .logo-icon svg { width: 18px; height: 18px; color: #fff; }
    .logo-name {
      font-size: 1.25rem; font-weight: 700; letter-spacing: -0.03em;
      background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.65) 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .logo-badge {
      font-size: 0.58rem; font-weight: 700; letter-spacing: 0.1em;
      color: var(--accent); background: rgba(108,75,255,0.14);
      border: 1px solid rgba(108,75,255,0.3); border-radius: 4px;
      padding: 1px 5px; text-transform: uppercase; align-self: flex-start; margin-top: 3px;
    }
    .h-title {
      font-size: 1.85rem; font-weight: 700; letter-spacing: -0.04em;
      line-height: 1.15; margin: 0 0 0.45rem;
      background: linear-gradient(135deg, #fff 25%, rgba(255,255,255,0.5) 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .h-sub { font-size: 0.88rem; color: var(--text-soft); line-height: 1.6; max-width: 340px; margin: 0 auto; }

    /* Waveform decoration */
    .wdeco {
      display: flex; align-items: center; justify-content: center; gap: 3px;
      height: 26px; margin: 1.1rem auto 0;
    }
    .wdeco .b {
      width: 3px; border-radius: 2px;
      background: linear-gradient(180deg, var(--accent-2), var(--accent));
      animation: wIdle 2s ease-in-out infinite;
    }
    .wdeco .b:nth-child(1)  { height:7px;  animation-delay:0s }
    .wdeco .b:nth-child(2)  { height:14px; animation-delay:.1s }
    .wdeco .b:nth-child(3)  { height:20px; animation-delay:.2s }
    .wdeco .b:nth-child(4)  { height:26px; animation-delay:.3s }
    .wdeco .b:nth-child(5)  { height:18px; animation-delay:.12s }
    .wdeco .b:nth-child(6)  { height:11px; animation-delay:.22s }
    .wdeco .b:nth-child(7)  { height:22px; animation-delay:.05s }
    .wdeco .b:nth-child(8)  { height:17px; animation-delay:.32s }
    .wdeco .b:nth-child(9)  { height:13px; animation-delay:.08s }
    .wdeco .b:nth-child(10) { height:8px;  animation-delay:.38s }
    .wdeco .b:nth-child(11) { height:6px;  animation-delay:.18s }
    .wdeco .b:nth-child(12) { height:16px; animation-delay:.0s }
    .wdeco .b:nth-child(13) { height:24px; animation-delay:.28s }
    .wdeco .b:nth-child(14) { height:15px; animation-delay:.14s }
    .wdeco .b:nth-child(15) { height:9px;  animation-delay:.24s }
    @keyframes wIdle {
      0%,100% { transform:scaleY(.45); opacity:.3 }
      50%      { transform:scaleY(1);  opacity:.6 }
    }
    .wdeco.active .b { animation: wActive .55s ease-in-out infinite alternate; }
    .wdeco.active .b:nth-child(odd)  { animation-duration:.38s }
    .wdeco.active .b:nth-child(even) { animation-duration:.52s }
    @keyframes wActive {
      0%   { transform:scaleY(.25); opacity:.55 }
      100% { transform:scaleY(1);   opacity:1   }
    }

    /* ═══════════════════════ CARD ═══════════════════════ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      padding: 1.65rem;
      width: 100%;
      margin-bottom: 1.1rem;
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .card-hd {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 1.15rem;
    }
    .card-hd-left { display: flex; align-items: center; gap: 0.55rem; }
    .card-ico {
      width: 26px; height: 26px; border-radius: var(--r-sm);
      background: rgba(108,75,255,0.13); border: 1px solid rgba(108,75,255,0.22);
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .card-ico svg { width: 13px; height: 13px; color: var(--accent); }
    .card-ttl {
      font-size: 0.72rem; font-weight: 700; letter-spacing: 0.09em;
      text-transform: uppercase; color: var(--text-dim);
    }

    /* ═══════════════════════ DROPZONE ═══════════════════════ */
    .drop {
      border: 1.5px dashed rgba(108,75,255,0.28);
      border-radius: var(--r);
      padding: 2rem 1.5rem;
      text-align: center; cursor: pointer;
      transition: all .22s ease; position: relative; overflow: hidden;
    }
    .drop::before {
      content:''; position:absolute; inset:0;
      background: radial-gradient(ellipse at center, rgba(108,75,255,0.05) 0%, transparent 70%);
      opacity:0; transition:opacity .22s;
    }
    .drop:hover::before, .drop.over::before { opacity:1 }
    .drop:hover, .drop.over {
      border-color: var(--accent); border-style: solid;
      box-shadow: 0 0 0 3px var(--accent-glow), inset 0 0 18px rgba(108,75,255,0.04);
    }
    .drop.has-file { border-color: rgba(52,211,153,0.35); border-style: solid; }
    .drop input { display:none }
    .drop-ico {
      width: 46px; height: 46px; border-radius: 13px; margin: 0 auto .9rem;
      background: linear-gradient(135deg,rgba(108,75,255,0.18),rgba(168,85,247,0.12));
      border: 1px solid rgba(108,75,255,0.22);
      display:flex; align-items:center; justify-content:center;
      transition: transform .2s, box-shadow .2s;
    }
    .drop:hover .drop-ico { transform:translateY(-2px); box-shadow:0 8px 22px var(--accent-glow) }
    .drop-ico svg { width:21px; height:21px; color:var(--accent) }
    .drop-title { font-size:.88rem; font-weight:500; margin:0 0 .28rem }
    .drop-hint  { font-size:.76rem; color:var(--text-dim); margin:0 }
    .drop-fmts  { display:flex; gap:.35rem; justify-content:center; margin-top:.8rem; flex-wrap:wrap }
    .fmt-tag {
      font-family:'JetBrains Mono',monospace; font-size:.62rem; font-weight:600;
      letter-spacing:.05em; color:var(--text-dim);
      background:rgba(255,255,255,0.04); border:1px solid var(--border);
      border-radius:5px; padding:2px 7px;
    }

    /* File info badge */
    .file-info {
      display:none; align-items:center; gap:.6rem;
      margin-top:.9rem; padding:.55rem .8rem;
      background:rgba(52,211,153,0.08); border:1px solid rgba(52,211,153,0.22);
      border-radius:var(--r-sm);
    }
    .file-info.visible { display:flex }
    .file-info-icon svg { width:14px;height:14px;color:var(--green);flex-shrink:0 }
    .file-info-name {
      font-size:.82rem; font-weight:500; color:var(--green);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1;
    }
    .file-info-meta { font-family:'JetBrains Mono',monospace; font-size:.7rem; color:var(--text-dim); white-space:nowrap }
    .btn-reset {
      background:none; border:none; cursor:pointer; padding:3px;
      color:var(--text-dim); transition:color .15s; flex-shrink:0;
      display:flex; align-items:center;
    }
    .btn-reset:hover { color:var(--red) }
    .btn-reset svg { width:13px;height:13px }

    /* ═══════════════════════ BATCH ═══════════════════════ */
    .batch-section {
      margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);
    }
    .batch-hd { display: flex; align-items: baseline; gap: .5rem; margin-bottom: .5rem; flex-wrap: wrap; }
    .batch-ttl { font-size: .7rem; font-weight: 700; letter-spacing: .08em; text-transform: uppercase; color: var(--text-dim); }
    .batch-hint { font-size: .7rem; color: var(--text-dim); }
    .btn-batch {
      font-size: .78rem; padding: .4rem .75rem;
      background: rgba(108,75,255,.1); border: 1px solid rgba(108,75,255,.25);
      color: var(--accent); border-radius: var(--r-sm); cursor: pointer;
      transition: background .15s, border-color .15s;
    }
    .btn-batch:hover { background: rgba(108,75,255,.18); border-color: rgba(108,75,255,.4); }
    .batch-file-list {
      font-size: .75rem; color: var(--text-soft); margin-top: .5rem;
      max-height: 80px; overflow-y: auto;
    }
    .batch-file-list span { display: block; padding: .15rem 0; }
    .btn-batch-run { margin-top: .5rem; }
    .batch-panel {
      margin-top: 1rem; padding: 1rem;
      background: rgba(0,0,0,.2); border: 1px solid var(--border); border-radius: var(--r);
    }
    .batch-panel-title { font-size: .7rem; font-weight: 700; letter-spacing: .06em; color: var(--text-dim); margin-bottom: .6rem; }
    .batch-job-row {
      display: flex; align-items: center; gap: .6rem; padding: .4rem 0;
      border-bottom: 1px solid rgba(255,255,255,.05); font-size: .8rem;
    }
    .batch-job-row:last-child { border-bottom: none; }
    .batch-job-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text-soft); }
    .batch-job-progress { width: 60px; text-align: right; color: var(--text-dim); font-size: .75rem; }
    .batch-job-dl {
      font-size: .72rem; color: var(--accent); cursor: pointer; text-decoration: none;
    }
    .batch-job-dl:hover { text-decoration: underline; }
    .batch-job-dl.done { color: var(--green); }

    /* ═══════════════════════ VU METER ═══════════════════════ */
    .meter-wrap { margin-top:1.2rem }
    .meter-top  { display:flex; justify-content:space-between; align-items:baseline; margin-bottom:.55rem }
    .meter-lbl  { font-size:.7rem;font-weight:700;letter-spacing:.09em;text-transform:uppercase;color:var(--text-dim) }
    .meter-val  {
      font-family:'JetBrains Mono',monospace; font-size:1.3rem; font-weight:600;
      color:var(--accent); transition:color .3s; line-height:1;
    }
    .meter-val.empty { color:var(--text-dim) }
    .meter-val.good  { color:var(--green) }
    .meter-val.warn  { color:var(--amber) }
    .meter-val.hot   { color:var(--red)   }
    .vu {
      display:flex; gap:2px; align-items:flex-end; height:11px;
    }
    .vu-s {
      flex:1; height:100%; border-radius:2px;
      background:rgba(255,255,255,0.05); transition:background .12s,box-shadow .12s;
    }
    .vu-s.g { background:var(--green); box-shadow:0 0 5px var(--green-glow) }
    .vu-s.a { background:var(--amber); box-shadow:0 0 5px rgba(251,191,36,.35) }
    .vu-s.r { background:var(--red);   box-shadow:0 0 5px var(--red-glow) }
    .vu-scale { display:flex;justify-content:space-between;margin-top:.28rem }
    .vu-scale span { font-family:'JetBrains Mono',monospace;font-size:.58rem;color:var(--text-dim) }
    .meter-correlation { display:none; margin-top:.4rem; font-family:'JetBrains Mono',monospace; font-size:.7rem; color:var(--text-dim) }
    .meter-correlation.visible { display:block }
    .lufs-timeline-wrap { display:none; margin-top:.75rem; }
    .lufs-timeline-wrap.visible { display:block; animation:fadeIn .35s ease }
    .lufs-timeline-lbl { font-size:.65rem; font-weight:700; letter-spacing:.06em; text-transform:uppercase; color:var(--text-dim); margin-bottom:.35rem }
    .lufs-timeline-canvas { width:100%; height:56px; border-radius:var(--r-sm); background:rgba(0,0,0,0.25); display:block }

    /* ═══════════════════════ SETTINGS ═══════════════════════ */
    .settings { display:grid; gap:.7rem }
    .field { display:flex;flex-direction:column;gap:.38rem }
    .f-lbl { font-size:.7rem;font-weight:700;letter-spacing:.09em;text-transform:uppercase;color:var(--text-dim) }
    select, input[type="number"] {
      width:100%; background:rgba(0,0,0,0.35); border:1px solid var(--border);
      color:var(--text); padding:.6rem .8rem; border-radius:var(--r-sm);
      font-family:'Space Grotesk',system-ui,sans-serif; font-size:.88rem;
      outline:none; appearance:none; -webkit-appearance:none; transition:border-color .18s,box-shadow .18s;
    }
    select {
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2352527a' stroke-width='1.5' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:right .8rem center;
      padding-right:2.4rem; cursor:pointer;
    }
    select:focus, input[type="number"]:focus {
      border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow);
    }
    select option { background:#12121e }
    input[type="number"] { font-family:'JetBrains Mono',monospace;font-weight:600;text-align:center }
    .custom-field { display:none }
    .custom-field.on { display:block }

    /* Preset badges */
    .preset-badges { display:flex;gap:.4rem;flex-wrap:wrap;margin-top:.38rem }
    .pbadge {
      font-size:.65rem;font-weight:600;padding:2px 8px;border-radius:5px;
      letter-spacing:.04em;opacity:.55;transition:opacity .15s;cursor:default;
    }
    .pbadge.on { opacity:1 }
    .pb-s { background:rgba(52,211,153,.1); color:var(--green); border:1px solid rgba(52,211,153,.25) }
    .pb-a { background:rgba(34,211,238,.1); color:var(--cyan);  border:1px solid rgba(34,211,238,.2) }
    .pb-c { background:rgba(251,191,36,.1); color:var(--amber); border:1px solid rgba(251,191,36,.2) }

    .two-col { display:grid;grid-template-columns:1fr 1fr;gap:.7rem }
    .export-opts .export-opt { display:flex;flex-direction:column;gap:.25rem }
    .export-opts .export-opt-lbl { font-size:.65rem; color:var(--text-dim); text-transform:uppercase; letter-spacing:.05em }

    /* ═══════════════════════ PIPELINE STEPS ═══════════════════════ */
    .pipeline {
      display:none;flex-direction:column;gap:.28rem;margin-top:1rem;
    }
    .pipeline.visible { display:flex }
    .pipe-step {
      display:flex; align-items:center; gap:.55rem;
      font-size:.78rem; color:var(--text-dim);
      padding:.35rem .6rem; border-radius:var(--r-sm);
      transition:background .2s, color .2s;
    }
    .pipe-step.active  { color:var(--text); background:rgba(108,75,255,0.1) }
    .pipe-step.done    { color:var(--green) }
    .pipe-step-dot {
      width:7px;height:7px;border-radius:50%;background:currentColor;
      flex-shrink:0;opacity:.5;
    }
    .pipe-step.active .pipe-step-dot {
      opacity:1; animation:pipePulse .9s ease-in-out infinite;
      background:var(--accent);
    }
    .pipe-step.done .pipe-step-dot { opacity:1 }
    @keyframes pipePulse {
      0%,100% { transform:scale(1) }
      50%      { transform:scale(1.6) }
    }
    .pipe-step-label { flex:1 }
    .pipe-step-check { font-size:.7rem;opacity:0 }
    .pipe-step.done .pipe-step-check { opacity:1 }

    /* ═══════════════════════ BEFORE/AFTER ═══════════════════════ */
    .result-panel {
      display:none;margin-top:1.1rem;
      background:rgba(52,211,153,0.06);
      border:1px solid rgba(52,211,153,0.18);
      border-radius:var(--r);
      padding:1rem 1.15rem;
      animation:fadeIn .4s ease;
    }
    .result-panel.visible { display:block }
    @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none} }

    /* ═══════════ A/B AUDIO PLAYER (P45) ═══════════ */
    .ab-player-wrap{display:none;margin-top:1rem;background:rgba(108,75,255,.06);border:1px solid rgba(108,75,255,.18);border-radius:var(--r);padding:1rem 1.15rem;animation:fadeIn .4s ease}
    .ab-player-wrap.visible{display:block}
    .ab-player-title{font-size:.72rem;text-transform:uppercase;letter-spacing:.07em;color:var(--text-soft);margin-bottom:.7rem;display:flex;align-items:center;gap:.5rem}
    .ab-player-title svg{opacity:.6}
    .ab-player-controls{display:flex;align-items:center;gap:.7rem;flex-wrap:wrap}
    .ab-play-btn{width:2.2rem;height:2.2rem;border-radius:50%;border:none;cursor:pointer;background:linear-gradient(135deg,#6c4bff,#a855f7);display:flex;align-items:center;justify-content:center;color:#fff;transition:opacity .15s;flex-shrink:0}
    .ab-play-btn:hover{opacity:.85}
    .ab-play-btn svg{width:14px;height:14px}
    .ab-progress-wrap{flex:1;min-width:100px;position:relative;height:6px;background:rgba(255,255,255,.1);border-radius:3px;cursor:pointer}
    .ab-progress-fill{position:absolute;top:0;left:0;height:100%;border-radius:3px;background:linear-gradient(90deg,#6c4bff,#a855f7);width:0;pointer-events:none;transition:width .1s linear}
    .ab-time{font-size:.72rem;color:var(--text-soft);font-family:var(--mono);white-space:nowrap}
    .ab-switch{display:flex;gap:.35rem;margin-left:auto}
    .ab-switch-btn{padding:.25rem .65rem;border-radius:5px;border:1px solid var(--border);background:transparent;color:var(--text-soft);font-size:.75rem;font-weight:700;cursor:pointer;transition:all .15s;font-family:inherit}
    .ab-switch-btn.active{background:rgba(108,75,255,.25);border-color:rgba(108,75,255,.5);color:#c4b5fd}
    .ab-vol-wrap{display:flex;align-items:center;gap:.4rem;font-size:.72rem;color:var(--text-soft)}
    .ab-vol-wrap input[type=range]{width:64px;accent-color:#6c4bff;cursor:pointer}
    .result-title {
      font-size:.7rem;font-weight:700;letter-spacing:.09em;text-transform:uppercase;
      color:var(--green);margin-bottom:.75rem;
      display:flex;align-items:center;gap:.4rem;
    }
    .result-title svg { width:13px;height:13px }
    .result-grid { display:grid;grid-template-columns:1fr auto 1fr;gap:.5rem;align-items:center }
    .result-block { text-align:center }
    .result-block-lbl { font-size:.65rem;font-weight:600;letter-spacing:.07em;text-transform:uppercase;color:var(--text-dim);margin-bottom:.3rem }
    .result-block-val {
      font-family:'JetBrains Mono',monospace;font-size:1.5rem;font-weight:600;line-height:1;
    }
    .result-block-val.before { color:var(--text-soft) }
    .result-block-val.after  { color:var(--green) }
    .result-arrow {
      display:flex;align-items:center;justify-content:center;
      color:var(--accent);opacity:.7;
    }
    .result-arrow svg { width:18px;height:18px }
    .result-delta {
      text-align:center;margin-top:.65rem;padding-top:.65rem;
      border-top:1px solid rgba(52,211,153,0.12);
      font-size:.78rem;color:var(--text-soft);
    }
    .result-delta strong { color:var(--green) }

    /* ═══════════════════════ PROGRESS ═══════════════════════ */
    .prog-wrap { margin-top:1.1rem;display:none }
    .prog-wrap.on { display:block }
    .prog-hd { display:flex;justify-content:space-between;align-items:center;margin-bottom:.45rem }
    .prog-msg { font-size:.8rem;color:var(--text-soft) }
    .prog-pct { font-family:'JetBrains Mono',monospace;font-size:.8rem;font-weight:600;color:var(--accent) }
    .prog-track { height:5px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden }
    .prog-fill {
      height:100%;width:0%;border-radius:3px;
      background:linear-gradient(90deg,var(--accent),var(--accent-2),var(--cyan));
      background-size:200% 100%;
      transition:width .25s ease;
      animation:shimmer 2s linear infinite;
      position:relative;
    }
    .prog-fill::after {
      content:'';position:absolute;top:0;right:0;width:28px;height:100%;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,0.45));
    }
    @keyframes shimmer { 0%{background-position:0 0} 100%{background-position:200% 0} }

    /* ═══════════════════════ BUTTONS ═══════════════════════ */
    .btn {
      width:100%;padding:.82rem 1.4rem;border:none;border-radius:var(--r-sm);
      font-family:'Space Grotesk',system-ui,sans-serif;font-size:.88rem;
      font-weight:600;letter-spacing:.02em;cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:.5rem;
      transition:all .18s;position:relative;overflow:hidden;
    }
    .btn::after { content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,0.06) 0%,transparent 100%);pointer-events:none }
    .btn:active:not(:disabled) { transform:scale(.99) }
    .btn svg { width:15px;height:15px;flex-shrink:0 }
    .btn:disabled { opacity:.38;cursor:not-allowed;pointer-events:none }

    .btn-secondary {
      background:rgba(255,255,255,0.05);color:var(--text);
      border:1px solid var(--border);margin-top:.9rem;
    }
    .btn-secondary:hover:not(:disabled) { background:rgba(255,255,255,0.09);border-color:rgba(255,255,255,0.13) }
    .btn-sm { font-size:.78rem; padding:.4rem .7rem; margin-top:.4rem }
    .btn-report { margin-left:.5rem; display:inline-flex; align-items:center; gap:.35rem }
    .report-actions { display:inline-flex; align-items:center; gap:.4rem; margin-left:.5rem }
    .btn-report-json { font-size:.7rem; padding:.25rem .5rem; background:rgba(255,255,255,0.06); border:1px solid var(--border); border-radius:6px; color:var(--text-soft); cursor:pointer }
    .btn-report-json:hover { background:rgba(255,255,255,0.1); color:var(--text) }
    .btn-ai-report { margin-left:.4rem; font-size:.78rem; padding:.35rem .6rem; background:rgba(124,58,237,0.2); border:1px solid rgba(124,58,237,0.4); color:var(--accent-2); cursor:pointer; border-radius:6px }
    .btn-ai-report:hover { background:rgba(124,58,237,0.35); color:#fff }
    .ai-report-result { margin-top:.6rem; padding:.6rem .8rem; background:rgba(16,16,28,0.6); border:1px solid var(--border); border-radius:var(--r); font-size:.85rem; color:var(--text-soft) }
    .ai-report-result .ai-report-summary { margin-bottom:.4rem }
    .ai-report-result .ai-report-recs { margin:0; padding-left:1.2rem; color:var(--text) }

    .ai-actions-wrap .ai-actions { display:flex; align-items:center; gap:.5rem; flex-wrap:wrap }
    .ai-actions-wrap .btn-ai { display:inline-flex; align-items:center; gap:.35rem; background:rgba(124,58,237,0.2); border:1px solid rgba(124,58,237,0.5); color:var(--accent-2); font-size:.8rem }
    .ai-actions-wrap .btn-ai:hover { background:rgba(124,58,237,0.3); color:#fff }
    .ai-actions-wrap .btn-ai-icon { font-size:.9em }
    .ai-actions-wrap .ai-limits { font-size:.75rem; color:var(--text-dim); margin-left:.5rem }

    /* AI помощники — секция в первой карточке */
    .ai-helpers-section { margin-top:1.2rem; padding:1rem 1rem 1rem; background:linear-gradient(135deg,rgba(124,58,237,0.12),rgba(168,85,247,0.06)); border:1px solid rgba(124,58,237,0.35); border-radius:var(--r); }
    .ai-helpers-title { display:flex; align-items:center; gap:.5rem; font-size:1rem; font-weight:600; color:var(--accent-2); margin-bottom:.35rem }
    .ai-helpers-icon { font-size:1.2em }
    .ai-helpers-desc { font-size:.82rem; color:var(--text-soft); margin:0 0 .75rem; line-height:1.4 }
    .ai-helpers-btns { display:flex; flex-wrap:wrap; gap:.5rem; margin-bottom:.6rem }
    .btn-ai-primary { display:inline-flex; align-items:center; gap:.4rem; padding:.5rem .9rem; font-size:.85rem; font-weight:500; background:var(--accent); color:#fff; border:none; border-radius:8px; cursor:pointer; transition:background .15s, transform .1s }
    .btn-ai-primary:hover { background:var(--accent-2); transform:translateY(-1px) }
    .btn-ai-primary .btn-ai-icon { font-size:1em }
    .ai-helpers-more { font-size:.75rem; color:var(--text-dim); line-height:1.4 }
    .ai-helpers-more strong { color:var(--text-soft) }
    .ai-helpers-limits { font-size:.75rem; color:var(--text-soft); margin-top:.4rem }
    .ai-helpers-chat-row { display:flex; align-items:center; gap:.6rem; flex-wrap:wrap; margin-top:.6rem }
    .btn-ai-outline { display:inline-flex; align-items:center; gap:.4rem; padding:.4rem .75rem; font-size:.82rem; background:transparent; color:var(--accent-2); border:1px solid rgba(124,58,237,.5); border-radius:8px; cursor:pointer; transition:.15s }
    .btn-ai-outline:hover { background:rgba(124,58,237,.15); color:#fff }
    .ai-fab-hint { font-size:.72rem; color:var(--text-dim) }

    /* P25: NL→настройки */
    .nl-config-wrap { margin-top:.8rem; padding:.7rem .9rem; background:rgba(124,58,237,.07); border:1px solid rgba(124,58,237,.25); border-radius:var(--r) }
    .nl-config-label { font-size:.75rem; color:var(--accent-2); margin-bottom:.4rem; font-weight:600 }
    .nl-config-inline .nl-inline-desc { font-size:.78rem; color:var(--text-soft); margin:0 0 .5rem; line-height:1.35 }
    .nl-config-inline .nl-config-row { display:flex; gap:.5rem; align-items:center }
    .nl-config-inline .nl-config-row input { flex:1; background:rgba(255,255,255,.05); border:1px solid var(--border); border-radius:6px; color:var(--text); padding:.4rem .7rem; font-size:.84rem }
    .nl-config-inline .nl-config-row input:focus { border-color:var(--accent); outline:none }
    .nl-config-row { display:flex; gap:.5rem; align-items:center }
    .nl-config-row input { flex:1; background:rgba(255,255,255,.05); border:1px solid var(--border); border-radius:6px; color:var(--text); padding:.4rem .7rem; font-size:.84rem; outline:none }
    .nl-config-row input:focus { border-color:var(--accent) }
    .btn-nl { font-size:.78rem; padding:.4rem .8rem; background:rgba(124,58,237,.2); border:1px solid rgba(124,58,237,.5); color:var(--accent-2); border-radius:6px; cursor:pointer; white-space:nowrap }
    .btn-nl:hover { background:rgba(124,58,237,.35); color:#fff }
    .btn-nl:disabled { opacity:.4; cursor:not-allowed }

    /* P24: Chat panel */
    .chat-fab { position:fixed; bottom:1.5rem; right:1.5rem; z-index:200; width:52px; height:52px; border-radius:50%; background:var(--accent); border:none; cursor:pointer; display:none; align-items:center; justify-content:center; box-shadow:0 4px 20px rgba(124,58,237,.5); transition:.2s }
    .chat-fab.visible { display:flex !important; }
    .chat-fab:hover { background:var(--accent-2); transform:scale(1.08) }
    .chat-fab svg { width:24px; height:24px; color:#fff }
    .chat-panel { position:fixed; bottom:5rem; right:1.5rem; z-index:120; width:340px; max-width:calc(100vw - 2rem); background:var(--surface); border:1px solid var(--border); border-radius:var(--r); display:none; flex-direction:column; box-shadow:0 8px 32px rgba(0,0,0,.5); overflow:hidden }
    .chat-panel.open { display:flex }
    .chat-panel-hd { padding:.7rem 1rem; background:rgba(124,58,237,.15); border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between }
    .chat-panel-hd span { font-size:.88rem; font-weight:600; color:var(--accent-2) }
    .chat-panel-hd button { background:none; border:none; color:var(--text-soft); cursor:pointer; font-size:1.1rem; line-height:1 }
    .chat-pro-notice { padding:.5rem .7rem; font-size:.78rem; color:var(--text-soft); background:rgba(124,58,237,0.08); border-bottom:1px solid var(--border) }
    .chat-pro-notice .chat-pro-link { color:var(--accent-2); text-decoration:underline }
    .chat-msgs { flex:1; overflow-y:auto; max-height:320px; padding:.7rem; display:flex; flex-direction:column; gap:.5rem }
    .chat-msg { padding:.5rem .7rem; border-radius:8px; font-size:.82rem; line-height:1.45; max-width:85%; word-break:break-word }
    .chat-msg.user { background:rgba(124,58,237,.25); align-self:flex-end; color:var(--text) }
    .chat-msg.assistant { background:rgba(255,255,255,.05); align-self:flex-start; color:var(--text-soft) }
    .chat-msg.system { background:transparent; color:var(--text-dim); font-size:.75rem; align-self:center; font-style:italic }
    .chat-input-row { padding:.6rem; border-top:1px solid var(--border); display:flex; gap:.4rem }
    .chat-input-row input { flex:1; background:rgba(255,255,255,.06); border:1px solid var(--border); border-radius:6px; color:var(--text); padding:.4rem .7rem; font-size:.82rem; outline:none }
    .chat-input-row input:focus { border-color:var(--accent) }
    .chat-send-btn { padding:.4rem .7rem; background:var(--accent); border:none; border-radius:6px; color:#fff; cursor:pointer; font-size:.82rem }
    .chat-send-btn:hover { background:var(--accent-2) }
    .chat-send-btn:disabled { opacity:.4; cursor:not-allowed }

    .btn-primary {
      background:linear-gradient(135deg,var(--accent) 0%,var(--accent-2) 100%);
      color:#fff;margin-top:.9rem;font-size:.92rem;padding:.95rem 1.4rem;
      box-shadow:0 4px 20px var(--accent-glow);
    }
    .btn-primary:hover:not(:disabled) {
      box-shadow:0 7px 28px rgba(108,75,255,.55),0 2px 8px rgba(0,0,0,.3);
      transform:translateY(-1px);
    }
    .btn-primary.processing {
      background:linear-gradient(135deg,rgba(108,75,255,.6),rgba(168,85,247,.6));
      pointer-events:none;
    }

    /* ═══════════════════════ STATUS ═══════════════════════ */
    .status {
      font-size:.8rem;margin-top:.65rem;min-height:1rem;
      display:flex;align-items:center;gap:.38rem;color:var(--text-soft);
    }
    .status::before { content:'';display:none;width:6px;height:6px;border-radius:50%;flex-shrink:0 }
    .status.ok::before  { display:block;background:var(--green);box-shadow:0 0 6px var(--green-glow) }
    .status.err::before { display:block;background:var(--red);box-shadow:0 0 6px var(--red-glow) }
    .status.ok  { color:var(--green) }
    .status.err { color:var(--red) }

    /* ═══════════════════════ WAVEFORM PLAYER ═══════════════════════ */
    .player { display:none; margin-top:1rem; animation:fadeIn .3s ease; }
    .player.visible { display:block }

    .wave-wrap {
      position:relative; border-radius:var(--r-sm); overflow:hidden;
      background:rgba(0,0,0,0.35); border:1px solid var(--border);
      cursor:crosshair; user-select:none;
    }
    .wave-wrap:hover { border-color:rgba(108,75,255,0.3) }
    .wave-canvas { display:block; width:100%; height:58px }

    /* playhead overlay */
    .wave-wrap::after {
      content:attr(data-time);
      position:absolute; top:4px; right:6px;
      font-family:'JetBrains Mono',monospace; font-size:.62rem; font-weight:600;
      color:rgba(255,255,255,0.45); pointer-events:none;
    }

    .transport {
      display:flex; align-items:center; gap:.55rem; margin-top:.55rem;
    }
    .btn-pp {
      width:30px; height:30px; border-radius:50%; flex-shrink:0; border:none; cursor:pointer;
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      display:flex; align-items:center; justify-content:center;
      color:#fff; transition:box-shadow .18s,transform .1s;
      box-shadow:0 2px 12px var(--accent-glow);
    }
    .btn-pp:hover  { box-shadow:0 4px 18px rgba(108,75,255,.6); transform:scale(1.05) }
    .btn-pp:active { transform:scale(.95) }
    .btn-pp svg { width:11px;height:11px }

    .t-elapsed, .t-total {
      font-family:'JetBrains Mono',monospace; font-size:.7rem; white-space:nowrap;
    }
    .t-elapsed { color:var(--text-soft); min-width:2.5rem; text-align:right }
    .t-total   { color:var(--text-dim);  min-width:2.5rem }

    .t-scrub {
      flex:1; height:4px; background:rgba(255,255,255,0.07);
      border-radius:2px; position:relative; cursor:pointer; overflow:hidden;
    }
    .t-scrub-fill {
      height:100%; width:0%; border-radius:2px;
      background:linear-gradient(90deg,var(--accent),var(--accent-2));
      transition:none; pointer-events:none;
    }

    /* peak/duration info row */
    .audio-meta {
      display:none; align-items:center; justify-content:space-between;
      margin-top:.55rem; padding:.4rem .55rem;
      background:rgba(255,255,255,0.03); border:1px solid var(--border);
      border-radius:var(--r-sm);
    }
    .audio-meta.visible { display:flex }
    .am-item { display:flex; flex-direction:column; align-items:center; gap:1px }
    .am-val { font-family:'JetBrains Mono',monospace; font-size:.75rem; font-weight:600; color:var(--text-soft) }
    .am-key { font-size:.6rem; color:var(--text-dim); letter-spacing:.07em; text-transform:uppercase }

    /* ═══════════════════════ DIVIDER ═══════════════════════ */
    .div {
      height:1px;
      background:linear-gradient(90deg,transparent,var(--border) 30%,var(--border) 70%,transparent);
      margin:1.15rem 0;
    }

    /* ═══════════════════════ FOOTER ═══════════════════════ */
    .footer { margin-top:.5rem;text-align:center }
    .specs {
      display:flex;gap:.85rem;justify-content:center;flex-wrap:wrap;margin-bottom:.85rem;
    }
    .spec { display:flex;flex-direction:column;align-items:center;gap:2px }
    .spec-v { font-family:'JetBrains Mono',monospace;font-size:.72rem;font-weight:600;color:var(--text-soft) }
    .spec-k { font-size:.62rem;color:var(--text-dim);letter-spacing:.07em;text-transform:uppercase }
    .foot-txt { font-size:.73rem;color:var(--text-dim);line-height:1.6 }
    .foot-link { color:var(--accent); text-decoration:none }
    .foot-link:hover { text-decoration:underline }
    .foot-version { color:var(--text-dim); font-size:.7rem; font-family:'JetBrains Mono',monospace; }

    /* ═══════════════════════ STYLE CARDS ═══════════════════════ */
    .style-grid {
      display: grid; grid-template-columns: repeat(3,1fr); gap: .55rem;
      margin-bottom: .7rem;
    }
    /* House badge — Ozone 5 Exciter + Imager активны */
    .sc-ozone-badge {
      display: inline-block; font-size: .52rem; font-weight: 700;
      letter-spacing: .04em; text-transform: uppercase;
      padding: 1px 5px; border-radius: 3px; margin-top: .18rem;
      background: rgba(251,146,60,.12); color: #fb923c;
      border: 1px solid rgba(251,146,60,.3);
    }
    .style-card {
      border: 1px solid var(--border); border-radius: var(--r-sm);
      padding: .6rem .5rem .55rem; cursor: pointer; text-align: center;
      background: rgba(0,0,0,0.2); transition: all .18s; user-select: none;
      position: relative; overflow: hidden;
    }
    .style-card::before {
      content:''; position:absolute; inset:0;
      background: var(--sc-color, rgba(108,75,255,.08));
      opacity:0; transition:opacity .18s;
    }
    .style-card:hover::before { opacity:1 }
    .style-card.active {
      border-color: var(--sc-active-border, var(--accent));
      background: var(--sc-bg, rgba(108,75,255,.1));
      box-shadow: 0 0 0 2px var(--sc-glow, var(--accent-glow));
    }
    .style-card.active::before { opacity:1 }
    .sc-icon { font-size:1.3rem; line-height:1; margin-bottom:.22rem }
    .sc-name {
      font-size:.72rem; font-weight:700; letter-spacing:.02em; color:var(--text);
      white-space:nowrap;
    }
    .sc-lufs {
      font-family:'JetBrains Mono',monospace; font-size:.62rem;
      color:var(--text-dim); margin-top:.18rem; white-space:nowrap;
    }
    .style-card.active .sc-lufs { color:var(--sc-active-border, var(--accent)) }

    /* ═══════════════════════ A/B TOGGLE ═══════════════════════ */
    .ab-wrap {
      display:none; gap:.35rem; margin-left:.2rem; align-items:center;
    }
    .ab-wrap.visible { display:flex }
    .ab-item { display:flex; align-items:center; gap:.25rem; flex-shrink:0 }
    .ab-lufs {
      font-family:'JetBrains Mono',monospace; font-size:.6rem; color:var(--text-dim);
      min-width:3.2em; white-space:nowrap;
    }
    .ab-item:first-child .ab-lufs { color:rgba(108,75,255,.9) }
    .ab-item:last-child .ab-lufs { color:var(--green) }
    .btn-ab {
      width:26px; height:26px; border-radius:6px; border:1px solid var(--border);
      background:rgba(255,255,255,0.05); cursor:pointer;
      font-family:'JetBrains Mono',monospace; font-size:.72rem; font-weight:700;
      color:var(--text-dim); transition:all .15s; display:flex;
      align-items:center; justify-content:center;
    }
    .btn-ab.active {
      background:var(--ab-bg, rgba(52,211,153,.15));
      border-color:var(--ab-border, rgba(52,211,153,.4));
      color:var(--ab-color, var(--green));
      box-shadow:0 0 8px var(--ab-glow, var(--green-glow));
    }
    #btnAB-a { --ab-bg:rgba(108,75,255,.15);--ab-border:rgba(108,75,255,.4);--ab-color:var(--accent);--ab-glow:var(--accent-glow) }
    #btnAB-b { --ab-bg:rgba(52,211,153,.15);--ab-border:rgba(52,211,153,.4);--ab-color:var(--green);--ab-glow:var(--green-glow) }
    .ab-label {
      font-size:.62rem; color:var(--text-dim); align-self:center;
      white-space:nowrap; padding-left:.15rem;
    }

    /* ═══════════════════════ TOASTS ═══════════════════════ */
    .toast-wrap {
      position:fixed; bottom:1.5rem; right:1.25rem; z-index:999;
      display:flex; flex-direction:column-reverse; gap:.5rem;
      pointer-events:none;
    }
    .toast {
      display:flex; align-items:center; gap:.55rem;
      padding:.55rem .9rem; border-radius:10px;
      font-size:.82rem; font-weight:500; max-width:280px;
      backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px);
      pointer-events:auto; cursor:default;
      animation:toastIn .3s cubic-bezier(.34,1.56,.64,1);
      box-shadow:0 4px 24px rgba(0,0,0,0.4);
    }
    .toast.out { animation:toastOut .25s ease forwards }
    .toast svg { width:14px;height:14px;flex-shrink:0 }
    .toast-ok  { background:rgba(20,40,30,0.92);  color:var(--green); border:1px solid rgba(52,211,153,.3) }
    .toast-err { background:rgba(40,16,16,0.92);  color:var(--red);   border:1px solid rgba(248,113,113,.3) }
    .toast-inf { background:rgba(16,16,40,0.92);  color:var(--text-soft); border:1px solid rgba(108,75,255,.3) }
    @keyframes toastIn  { from{opacity:0;transform:translateY(12px) scale(.94)} to{opacity:1;transform:none} }
    @keyframes toastOut { to  {opacity:0;transform:translateY(8px)  scale(.96)} }

    /* ═══════════════════════ PAGE-WIDE DROP OVERLAY ═══════════════════════ */
    .drop-overlay {
      display:none; position:fixed; inset:0; z-index:900;
      background:rgba(8,8,16,0.82); backdrop-filter:blur(4px);
      align-items:center; justify-content:center; flex-direction:column; gap:1rem;
    }
    .drop-overlay.visible { display:flex }
    .drop-overlay-box {
      width:260px; padding:2.5rem 2rem; text-align:center;
      border:2px dashed var(--accent); border-radius:var(--r-lg);
      background:rgba(108,75,255,0.08);
      animation:pulseBox 1.2s ease-in-out infinite alternate;
    }
    .drop-overlay-box svg { width:40px;height:40px;color:var(--accent);margin-bottom:.75rem }
    .drop-overlay-txt { font-size:.95rem;font-weight:600;color:var(--text) }
    .drop-overlay-hint{ font-size:.78rem;color:var(--text-soft);margin-top:.3rem }
    @keyframes pulseBox { from{box-shadow:0 0 0 0 var(--accent-glow)} to{box-shadow:0 0 30px 8px var(--accent-glow)} }

    /* ═══════════════════════ HISTORY CARD ═══════════════════════ */
    .hist-card {
      width:100%; margin-bottom:1.1rem;
      background:var(--surface); border:1px solid var(--border);
      border-radius:var(--r-lg); overflow:hidden;
      box-shadow:var(--shadow); backdrop-filter:blur(14px); -webkit-backdrop-filter:blur(14px);
    }
    .hist-head {
      display:flex; align-items:center; justify-content:space-between;
      padding:.9rem 1.3rem; cursor:pointer; user-select:none;
      transition:background .15s;
    }
    .hist-head:hover { background:rgba(255,255,255,0.03) }
    .hist-head-left { display:flex;align-items:center;gap:.55rem }
    .hist-ttl {
      font-size:.72rem; font-weight:700; letter-spacing:.09em;
      text-transform:uppercase; color:var(--text-dim);
    }
    .hist-count {
      font-size:.62rem; font-weight:700; padding:1px 7px;
      background:rgba(108,75,255,0.15); color:var(--accent);
      border:1px solid rgba(108,75,255,.25); border-radius:10px;
    }
    .hist-chevron { color:var(--text-dim); transition:transform .2s }
    .hist-chevron.open { transform:rotate(180deg) }
    .hist-chevron svg { width:14px;height:14px }
    .hist-body { padding:0 1.3rem; max-height:0; overflow:hidden; transition:max-height .3s ease, padding .3s }
    .hist-body.open { max-height:400px; padding-bottom:1rem }
    .hist-empty { font-size:.82rem;color:var(--text-dim);text-align:center;padding:1rem 0 }
    .hist-list { display:flex;flex-direction:column;gap:.5rem }
    .hist-entry {
      display:grid; grid-template-columns:1fr auto;
      gap:.4rem .8rem; align-items:start;
      padding:.65rem .75rem; border-radius:var(--r-sm);
      background:rgba(255,255,255,0.03); border:1px solid var(--border);
      transition:border-color .15s;
    }
    .hist-entry:hover { border-color:rgba(108,75,255,.2) }
    .he-name { font-size:.82rem;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis }
    .he-meta { font-size:.7rem;color:var(--text-dim);margin-top:1px }
    .he-lufs {
      text-align:right; font-family:'JetBrains Mono',monospace;
      font-size:.72rem; font-weight:600; color:var(--green); white-space:nowrap;
    }
    .he-date { font-size:.65rem;color:var(--text-dim);text-align:right;margin-top:1px }
    .hist-clear {
      font-size:.7rem;color:var(--text-dim);cursor:pointer;background:none;border:none;
      padding:.25rem .5rem;border-radius:4px;transition:color .15s;margin-top:.5rem;display:block;
    }
    .hist-clear:hover { color:var(--red) }

    /* ═══════════════════════ DAW COMPARISON CARD ═══════════════════════ */
    .daw-card {
      display:none; width:100%; margin-top:1.1rem;
      background:var(--surface); border:1px solid var(--border);
      border-radius:var(--r-lg); overflow:hidden;
      box-shadow:var(--shadow); backdrop-filter:blur(14px); -webkit-backdrop-filter:blur(14px);
    }
    .daw-card.visible { display:block; animation:fadeIn .4s ease }
    .daw-head {
      display:flex; align-items:center; justify-content:space-between;
      padding:.7rem 1rem; border-bottom:1px solid var(--border);
      background:rgba(0,0,0,0.25);
    }
    .daw-ttl {
      font-size:.7rem; font-weight:700; letter-spacing:.09em;
      text-transform:uppercase; color:var(--text-dim);
      display:flex; align-items:center; gap:.45rem;
    }
    .daw-ttl svg { width:14px;height:14px;color:var(--accent) }
    .daw-ruler-wrap {
      position:relative; height:20px; background:rgba(0,0,0,0.4);
      border-bottom:1px solid var(--border);
      overflow:hidden;
    }
    .daw-ruler {
      position:absolute; left:0; top:0; right:0; bottom:0;
      font-family:'JetBrains Mono',monospace; font-size:.58rem;
      color:var(--text-dim); pointer-events:none;
    }
    .daw-tracks {
      display:flex; flex-direction:column; gap:0;
    }
    .daw-track {
      position:relative; height:52px; background:rgba(0,0,0,0.35);
      border-bottom:1px solid var(--border); overflow:hidden;
    }
    .daw-track:last-of-type { border-bottom:none }
    .daw-track-label {
      position:absolute; left:6px; top:50%; transform:translateY(-50%);
      font-size:.6rem; font-weight:700; letter-spacing:.08em;
      text-transform:uppercase; color:var(--text-dim);
      z-index:2; pointer-events:none;
    }
    .daw-track.a .daw-track-label { color:rgba(108,75,255,0.9) }
    .daw-track.b .daw-track-label { color:rgba(52,211,153,0.9) }
    .daw-track-canvas {
      display:block; width:100%; height:100%;
      position:absolute; left:0; top:0; cursor:crosshair;
    }
    .daw-stats-row {
      display:grid; grid-template-columns:1fr 1fr;
      gap:0; border-top:1px solid var(--border);
      background:rgba(0,0,0,0.2);
    }
    .daw-stat {
      padding:.5rem .75rem; border-right:1px solid var(--border);
      display:flex; flex-direction:column; gap:2px;
    }
    .daw-stat:last-child { border-right:none }
    .daw-stat-lbl {
      font-size:.58rem; font-weight:700; letter-spacing:.08em;
      text-transform:uppercase; color:var(--text-dim);
    }
    .daw-stat-val {
      font-family:'JetBrains Mono',monospace; font-size:.78rem;
      font-weight:600; color:var(--text-soft);
    }
    .daw-stat.a .daw-stat-val { color:var(--accent) }
    .daw-stat.b .daw-stat-val { color:var(--green) }

    /* ═══════════════════════ SPECTRUM CARD ═══════════════════════ */
    .spectrum-card {
      display:none; width:100%; margin-top:1.1rem;
      background:var(--surface); border:1px solid var(--border);
      border-radius:var(--r-lg); overflow:hidden;
      box-shadow:var(--shadow); backdrop-filter:blur(14px); -webkit-backdrop-filter:blur(14px);
    }
    .spectrum-card.visible { display:block; animation:fadeIn .4s ease }
    .spectrum-head {
      padding:.7rem 1rem; border-bottom:1px solid var(--border);
      background:rgba(0,0,0,0.25);
    }
    .spectrum-ttl {
      font-size:.7rem; font-weight:700; letter-spacing:.09em;
      text-transform:uppercase; color:var(--text-dim);
      display:inline-flex; align-items:center; gap:.45rem;
    }
    .spectrum-ttl svg { width:14px; height:14px; color:var(--cyan) }
    .spectrum-ruler {
      display:flex; justify-content:space-between; padding:2px 8px 0;
      font-family:'JetBrains Mono',monospace; font-size:.58rem; color:var(--text-dim);
    }
    .spectrum-canvas {
      display:block; width:100%; height:80px; background:rgba(0,0,0,0.4);
    }

    /* ═══════════════════════ VECTORSCOPE CARD ═══════════════════════ */
    .vectorscope-card {
      display:none; width:100%; margin-top:1.1rem;
      background:var(--surface); border:1px solid var(--border);
      border-radius:var(--r-lg); overflow:hidden;
      box-shadow:var(--shadow); backdrop-filter:blur(14px); -webkit-backdrop-filter:blur(14px);
    }
    .vectorscope-card.visible { display:block; animation:fadeIn .4s ease }
    .vectorscope-head {
      padding:.7rem 1rem; border-bottom:1px solid var(--border);
      background:rgba(0,0,0,0.25);
    }
    .vectorscope-ttl {
      font-size:.7rem; font-weight:700; letter-spacing:.09em;
      text-transform:uppercase; color:var(--text-dim);
      display:inline-flex; align-items:center; gap:.45rem;
    }
    .vectorscope-ttl svg { width:14px; height:14px; color:var(--accent-2) }
    .vectorscope-hint {
      font-size:.65rem; color:var(--text-dim); line-height:1.35;
      padding:.35rem 1rem .5rem; margin:0; max-width:420px;
    }
    .vectorscope-canvas {
      display:block; width:200px; height:200px; margin:0 auto .75rem;
      background:rgba(0,0,0,0.4); border-radius:50%;
    }

    /* ═══════════════════════ STREAMING PREVIEW ═══════════════════════ */
    .streaming-preview {
      margin-top:.9rem; padding:.75rem 1rem;
      background:var(--surface); border:1px solid var(--border);
      border-radius:var(--r); box-shadow:var(--shadow);
    }
    .streaming-preview-title {
      display:flex; align-items:center; gap:.4rem;
      font-size:.68rem; font-weight:700; letter-spacing:.08em;
      text-transform:uppercase; color:var(--text-dim); margin-bottom:.6rem;
    }
    .streaming-preview-grid {
      display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:.45rem;
    }
    .sp-item {
      display:flex; flex-direction:column; gap:.15rem;
      padding:.45rem .6rem; border-radius:8px;
      border:1px solid var(--border); background:rgba(255,255,255,.03);
    }
    .sp-item.optimal { border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.07) }
    .sp-item.ok      { border-color:rgba(251,191,36,.35); background:rgba(251,191,36,.07) }
    .sp-item.loud    { border-color:rgba(239,68,68,.35);  background:rgba(239,68,68,.07) }
    .sp-platform { font-size:.7rem; font-weight:600; color:var(--text); }
    .sp-lufs     { font-size:.65rem; color:var(--text-dim); }
    .sp-penalty  { font-size:.72rem; font-weight:700; }
    .sp-item.optimal .sp-penalty { color:#22c55e }
    .sp-item.ok      .sp-penalty { color:#fbbf24 }
    .sp-item.loud    .sp-penalty { color:#ef4444 }

    /* ═══════════════════════ REFERENCE TRACK ═══════════════════════ */
    .reference-track-wrap {
      display:flex; align-items:center; gap:.5rem; flex-wrap:wrap;
    }
    .btn-reference {
      display:inline-flex; align-items:center; gap:.3rem;
      padding:.3rem .65rem; border-radius:6px;
      background:rgba(108,75,255,.12); border:1px solid rgba(108,75,255,.3);
      color:#a78bfa; font-size:.72rem; font-weight:600; cursor:pointer;
      transition:background .15s;
    }
    .btn-reference:hover { background:rgba(108,75,255,.2) }
    .ref-file-name { font-size:.7rem; color:var(--text-dim); flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .btn-ref-clear { background:none; border:none; color:var(--text-dim); cursor:pointer; font-size:.8rem; padding:.1rem .3rem; }
    .btn-ref-clear:hover { color:#ef4444 }
    .ref-strength-wrap { display:flex; align-items:center; gap:.5rem; margin-top:.4rem; width:100%; }
    .f-lbl-sm { font-size:.65rem; color:var(--text-dim); white-space:nowrap; }
    .ref-strength-wrap input[type=range] { flex:1; }
    .ref-strength-wrap span { font-size:.7rem; color:#a78bfa; min-width:2.5rem; text-align:right; }
    .badge-new {
      display:inline-block; padding:.1rem .35rem; border-radius:4px;
      background:rgba(34,197,94,.15); border:1px solid rgba(34,197,94,.3);
      color:#22c55e; font-size:.58rem; font-weight:700; letter-spacing:.05em;
      text-transform:uppercase; vertical-align:middle; margin-left:.3rem;
    }

    /* ═══════════════════════ PRO MODULES — уникальные функции ═══════════════════════ */
    .pro-section-wrap {
      margin-top: .9rem;
      border: 1px solid var(--border);
      border-radius: var(--r);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }
    .pro-section-head {
      display: flex; align-items: center; gap: .5rem;
      padding: .6rem .9rem;
      background: var(--surface-2);
      cursor: pointer; user-select: none;
      transition: background .15s;
    }
    .pro-section-head:hover { background: var(--surface-3); }
    .pro-section-icon { color: var(--accent-2); flex-shrink: 0; }
    .pro-section-icon svg { width: 14px; height: 14px; }
    .pro-section-title {
      font-size: .68rem; font-weight: 700; letter-spacing: .08em;
      text-transform: uppercase; color: var(--text-soft); flex: 1;
    }
    .pro-section-badge {
      font-size: .54rem; font-weight: 800; letter-spacing: .1em;
      padding: .12rem .4rem; border-radius: 4px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
      color: #fff; text-transform: uppercase;
    }
    .pro-section-chevron { color: var(--text-dim); transition: transform .2s; }
    .pro-section-chevron svg { width: 14px; height: 14px; }
    .pro-section-chevron.open { transform: rotate(180deg); }
    .pro-section-body { max-height: 0; overflow: hidden; transition: max-height .35s ease; background: var(--surface); }
    .pro-section-body.open { max-height: 800px; }
    .pro-modules-list { padding: .5rem .7rem .7rem; display: flex; flex-direction: column; gap: .5rem; }

    /* Каждый PRO-модуль */
    .pro-module {
      border-radius: var(--r-sm);
      border: 1px solid var(--border);
      overflow: hidden;
      transition: border-color .2s, box-shadow .2s;
    }
    .pro-module:hover { box-shadow: 0 0 0 1px rgba(255,255,255,0.04); }
    .pro-module-head {
      display: flex; align-items: center; gap: .5rem;
      padding: .5rem .7rem;
      cursor: pointer;
    }
    .pro-module-icon { width: 28px; height: 28px; border-radius: 6px;
      display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .pro-module-icon svg { width: 14px; height: 14px; }
    .pro-module-info { flex: 1; min-width: 0; }
    .pro-module-name { font-size: .78rem; font-weight: 600; color: var(--text); line-height: 1.2; }
    .pro-module-desc { font-size: .64rem; color: var(--text-dim); margin-top: .1rem; line-height: 1.3; }
    .pro-module-toggle { position: relative; flex-shrink: 0; }
    .pro-module-toggle input { position: absolute; opacity: 0; width: 0; height: 0; }
    .pro-toggle-track {
      display: block; width: 32px; height: 18px; border-radius: 9px;
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.12);
      cursor: pointer; transition: background .2s, border-color .2s; position: relative;
    }
    .pro-toggle-track::after {
      content: ''; position: absolute; top: 2px; left: 2px;
      width: 12px; height: 12px; border-radius: 50%;
      background: var(--text-dim); transition: left .2s, background .2s;
    }
    .pro-module-toggle input:checked + .pro-toggle-track { background: var(--pro-color, var(--accent)); border-color: var(--pro-color, var(--accent)); }
    .pro-module-toggle input:checked + .pro-toggle-track::after { left: 16px; background: #fff; }

    .pro-module-body { padding: 0 .7rem .65rem; display: none; }
    .pro-module.expanded .pro-module-body { display: block; }

    /* Слайдеры внутри модулей */
    .pro-slider-row { display: flex; align-items: center; gap: .5rem; margin-top: .4rem; }
    .pro-slider-label { font-size: .64rem; color: var(--text-dim); white-space: nowrap; min-width: 4rem; }
    .pro-slider-row input[type=range] { flex: 1; accent-color: var(--pro-color, var(--accent)); height: 14px; }
    .pro-slider-val { font-size: .68rem; font-weight: 600; color: var(--pro-color, var(--accent)); min-width: 2.8rem; text-align: right; font-family: var(--text-mono); }
    .pro-select-row { display: flex; align-items: center; gap: .5rem; margin-top: .4rem; }
    .pro-select { flex: 1; font-size: .7rem; padding: .25rem .4rem; border-radius: 6px; border: 1px solid var(--border); background: var(--surface); color: var(--text); }

    /* Уникальные цвета для каждого модуля */
    .pro-module[data-pro="denoiser"]  { --pro-color: var(--pro-denoiser);  border-left: 3px solid var(--pro-denoiser);  background: var(--pro-denoiser-bg); }
    .pro-module[data-pro="deesser"]   { --pro-color: var(--pro-deesser);   border-left: 3px solid var(--pro-deesser);   background: var(--pro-deesser-bg); }
    .pro-module[data-pro="transient"] { --pro-color: var(--pro-transient); border-left: 3px solid var(--pro-transient); background: var(--pro-transient-bg); }
    .pro-module[data-pro="parallel"]  { --pro-color: var(--pro-parallel);  border-left: 3px solid var(--pro-parallel);  background: var(--pro-parallel-bg); }
    .pro-module[data-pro="dynEQ"]     { --pro-color: var(--pro-dynEQ);     border-left: 3px solid var(--pro-dynEQ);     background: var(--pro-dynEQ-bg); }

    .pro-module[data-pro="denoiser"]  .pro-module-icon { background: var(--pro-denoiser-bg); color: var(--pro-denoiser); }
    .pro-module[data-pro="deesser"]   .pro-module-icon { background: var(--pro-deesser-bg);  color: var(--pro-deesser); }
    .pro-module[data-pro="transient"] .pro-module-icon { background: var(--pro-transient-bg);color: var(--pro-transient); }
    .pro-module[data-pro="parallel"]  .pro-module-icon { background: var(--pro-parallel-bg); color: var(--pro-parallel); }
    .pro-module[data-pro="dynEQ"]     .pro-module-icon { background: var(--pro-dynEQ-bg);    color: var(--pro-dynEQ); }

    /* При включении — свечение по полосе */
    .pro-module[data-pro="denoiser"].active  { box-shadow: -3px 0 12px var(--pro-denoiser-glow); }
    .pro-module[data-pro="deesser"].active   { box-shadow: -3px 0 12px var(--pro-deesser-glow); }
    .pro-module[data-pro="transient"].active { box-shadow: -3px 0 12px var(--pro-transient-glow); }
    .pro-module[data-pro="parallel"].active  { box-shadow: -3px 0 12px var(--pro-parallel-glow); }
    .pro-module[data-pro="dynEQ"].active     { box-shadow: -3px 0 12px var(--pro-dynEQ-glow); }

    /* Spectrum MID/SIDE tabs */
    .spec-tab-wrap { display: flex; gap: .25rem; margin-left: auto; }
    .spec-tab {
      font-size: .6rem; font-weight: 700; padding: .18rem .5rem;
      border-radius: 5px; border: 1px solid var(--border);
      background: none; color: var(--text-dim); cursor: pointer;
      letter-spacing: .05em; transition: all .15s;
    }
    .spec-tab:hover { border-color: rgba(255,255,255,0.15); color: var(--text-soft); }
    .spec-tab.active[data-mode="mono"]  { background: rgba(6,182,212,0.15);  border-color: var(--pro-denoiser); color: var(--pro-denoiser); }
    .spec-tab.active[data-mode="mid"]   { background: rgba(139,92,246,0.15); border-color: var(--pro-dynEQ);    color: var(--pro-dynEQ); }
    .spec-tab.active[data-mode="side"]  { background: rgba(245,158,11,0.15); border-color: var(--pro-transient);color: var(--pro-transient); }

    /* ═══════════════════════ CHAIN MODULES CARD ═══════════════════════ */
    .chain-modules-card {
      width:100%; margin-top:.9rem; margin-bottom:.5rem;
      background:var(--surface); border:1px solid var(--border);
      border-radius:var(--r); overflow:hidden;
      box-shadow:0 2px 16px rgba(0,0,0,0.25);
    }
    .chain-modules-head {
      display:flex; align-items:center; justify-content:space-between;
      padding:.55rem .85rem; cursor:pointer; user-select:none;
      transition:background .15s;
    }
    .chain-modules-head:hover { background:rgba(255,255,255,0.03) }
    .chain-modules-ttl {
      font-size:.68rem; font-weight:700; letter-spacing:.08em;
      text-transform:uppercase; color:var(--text-dim);
    }
    .chain-modules-chevron { color:var(--text-dim); transition:transform .2s }
    .chain-modules-chevron.open { transform:rotate(180deg) }
    .chain-modules-chevron svg { width:14px; height:14px }
    .chain-modules-body { max-height:0; overflow:hidden; transition:max-height .25s ease }
    .chain-modules-body.open { max-height:320px }
    .chain-modules-list {
      padding:.5rem .85rem .75rem; display:flex; flex-direction:column; gap:.35rem;
    }
    .chain-mod-item {
      display:flex; align-items:center; gap:.5rem;
      padding:.4rem .55rem; border-radius:var(--r-sm);
      background:rgba(0,0,0,0.25); border:1px solid var(--border);
      font-size:.78rem; color:var(--text-soft);
    }
    .chain-mod-item.enabled { border-color:rgba(108,75,255,0.25); color:var(--text) }
    .chain-mod-item.draggable { cursor:grab }
    .chain-mod-item:active { cursor:grabbing }
    .chain-mod-item.chain-mod-drag-over { border-color:var(--accent); background:rgba(108,75,255,0.12) }
    .chain-mod-item .cm-num { font-family:'JetBrains Mono',monospace; font-size:.65rem; color:var(--text-dim); min-width:1.2rem }
    .chain-mod-item .cm-label { flex:1 }
    .chain-mod-item .cm-amount-wrap { display:flex; align-items:center; gap:.4rem; flex-shrink:0 }
    .chain-mod-item .cm-amount { width:52px; height:4px; accent-color:var(--accent); cursor:pointer }
    .chain-mod-item .cm-amount-val { font-family:'JetBrains Mono',monospace; font-size:.62rem; color:var(--text-dim); min-width:2rem }
    .chain-mod-item .cm-phase-mode {
      font-size:.65rem; padding:2px 6px; border-radius:4px; max-width:5.5rem;
      background:rgba(0,0,0,0.35); border:1px solid var(--border); color:var(--text-soft);
      cursor:pointer; flex-shrink:0;
    }
    .chain-mod-item .cm-phase-mode:focus { outline:none; border-color:var(--accent) }
    .chain-mod-item .cm-eq-ms-wrap { display:inline-flex; align-items:center; gap:4px; font-size:.6rem; color:var(--text-dim); cursor:pointer; user-select:none }
    .chain-mod-item .cm-eq-ms { width:12px; height:12px; accent-color:var(--accent) }
    .chain-mod-item .cm-reverb-type {
      font-size:.65rem; padding:2px 6px; border-radius:4px; max-width:5rem;
      background:rgba(0,0,0,0.35); border:1px solid var(--border); color:var(--text-soft);
      cursor:pointer; flex-shrink:0;
    }
    .chain-mod-item .cm-reverb-type:focus { outline:none; border-color:var(--accent) }
    .chain-mod-item .cm-ms-wrap { display:inline-flex; align-items:center; gap:2px; font-size:.6rem; color:var(--text-dim) }
    .chain-mod-item .cm-ms-wrap input { width:2.2rem; font-size:.65rem; padding:1px 4px; border-radius:4px; background:rgba(0,0,0,0.35); border:1px solid var(--border); color:var(--text-soft) }
    .chain-mod-item .cm-oversample {
      font-size:.65rem; padding:2px 6px; border-radius:4px; max-width:3.5rem;
      background:rgba(0,0,0,0.35); border:1px solid var(--border); color:var(--text-soft);
      cursor:pointer; flex-shrink:0;
    }
    .chain-mod-item .cm-oversample:focus { outline:none; border-color:var(--accent) }
    .chain-presets-wrap { padding:.5rem .85rem .75rem; border-top:1px solid var(--border); margin-top:.25rem; }
    .chain-presets-row { display:flex; align-items:center; gap:.5rem; margin-bottom:.4rem; }
    .chain-presets-row:last-child { margin-bottom:0 }
    .chain-preset-name { flex:1; min-width:0; font-size:.75rem; padding:.35rem .5rem; border-radius:var(--r-sm); background:rgba(0,0,0,0.35); border:1px solid var(--border); color:var(--text-soft); }
    .chain-preset-select { flex:1; min-width:0; font-size:.75rem; padding:.35rem .5rem; border-radius:var(--r-sm); background:rgba(0,0,0,0.35); border:1px solid var(--border); color:var(--text-soft); }
    .chain-preset-btn { font-size:.7rem; padding:.3rem .55rem; white-space:nowrap; }
    .chain-preset-delete { opacity:.8; color:var(--text-dim); }

    /* ═══════════════════════ TIER BADGE ═══════════════════════ */
    .tier-row {
      display: flex; align-items: center; justify-content: center; gap: .55rem;
      margin: .55rem 0 0;
    }
    .locale-wrap {
      position: absolute; top: 1rem; right: 1rem;
      display: flex; align-items: center; gap: .35rem;
      font-size: .7rem; color: var(--text-dim);
    }
    .locale-btn {
      background: transparent; border: 1px solid var(--border); color: var(--text-soft);
      padding: .2rem .5rem; border-radius: 6px; cursor: pointer; font-size: .7rem;
      transition: color .15s, border-color .15s;
    }
    .locale-btn:hover { color: var(--text); border-color: var(--accent); }
    .locale-btn.active { color: var(--accent); border-color: var(--accent); }
    .tier-badge {
      display: inline-flex; align-items: center; gap: .3rem;
      font-size: .7rem; font-weight: 700; letter-spacing: .04em;
      color: var(--accent);
      background: rgba(108,75,255,.1);
      border: 1px solid rgba(108,75,255,.22);
      border-radius: 99px; padding: 3px 11px;
      transition: all .2s;
    }
    .tier-badge .tb-dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: var(--accent); flex-shrink: 0;
      box-shadow: 0 0 5px var(--accent);
    }
    .tier-badge.warn  { color: var(--amber); background: rgba(251,191,36,.1);  border-color: rgba(251,191,36,.22); }
    .tier-badge.warn .tb-dot  { background: var(--amber); box-shadow: 0 0 5px var(--amber); }
    .tier-badge.empty { color: var(--red);   background: rgba(248,113,113,.1); border-color: rgba(248,113,113,.22); }
    .tier-badge.empty .tb-dot { background: var(--red);   box-shadow: 0 0 5px var(--red);   }
    .tier-badge.debug-badge {
      color: var(--amber); background: rgba(251,191,36,.12); border-color: rgba(251,191,36,.3);
    }
    .tier-badge.debug-badge .tb-dot { background: var(--amber); box-shadow: 0 0 6px var(--amber); }
    .tier-upgrade-link {
      font-size: .68rem; color: var(--text-dim); text-decoration: none;
      transition: color .15s;
    }
    .tier-upgrade-link:hover { color: var(--accent); }

    /* ─── Auth state row ─── */
    .auth-row {
      display: flex; align-items: center; justify-content: center; gap: .5rem;
      flex-wrap: wrap; margin-top: .35rem;
    }
    .auth-email {
      font-size: .7rem; font-weight: 600; color: var(--text-soft);
      max-width: 160px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .auth-priority-hint { font-size: .6rem; color: var(--text-dim); margin-left: .35rem; }
    .auth-pro-badge {
      font-size: .62rem; font-weight: 700; letter-spacing: .08em;
      color: var(--accent2); background: rgba(168,85,247,.12);
      border: 1px solid rgba(168,85,247,.25); border-radius: 99px;
      padding: 1px 7px; text-transform: uppercase;
    }
    .btn-logout {
      font-size: .68rem; color: var(--text-dim); background: none; border: none;
      cursor: pointer; padding: 0; text-decoration: underline;
      transition: color .15s;
    }
    .btn-logout:hover { color: var(--red); }
    .btn-login-link {
      font-size: .68rem; color: var(--accent); text-decoration: none;
      font-weight: 600; transition: opacity .15s;
    }
    .btn-login-link:hover { opacity: .75; }

    /* ═══════════════════════ LOCKED STYLE CARDS ═══════════════════════ */
    .style-card.locked {
      opacity: .48;
      cursor: default;
      position: relative;
    }
    .style-card.locked::after {
      content: '';
      position: absolute; inset: 0;
      background: rgba(0,0,0,.18);
      border-radius: inherit;
    }
    .style-card.locked .sc-lock {
      display: flex !important;
    }
    .sc-lock {
      display: none;
      position: absolute; top: 5px; right: 6px; z-index: 2;
      background: rgba(0,0,0,.55);
      border-radius: 4px; padding: 1px 4px;
      font-size: .6rem; color: var(--amber);
      align-items: center; gap: 2px;
      pointer-events: none;
    }

    /* ═══════════════════════ LOCKED FORMAT OPTIONS ═══════════════════════ */
    .pro-select-note {
      font-size: .65rem; color: var(--text-dim); margin-top: .3rem; display: block;
    }

    /* ═══════════════════════ UPGRADE MODAL ═══════════════════════ */
    .upgrade-overlay {
      position: fixed; inset: 0; z-index: 9000;
      background: rgba(0,0,0,.72); backdrop-filter: blur(6px);
      display: flex; align-items: center; justify-content: center;
      opacity: 0; pointer-events: none;
      transition: opacity .2s;
    }
    .upgrade-overlay.open {
      opacity: 1; pointer-events: all;
    }
    .upgrade-box {
      background: var(--surface-2);
      border: 1px solid rgba(108,75,255,.3);
      border-radius: var(--r-lg);
      padding: 2rem 1.75rem 1.75rem;
      max-width: 360px; width: calc(100% - 2rem);
      text-align: center;
      box-shadow: 0 0 0 1px rgba(108,75,255,.1), 0 24px 64px rgba(0,0,0,.7);
      transform: translateY(12px); transition: transform .22s;
      position: relative;
    }
    .upgrade-overlay.open .upgrade-box { transform: translateY(0); }
    .upgrade-close {
      position: absolute; top: .9rem; right: .9rem;
      background: none; border: none; color: var(--text-dim);
      cursor: pointer; font-size: 1rem; line-height: 1;
      padding: 4px; border-radius: 6px; transition: color .15s, background .15s;
    }
    .upgrade-close:hover { color: var(--text); background: rgba(255,255,255,.06); }
    .upgrade-icon {
      width: 52px; height: 52px; border-radius: 14px; margin: 0 auto 1rem;
      background: linear-gradient(135deg, rgba(108,75,255,.2), rgba(168,85,247,.15));
      border: 1px solid rgba(108,75,255,.3);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.5rem;
    }
    .upgrade-title {
      font-size: 1.1rem; font-weight: 700; letter-spacing: -.02em;
      margin: 0 0 .55rem; color: var(--text);
    }
    .upgrade-desc {
      font-size: .82rem; color: var(--text-soft); line-height: 1.55;
      margin: 0 0 1.35rem;
    }
    .upgrade-features {
      display: flex; flex-direction: column; gap: .3rem;
      margin-bottom: 1.35rem; text-align: left;
    }
    .upgrade-feature {
      display: flex; align-items: center; gap: .4rem;
      font-size: .78rem; color: var(--text-soft);
    }
    .upgrade-feature::before { content: '✓'; color: var(--accent); font-weight: 700; }
    .upgrade-btns {
      display: flex; flex-direction: column; gap: .6rem;
    }
    .btn-go-pro {
      display: block; width: 100%; padding: .75rem 1rem;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #fff; font-weight: 700; font-size: .88rem;
      border: none; border-radius: var(--r-sm); cursor: pointer;
      text-decoration: none; transition: opacity .15s;
    }
    .btn-go-pro:hover { opacity: .88; }
    .btn-stay-free {
      background: none; border: none; color: var(--text-dim);
      font-size: .78rem; cursor: pointer; padding: .3rem;
      transition: color .15s;
    }
    .btn-stay-free:hover { color: var(--text); }

    /* ═══════════════════════ RESPONSIVE (P11 — мобильная адаптация) ═══════════════════════ */
    /* Удобные зоны нажатия для сенсорных экранов */
    @media (pointer: coarse) {
      .btn-primary { min-height: 44px; padding: .5rem 1.25rem; -webkit-tap-highlight-color: transparent }
      .style-card { min-height: 44px; padding: .65rem .5rem; -webkit-tap-highlight-color: transparent }
      .chain-modules-head { min-height: 44px; padding: .65rem .85rem; -webkit-tap-highlight-color: transparent }
      .chain-preset-btn { min-height: 36px; padding: .4rem .65rem }
      .btn-ab { min-width: 36px; min-height: 36px }
    }
    @media (max-width: 640px) {
      .page { padding-left: env(safe-area-inset-left, 0); padding-right: env(safe-area-inset-right, 0); box-sizing: border-box }
      .header { padding: 2rem 1rem 1.5rem }
      .h-title { font-size: 1.6rem }
      .h-sub { font-size: .82rem; max-width: 100% }
      .card { padding: 1.2rem 1rem; margin-left: .5rem; margin-right: .5rem; max-width: calc(100% - 1rem) }
      .style-grid { grid-template-columns: repeat(2, 1fr); gap: .5rem }
      .two-col { grid-template-columns: 1fr }
      .result-grid { grid-template-columns: 1fr; gap: .6rem }
      .result-grid .result-block { text-align: center }
      .chain-modules-body.open { max-height: 380px }
      .chain-mod-item { flex-wrap: wrap }
      .chain-mod-item .cm-label { min-width: 0 }
      .chain-presets-row { flex-wrap: wrap }
      .chain-preset-select { min-width: 0 }
      .auth-row { flex-wrap: wrap; justify-content: center; gap: .4rem }
      .tier-row { flex-wrap: wrap; justify-content: center }
    }
    @media (max-width: 480px) {
      .header { padding: 1.75rem .75rem 1.25rem }
      .h-title { font-size: 1.45rem }
      .card { padding: 1rem .85rem; margin-left: .4rem; margin-right: .4rem; max-width: calc(100% - .8rem) }
      .style-grid { grid-template-columns: 1fr; gap: .4rem }
      .two-col { grid-template-columns: 1fr }
      .result-grid { grid-template-columns: 1fr; text-align: center }
      .result-block-val { font-size: 1.2rem }
      .chain-modules-body.open { max-height: 420px }
      .chain-mod-item .cm-amount-wrap { width: 100%; justify-content: flex-start }
      .chain-presets-row { flex-direction: column; align-items: stretch }
      .chain-preset-name { width: 100% }
      .chain-preset-select { width: 100% }
      .toast-wrap { left: .75rem; right: .75rem; bottom: max(1rem, env(safe-area-inset-bottom)); max-width: none }
    }
    @media (max-width: 360px) {
      .logo-name { font-size: 1.1rem }
      .h-title { font-size: 1.3rem }
      .card { padding: .9rem .7rem }
    }
  </style>
</head>
<body>
<div class="bg-layer"></div>
<div class="page">

  <!-- ──── HEADER ──── -->
  <header class="header">
    <div class="logo">
      <a href="/" class="logo-back" style="display:inline-flex;align-items:center;gap:.35rem;color:var(--text-dim);font-size:.78rem;text-decoration:none;margin-bottom:.5rem;transition:color .15s;" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--text-dim)'">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
        На главную
      </a>
      <div style="display:flex;align-items:center;gap:.5rem;">
        <div class="logo-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>
          </svg>
        </div>
        <span class="logo-name">Magic Master</span>
        <span class="logo-badge">Pro</span>
      </div>
    </div>
    <h1 class="h-title" data-i18n="app.title">Мастеринг в два клика</h1>
    <p class="h-sub">Профессиональная нормализация LUFS · True Peak ≤ −1 dBTP · Studio EQ · TPDF Dithering</p>
    <div class="locale-wrap" id="localeWrap" title="Язык / Language">
      <span class="locale-label" data-i18n="locale.label">Язык</span>
      <button type="button" class="locale-btn active" data-lang="ru" aria-label="Русский">RU</button>
      <button type="button" class="locale-btn" data-lang="en" aria-label="English">EN</button>
    </div>
    <div class="tier-row" id="tierRow">
      <div class="tier-badge" id="tierBadge">
        <span class="tb-dot"></span>
        Free · <span id="tierRemaining">3</span> мастеринга осталось
      </div>
      <a href="/pricing" class="tier-upgrade-link" id="upgradeLink">Перейти на Pro →</a>
    </div>
    <!-- Auth state: показывается когда залогинен -->
    <div class="auth-row" id="authRow" style="display:none">
      <span class="auth-pro-badge">✦ Pro</span>
      <span class="auth-priority-hint" id="authPriorityHint" style="display:none" title="До 2 задач мастеринга одновременно (Free: 1)">Приоритетная очередь</span>
      <span class="auth-email" id="authEmail"></span>
      <a href="/profile" class="btn-login-link" style="font-size:.66rem;opacity:.7">Профиль</a>
      <a href="/dashboard" class="btn-login-link" style="font-size:.66rem;opacity:.7">Дашборд</a>
      <button class="btn-logout" id="btnLogout" title="Выйти из аккаунта">Выйти</button>
    </div>
    <!-- Auth row: когда не залогинен -->
    <div class="auth-row" id="authRowGuest" style="display:none">
      <a href="/login" class="btn-login-link">Войти / Зарегистрироваться →</a>
    </div>
    <div class="wdeco" id="wdeco">
      <div class="b"></div><div class="b"></div><div class="b"></div><div class="b"></div>
      <div class="b"></div><div class="b"></div><div class="b"></div><div class="b"></div>
      <div class="b"></div><div class="b"></div><div class="b"></div><div class="b"></div>
      <div class="b"></div><div class="b"></div><div class="b"></div>
    </div>
  </header>

  <!-- ──── CARD 1: UPLOAD ──── -->
  <div class="card">
    <div class="card-hd">
      <div class="card-hd-left">
        <div class="card-ico">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
        </div>
        <span class="card-ttl" data-i18n="app.upload">Загрузка файла</span>
      </div>
    </div>

    <div class="drop" id="drop">
      <input type="file" id="fileInput" accept=".wav,.mp3,.flac,audio/*">
      <div class="drop-ico">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>
        </svg>
      </div>
      <p class="drop-title">Перетащите аудиофайл сюда</p>
      <p class="drop-hint">или нажмите для выбора с диска</p>
      <div class="drop-fmts">
        <span class="fmt-tag">WAV</span>
        <span class="fmt-tag">MP3</span>
        <span class="fmt-tag">FLAC</span>
      </div>
      <div class="file-info" id="fileInfo">
        <div class="file-info-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        </div>
        <span class="file-info-name" id="fileName"></span>
        <span class="file-info-meta" id="fileMeta"></span>
        <button type="button" class="btn-reset" id="btnReset" title="Выбрать другой файл" aria-label="Выбрать другой файл">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Пакетная обработка (Pro / режим отладки) -->
    <div class="batch-section" id="batchSection" style="display:none">
      <div class="batch-hd">
        <span class="batch-ttl">Пакетная обработка</span>
        <span class="batch-hint">до 10 файлов, одни параметры</span>
      </div>
      <input type="file" id="batchFileInput" accept=".wav,.mp3,.flac,audio/*" multiple style="display:none">
      <button type="button" class="btn btn-batch" id="btnSelectBatch">Выбрать файлы</button>
      <div class="batch-file-list" id="batchFileList"></div>
      <button type="button" class="btn btn-primary btn-batch-run" id="btnBatchMaster" style="display:none" disabled>Запустить мастеринг (<span id="batchCount">0</span> файлов)</button>
      <div class="batch-panel" id="batchPanel" style="display:none">
        <div class="batch-panel-title">Обработка</div>
        <div class="batch-jobs" id="batchJobs"></div>
      </div>
    </div>

    <!-- ─ Waveform Player ─ -->
    <div class="player" id="player">
      <div class="wave-wrap" id="waveWrap">
        <canvas id="waveCanvas" class="wave-canvas"></canvas>
      </div>
      <div class="transport">
        <button class="btn-pp" id="btnPP" title="Play / Pause  [Space]" aria-label="Воспроизведение и пауза">
          <svg id="iconPlay" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
          <svg id="iconPause" viewBox="0 0 24 24" fill="currentColor" style="display:none"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
        </button>
        <span class="t-elapsed" id="tElapsed">0:00</span>
        <div class="t-scrub" id="tScrub"><div class="t-scrub-fill" id="tFill"></div></div>
        <span class="t-total"  id="tTotal">0:00</span>
        <!-- A/B comparison buttons + LUFS (P12) -->
        <div class="ab-wrap" id="abWrap">
          <div class="ab-item">
            <button class="btn-ab active" id="btnAB-a" title="Оригинал">A</button>
            <span class="ab-lufs" id="abLufsA" aria-label="LUFS оригинала">—</span>
          </div>
          <div class="ab-item">
            <button class="btn-ab" id="btnAB-b" title="После мастеринга">B</button>
            <span class="ab-lufs" id="abLufsB" aria-label="LUFS мастера">—</span>
          </div>
        </div>
      </div>
      <div class="audio-meta" id="audioMeta">
        <div class="am-item"><span class="am-val" id="amDur">—</span><span class="am-key">Duration</span></div>
        <div class="am-item"><span class="am-val" id="amSr">—</span><span class="am-key">Sample Rate</span></div>
        <div class="am-item"><span class="am-val" id="amCh">—</span><span class="am-key">Channels</span></div>
        <div class="am-item"><span class="am-val" id="amPeak">—</span><span class="am-key">Peak dBFS</span></div>
      </div>
    </div>

    <div class="div"></div>

    <!-- VU Meter -->
    <div class="meter-wrap">
      <div class="meter-top">
        <span class="meter-lbl">Уровень громкости</span>
        <span class="meter-val empty" id="meterVal">— LUFS</span>
      </div>
      <div class="vu" id="vu"></div>
      <div class="vu-scale">
        <span>−60</span><span>−48</span><span>−36</span><span>−24</span><span>−14</span><span>−9</span><span>0</span>
      </div>
      <div class="meter-correlation" id="meterCorrelation" aria-hidden="true"></div>
      <div class="lufs-timeline-wrap" id="lufsTimelineWrap" aria-hidden="true">
        <div class="lufs-timeline-lbl">LUFS по времени</div>
        <canvas id="lufsTimelineCanvas" class="lufs-timeline-canvas"></canvas>
      </div>
    </div>

    <!-- Streaming Loudness Preview Panel -->
    <div class="streaming-preview" id="streamingPreview" style="display:none;">
      <div class="streaming-preview-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/></svg>
        Streaming Preview
      </div>
      <div class="streaming-preview-grid" id="streamingPreviewGrid"></div>
    </div>

    <button type="button" class="btn btn-secondary" id="btnMeasure" disabled>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
      </svg>
      <span data-i18n="app.measure">Измерить громкость</span>
    </button>
    <span class="report-actions" id="reportActions" style="display:none;">
      <button type="button" class="btn btn-sm btn-report" id="btnDownloadReport" title="Скачать отчёт (TXT)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        <span data-i18n="app.download_report">Скачать отчёт</span>
      </button>
      <button type="button" class="btn-report-json" id="btnDownloadReportJson" title="Скачать отчёт в формате JSON">JSON</button>
      <button type="button" class="btn-report-json" id="btnDownloadReportPdf" title="Экспортировать отчёт в PDF">PDF</button>
      <button type="button" class="btn btn-sm btn-ai-report" id="btnAiReport" title="AI: краткое описание и рекомендации по треку">✨ AI отчёт</button>
    </span>
    <div class="ai-report-result" id="aiReportResult" style="display:none">
      <div class="ai-report-summary" id="aiReportSummary"></div>
      <ul class="ai-report-recs" id="aiReportRecs"></ul>
    </div>
    <div class="status" id="stMeasure"></div>

    <!-- AI помощники: видимая секция при загруженном файле -->
    <div class="ai-helpers-section" id="aiHelpersSection" style="display:none">
      <div class="ai-helpers-title">
        <span class="ai-helpers-icon">✨</span>
        <span>AI помощники</span>
      </div>
      <p class="ai-helpers-desc">Подбор стиля и громкости по треку, авто-мастеринг в один клик, отчёт и чат.</p>
      <div class="ai-helpers-btns">
        <button type="button" class="btn btn-ai-primary" id="btnAiRecommendHero" title="Подобрать стиль и LUFS по анализу">
          <span class="btn-ai-icon">✨</span> Рекомендовать пресет
        </button>
        <button type="button" class="btn btn-ai-primary" id="btnAutoMasterHero" title="Анализ → настройки → мастеринг автоматически">
          <span class="btn-ai-icon">⚡</span> Авто-мастеринг
        </button>
      </div>
      <div class="ai-helpers-more">
        После замера громкости: <strong>AI отчёт</strong> · В блоке «Параметры»: <strong>настройки голосом</strong>
      </div>
      <div class="ai-helpers-chat-row">
        <button type="button" class="btn btn-ai-outline" id="btnChatHelper" title="Открыть чат с AI-помощником по мастерингу">
          <span class="btn-ai-icon">💬</span> Чат-помощник
        </button>
        <span class="ai-fab-hint">или кнопка в правом нижнем углу</span>
      </div>
      <div class="ai-helpers-limits" id="aiHelpersLimits"></div>
    </div>
  </div>

  <!-- ──── CARD 2: SETTINGS + MASTER ──── -->
  <div class="card">
    <div class="card-hd">
      <div class="card-hd-left">
        <div class="card-ico">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"/>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M4.93 4.93a10 10 0 0 0 0 14.14"/>
          </svg>
        </div>
        <span class="card-ttl">Параметры</span>
      </div>
    </div>

    <div class="settings">
      <!-- Style Cards -->
      <div class="field">
        <span class="f-lbl">Жанр / Стиль</span>
        <div class="style-grid" id="styleGrid">
          <div class="style-card active" data-style="standard" data-lufs="-14"
               style="--sc-color:rgba(108,75,255,.1);--sc-active-border:#6c4bff;--sc-bg:rgba(108,75,255,.12);--sc-glow:rgba(108,75,255,.3)">
            <div class="sc-icon">🎵</div>
            <div class="sc-name">Stream</div>
            <div class="sc-lufs">−14 LUFS</div>
          </div>
          <div class="style-card" data-style="edm" data-lufs="-9" data-tier="pro"
               style="--sc-color:rgba(34,211,238,.08);--sc-active-border:#22d3ee;--sc-bg:rgba(34,211,238,.1);--sc-glow:rgba(34,211,238,.25)">
            <div class="sc-icon">⚡</div>
            <div class="sc-name">EDM</div>
            <div class="sc-lufs">−9 LUFS</div>
            <div class="sc-lock">🔒 Pro</div>
          </div>
          <div class="style-card" data-style="hiphop" data-lufs="-13" data-tier="pro"
               style="--sc-color:rgba(251,191,36,.08);--sc-active-border:#fbbf24;--sc-bg:rgba(251,191,36,.1);--sc-glow:rgba(251,191,36,.25)">
            <div class="sc-icon">🎤</div>
            <div class="sc-name">Hip-Hop</div>
            <div class="sc-lufs">−13 LUFS</div>
            <div class="sc-lock">🔒 Pro</div>
          </div>
          <div class="style-card" data-style="classical" data-lufs="-18" data-tier="pro"
               style="--sc-color:rgba(167,139,250,.08);--sc-active-border:#a78bfa;--sc-bg:rgba(167,139,250,.1);--sc-glow:rgba(167,139,250,.25)">
            <div class="sc-icon">🎻</div>
            <div class="sc-name">Classical</div>
            <div class="sc-lufs">−18 LUFS</div>
            <div class="sc-lock">🔒 Pro</div>
          </div>
          <div class="style-card" data-style="podcast" data-lufs="-16" data-tier="pro"
               style="--sc-color:rgba(52,211,153,.08);--sc-active-border:#34d399;--sc-bg:rgba(52,211,153,.1);--sc-glow:rgba(52,211,153,.25)">
            <div class="sc-icon">🎙</div>
            <div class="sc-name">Podcast</div>
            <div class="sc-lufs">−16 LUFS</div>
            <div class="sc-lock">🔒 Pro</div>
          </div>
          <div class="style-card" data-style="lofi" data-lufs="-18" data-tier="pro"
               style="--sc-color:rgba(248,113,113,.07);--sc-active-border:#f87171;--sc-bg:rgba(248,113,113,.09);--sc-glow:rgba(248,113,113,.22)">
            <div class="sc-icon">🌙</div>
            <div class="sc-name">Lo-fi</div>
            <div class="sc-lufs">−18 LUFS</div>
            <div class="sc-lock">🔒 Pro</div>
          </div>
          <div class="style-card" data-style="house_basic" data-lufs="-10" data-tier="pro"
               style="--sc-color:rgba(251,146,60,.08);--sc-active-border:#fb923c;--sc-bg:rgba(251,146,60,.1);--sc-glow:rgba(251,146,60,.28)">
            <div class="sc-icon">🏠</div>
            <div class="sc-name">House</div>
            <div class="sc-lufs">−10 LUFS</div>
            <div class="sc-ozone-badge">Ozone 5</div>
            <div class="sc-lock">🔒 Pro</div>
          </div>
        </div>
      </div>

      <!-- AI помощники: рекомендация и авто-мастеринг -->
      <div class="field ai-actions-wrap" id="aiActionsWrap" style="display:none">
        <span class="f-lbl">✨ AI помощники</span>
        <div class="ai-actions">
          <button type="button" class="btn btn-sm btn-ai" id="btnAiRecommend" title="Подобрать стиль и LUFS по анализу трека">
            <span class="btn-ai-icon">✨</span> AI рекомендует
          </button>
          <button type="button" class="btn btn-sm btn-ai" id="btnAutoMaster" title="Анализ → подбор настроек → мастеринг в один клик">
            <span class="btn-ai-icon">⚡</span> Авто-мастеринг
          </button>
          <span class="ai-limits" id="aiLimitsHint"></span>
        </div>
      </div>
      <!-- Настройки голосом (AI NL→config) — видимо в Параметрах -->
      <div class="field nl-config-inline" id="nlConfigInline" style="display:none">
        <span class="f-lbl">✨ Настройки голосом</span>
        <p class="nl-inline-desc">Опишите желаемые изменения — AI подстроит параметры цепочки.</p>
        <div class="nl-config-row">
          <input type="text" id="nlConfigInputInline" placeholder="Например: сделай потише, больше воздуха, меньше сибилянтов" maxlength="300">
          <button type="button" class="btn btn-sm btn-ai" id="btnNlConfigInline">Применить</button>
        </div>
      </div>
      <!-- Target LUFS + custom override -->
      <div class="field">
        <span class="f-lbl">Целевой LUFS</span>
        <div class="two-col">
          <input type="number" id="targetLufsInput" value="-14" min="-60" max="-1" step="0.5"
                 title="Задаётся автоматически по стилю. Можно изменить вручную.">
          <select id="outFormat">
            <option value="wav">WAV — без потерь</option>
            <option value="mp3" data-tier="pro">MP3 — 320 kbps 🔒</option>
            <option value="flac" data-tier="pro">FLAC — без потерь 🔒</option>
            <option value="opus" data-tier="pro">OPUS — 192 kbps 🔒</option>
            <option value="aac" data-tier="pro">AAC — 192 kbps (M4A) 🔒</option>
          </select>
        </div>
      </div>
      <!-- Reference Track Mastering -->
      <div class="field">
        <span class="f-lbl">Reference Track <span class="badge-new">NEW</span></span>
        <div class="reference-track-wrap">
          <label class="btn btn-sm btn-reference" id="btnRefLabel" title="Загрузите эталонный трек для подгонки спектрального баланса">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Загрузить эталон
            <input type="file" id="refFileInput" accept=".wav,.mp3,.flac" style="display:none;">
          </label>
          <span class="ref-file-name" id="refFileName">не выбран</span>
          <button type="button" class="btn-ref-clear" id="btnRefClear" style="display:none;" title="Убрать эталон" aria-label="Убрать эталонный трек">✕</button>
        </div>
        <div class="ref-strength-wrap" id="refStrengthWrap" style="display:none;">
          <label class="f-lbl-sm">Интенсивность</label>
          <input type="range" id="refStrength" min="0" max="100" value="80" step="5">
          <span id="refStrengthVal">80%</span>
        </div>
      </div>

      <!-- ═══ PRO PROCESSING MODULES ═══ -->
      <div class="pro-section-wrap" id="proSectionWrap">
        <div class="pro-section-head" id="proSectionHead">
          <span class="pro-section-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
          </span>
          <span class="pro-section-title">Дополнительная обработка</span>
          <span class="pro-section-badge">PRO</span>
          <span class="pro-section-chevron" id="proSectionChevron">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
          </span>
        </div>
        <div class="pro-section-body" id="proSectionBody">
          <div class="pro-modules-list">

            <!-- Spectral Denoiser -->
            <div class="pro-module" data-pro="denoiser" id="modDenoiser">
              <div class="pro-module-head">
                <div class="pro-module-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 18v-6a9 9 0 0 1 18 0v6"/><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/></svg>
                </div>
                <div class="pro-module-info">
                  <div class="pro-module-name">Spectral Denoiser</div>
                  <div class="pro-module-desc">Wiener-фильтр: удаляет шум фона без артефактов</div>
                </div>
                <label class="pro-module-toggle" title="Включить шумоподавление">
                  <input type="checkbox" id="denoiserEnabled">
                  <span class="pro-toggle-track"></span>
                </label>
              </div>
              <div class="pro-module-body" id="denoiserBody">
                <div class="pro-select-row">
                  <span class="pro-slider-label">Пресет</span>
                  <select id="denoiserPreset" class="pro-select" title="Лёгкий / Средний / Агрессивный или свой уровень">
                    <option value="">Свой</option>
                    <option value="light">Лёгкий</option>
                    <option value="medium" selected>Средний</option>
                    <option value="aggressive">Агрессивный</option>
                  </select>
                </div>
                <div class="pro-slider-row">
                  <span class="pro-slider-label">Сила</span>
                  <input type="range" id="denoiserStrength" min="0" max="100" value="40" step="5">
                  <span class="pro-slider-val" id="denoiserStrVal">40%</span>
                </div>
              </div>
            </div>

            <!-- De-esser -->
            <div class="pro-module" data-pro="deesser" id="modDeesser">
              <div class="pro-module-head">
                <div class="pro-module-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M9 9h.01M15 9h.01M9.5 15.5s1.5 2 3 0"/></svg>
                </div>
                <div class="pro-module-info">
                  <div class="pro-module-name">De-esser</div>
                  <div class="pro-module-desc">Контроль сибилянтности 5–9 кГц (ss, ff, tt)</div>
                </div>
                <label class="pro-module-toggle" title="Включить де-эссер">
                  <input type="checkbox" id="deesserEnabled">
                  <span class="pro-toggle-track"></span>
                </label>
              </div>
              <div class="pro-module-body" id="deesserBody">
                <div class="pro-slider-row">
                  <span class="pro-slider-label">Порог</span>
                  <input type="range" id="deesserThreshold" min="-30" max="-5" value="-10" step="1">
                  <span class="pro-slider-val" id="deesserThrVal">−10 dB</span>
                </div>
              </div>
            </div>

            <!-- Transient Designer -->
            <div class="pro-module" data-pro="transient" id="modTransient">
              <div class="pro-module-head">
                <div class="pro-module-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                </div>
                <div class="pro-module-info">
                  <div class="pro-module-name">Transient Designer</div>
                  <div class="pro-module-desc">Независимый контроль атаки и сустейна</div>
                </div>
                <label class="pro-module-toggle" title="Включить Transient Designer">
                  <input type="checkbox" id="transientEnabled">
                  <span class="pro-toggle-track"></span>
                </label>
              </div>
              <div class="pro-module-body" id="transientBody">
                <div class="pro-slider-row">
                  <span class="pro-slider-label">Атака</span>
                  <input type="range" id="transientAttack" min="50" max="200" value="100" step="5">
                  <span class="pro-slider-val" id="transientAttackVal">1.0×</span>
                </div>
                <div class="pro-slider-row">
                  <span class="pro-slider-label">Сустейн</span>
                  <input type="range" id="transientSustain" min="50" max="200" value="100" step="5">
                  <span class="pro-slider-val" id="transientSustainVal">1.0×</span>
                </div>
              </div>
            </div>

            <!-- Parallel Compression -->
            <div class="pro-module" data-pro="parallel" id="modParallel">
              <div class="pro-module-head">
                <div class="pro-module-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                </div>
                <div class="pro-module-info">
                  <div class="pro-module-name">Parallel Compression</div>
                  <div class="pro-module-desc">NY-компрессия: гущина без потери динамики</div>
                </div>
                <label class="pro-module-toggle" title="Включить параллельную компрессию">
                  <input type="checkbox" id="parallelEnabled">
                  <span class="pro-toggle-track"></span>
                </label>
              </div>
              <div class="pro-module-body" id="parallelBody">
                <div class="pro-slider-row">
                  <span class="pro-slider-label">Mix</span>
                  <input type="range" id="parallelMix" min="0" max="100" value="30" step="5">
                  <span class="pro-slider-val" id="parallelMixVal">30%</span>
                </div>
              </div>
            </div>

            <!-- Dynamic EQ -->
            <div class="pro-module" data-pro="dynEQ" id="modDynEQ">
              <div class="pro-module-head">
                <div class="pro-module-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M7 16c2-2 4-8 6-8s4 6 6 8"/></svg>
                </div>
                <div class="pro-module-info">
                  <div class="pro-module-name">Dynamic EQ</div>
                  <div class="pro-module-desc">8-полосный EQ, реагирующий на уровень сигнала</div>
                </div>
                <label class="pro-module-toggle" title="Включить Dynamic EQ">
                  <input type="checkbox" id="dynEQEnabled">
                  <span class="pro-toggle-track"></span>
                </label>
              </div>
              <div class="pro-module-body" id="dynEQBody">
                <div style="font-size:.64rem;color:var(--text-dim);line-height:1.5;padding:.1rem 0;">
                  Автоматически обрабатывает 8 полос: 60, 120, 250, 500, 1k, 3k, 8k, 16k Гц.
                  Мягко подавляет резонансы и подчёркивает детали только там, где это нужно.
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Export: dither (WAV/16-bit), auto-blank -->
      <div class="field export-opts">
        <span class="f-lbl">Экспорт (WAV/16-bit)</span>
        <div class="two-col">
          <label class="export-opt">
            <span class="export-opt-lbl">Дизеринг</span>
            <select id="ditherType" title="TPDF — стандарт, Noise-shaped / ITU — шейпинг шума">
              <option value="tpdf">TPDF</option>
              <option value="ns_e">Noise-shaped (E)</option>
              <option value="ns_itu">Noise-shaped (ITU)</option>
            </select>
          </label>
          <label class="export-opt">
            <span class="export-opt-lbl">Обрезка тишины (сек)</span>
            <select id="autoBlankSec" title="Обрезать тишину в конце файла">
              <option value="0">0</option>
              <option value="0.5">0.5</option>
              <option value="1">1</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <!-- Модули цепочки (по стилю и target LUFS) -->
    <div class="chain-modules-card" id="chainModulesCard">
      <div class="chain-modules-head" id="chainModulesHead">
        <span class="chain-modules-ttl">Цепочка модулей</span>
        <span class="chain-modules-chevron" id="chainModulesChevron">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
        </span>
      </div>
      <div class="chain-modules-body" id="chainModulesBody">
        <div class="chain-modules-list" id="chainModulesList"></div>
        <!-- P25: NL→настройки (только при загруженном файле, pro/debug) -->
        <div class="nl-config-wrap" id="nlConfigWrap" style="display:none">
          <div class="nl-config-label">✨ AI: описать изменения</div>
          <div class="nl-config-row">
            <input type="text" id="nlConfigInput" placeholder="Например: сделай потише, больше воздуха" maxlength="300">
            <button type="button" class="btn-nl" id="btnNlConfig">Применить</button>
          </div>
        </div>
        <!-- P10: сохранённые пресеты (только для залогиненных) -->
        <div class="chain-presets-wrap" id="chainPresetsWrap" style="display:none;">
          <div class="chain-presets-row">
            <input type="text" id="chainPresetName" class="chain-preset-name" placeholder="Имя пресета" maxlength="120">
            <button type="button" id="btnChainPresetSave" class="btn btn-sm chain-preset-btn">Сохранить пресет</button>
          </div>
          <div class="chain-presets-row">
            <select id="chainPresetSelect" class="chain-preset-select" title="Выберите пресет для загрузки">
              <option value="">— Загрузить пресет —</option>
            </select>
            <button type="button" id="btnChainPresetLoad" class="btn btn-sm chain-preset-btn">Загрузить</button>
            <button type="button" id="btnChainPresetDelete" class="btn btn-sm chain-preset-btn chain-preset-delete" title="Удалить выбранный пресет">Удалить</button>
          </div>
        </div>
      </div>
    </div>

    <button type="button" class="btn btn-primary" id="btnMaster" disabled>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polygon points="5 3 19 12 5 21 5 3"/>
      </svg>
      <span id="btnMasterTxt">Запустить мастеринг</span>
    </button>

    <!-- Pipeline steps -->
    <div class="pipeline" id="pipeline">
      <div class="pipe-step" data-step="dc">
        <div class="pipe-step-dot"></div>
        <span class="pipe-step-label">Удаление DC-смещения</span>
        <span class="pipe-step-check">✓</span>
      </div>
      <div class="pipe-step" data-step="eq">
        <div class="pipe-step-dot"></div>
        <span class="pipe-step-label">Студийный EQ (Ozone 5 Equalizer)</span>
        <span class="pipe-step-check">✓</span>
      </div>
      <div class="pipe-step" data-step="dyn">
        <div class="pipe-step-dot"></div>
        <span class="pipe-step-label">Многополосная динамика (Ozone 5 Dynamics)</span>
        <span class="pipe-step-check">✓</span>
      </div>
      <div class="pipe-step" data-step="lufs">
        <div class="pipe-step-dot"></div>
        <span class="pipe-step-label">Нормализация LUFS</span>
        <span class="pipe-step-check">✓</span>
      </div>
      <div class="pipe-step" data-step="final">
        <div class="pipe-step-dot"></div>
        <span class="pipe-step-label">Финальная частотная коррекция</span>
        <span class="pipe-step-check">✓</span>
      </div>
      <div class="pipe-step" id="pipeExciter" data-step="exciter" style="display:none">
        <div class="pipe-step-dot"></div>
        <span class="pipe-step-label">Гармонический эксайтер (Ozone 5 Exciter)</span>
        <span class="pipe-step-check">✓</span>
      </div>
      <div class="pipe-step" id="pipeImager" data-step="imager" style="display:none">
        <div class="pipe-step-dot"></div>
        <span class="pipe-step-label">Стерео-расширение (Ozone 5 Imager)</span>
        <span class="pipe-step-check">✓</span>
      </div>
    </div>

    <!-- Progress -->
    <div class="prog-wrap" id="progWrap" role="status" aria-live="polite" aria-label="Прогресс мастеринга">
      <div class="prog-hd">
        <span class="prog-msg" id="progMsg">Подготовка…</span>
        <span class="prog-pct"><span id="progPct">0</span>%</span>
      </div>
      <div class="prog-track"><div class="prog-fill" id="progFill"></div></div>
    </div>

    <!-- Before/After result panel -->
    <div class="result-panel" id="resultPanel">
      <div class="result-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
        Результат мастеринга
      </div>
      <div class="result-grid">
        <div class="result-block">
          <div class="result-block-lbl">До</div>
          <div class="result-block-val before" id="rBefore">—</div>
        </div>
        <div class="result-arrow">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/>
          </svg>
        </div>
        <div class="result-block">
          <div class="result-block-lbl">После</div>
          <div class="result-block-val after" id="rAfter">—</div>
        </div>
      </div>
      <div class="result-delta" id="rDelta"></div>
    </div>

    <!-- A/B Audio Player (P45) -->
    <div class="ab-player-wrap" id="abPlayerWrap">
      <div class="ab-player-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
        Прослушать до / после
      </div>
      <div class="ab-player-controls">
        <button class="ab-play-btn" id="abPlayBtn" title="Play / Pause">
          <svg id="abPlayIcon" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        </button>
        <span class="ab-time" id="abTimeCur">0:00</span>
        <div class="ab-progress-wrap" id="abProgressWrap">
          <div class="ab-progress-fill" id="abProgressFill"></div>
        </div>
        <span class="ab-time" id="abTimeDur">0:00</span>
        <div class="ab-vol-wrap">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="13" height="13"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/></svg>
          <input type="range" id="abVolSlider" min="0" max="1" step="0.02" value="0.8">
        </div>
        <div class="ab-switch">
          <button class="ab-switch-btn active" id="abSrcOrig" title="Оригинал до мастеринга">A — оригинал</button>
          <button class="ab-switch-btn" id="abSrcMast" title="После мастеринга">B — мастер</button>
        </div>
      </div>
      <!-- Native audio element (hidden) — управляется JS -->
      <audio id="abAudio" preload="auto" style="display:none"></audio>
    </div>

    <!-- DAW-style waveform comparison (Original vs Mastered) -->
    <div class="daw-card" id="dawCard">
      <div class="daw-head">
        <span class="daw-ttl">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
          Сравнение до / после
        </span>
      </div>
      <div class="daw-ruler-wrap">
        <canvas class="daw-ruler" id="dawRuler" width="400" height="20"></canvas>
      </div>
      <div class="daw-tracks">
        <div class="daw-track a">
          <span class="daw-track-label">A — оригинал</span>
          <canvas class="daw-track-canvas" id="dawCanvasA" width="400" height="52"></canvas>
        </div>
        <div class="daw-track b">
          <span class="daw-track-label">B — мастер</span>
          <canvas class="daw-track-canvas" id="dawCanvasB" width="400" height="52"></canvas>
        </div>
      </div>
      <div class="daw-stats-row">
        <div class="daw-stat a">
          <span class="daw-stat-lbl">A · LUFS</span>
          <span class="daw-stat-val" id="dawStatLufsA">—</span>
        </div>
        <div class="daw-stat b">
          <span class="daw-stat-lbl">B · LUFS</span>
          <span class="daw-stat-val" id="dawStatLufsB">—</span>
        </div>
      </div>
    </div>

    <!-- Spectrum analyzer (log scale 20 Hz – 20 kHz) -->
    <div class="spectrum-card" id="spectrumCard">
      <div class="spectrum-head" id="spectrumHead" style="display:flex;align-items:center;">
        <span class="spectrum-ttl">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
          Спектр
        </span>
      </div>
      <div class="spectrum-ruler">
        <span>20 Hz</span>
        <span>20 kHz</span>
      </div>
      <canvas class="spectrum-canvas" id="spectrumCanvas" width="400" height="80"></canvas>
    </div>

    <!-- Vectorscope (Lissajous L vs R) -->
    <div class="vectorscope-card" id="vectorscopeCard">
      <div class="vectorscope-head">
        <span class="vectorscope-ttl">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
          Векторскоп
        </span>
      </div>
      <p class="vectorscope-hint">Показывает соотношение левого и правого каналов (L–R). Узкая диагональ — близко к моно; широкое облако — широкое стерео. Помогает оценить ширину сцены и фазу.</p>
      <canvas class="vectorscope-canvas" id="vectorscopeCanvas" width="200" height="200"></canvas>
    </div>

    <div class="status" id="stMaster"></div>
  </div>

  <!-- ──── HISTORY ──── -->
  <div class="hist-card" id="histCard">
    <div class="hist-head" id="histHead">
      <div class="hist-head-left">
        <div class="card-ico">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 8 14"/></svg>
        </div>
        <span class="hist-ttl">История</span>
        <span class="hist-count" id="histCount">0</span>
      </div>
      <div class="hist-chevron" id="histChevron">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
    </div>
    <div class="hist-body" id="histBody">
      <div class="hist-list" id="histList"></div>
      <button class="hist-clear" id="histClear">Очистить историю</button>
    </div>
  </div>

  <!-- ──── FOOTER ──── -->
  <footer class="footer">
    <div class="specs">
      <div class="spec"><span class="spec-v">−1 dBTP</span><span class="spec-k">True Peak</span></div>
      <div class="spec"><span class="spec-v">TPDF</span><span class="spec-k">Dithering</span></div>
      <div class="spec"><span class="spec-v">4-band</span><span class="spec-k">Compression</span></div>
      <div class="spec"><span class="spec-v">Studio EQ</span><span class="spec-k">Pipeline</span></div>
      <div class="spec"><span class="spec-v">Sony/Warner</span><span class="spec-k">Standard</span></div>
    </div>
    <p class="foot-txt">Magic Master <span id="appVersion" class="foot-version"></span> · Профессиональный аудиомастеринг в браузере · <a href="/progress.html" target="_blank" rel="noopener" class="foot-link">Статус плана</a> · <a href="/docs" target="_blank" rel="noopener" class="foot-link">API</a></p>
  </footer>

</div><!-- /page -->

<!-- Toast container -->
<div class="toast-wrap" id="toastWrap" role="region" aria-label="Уведомления" aria-live="polite"></div>

<!-- Page-wide drop overlay -->
<div class="drop-overlay" id="dropOverlay">
  <div class="drop-overlay-box">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>
    </svg>
    <div class="drop-overlay-txt">Отпустите файл</div>
    <div class="drop-overlay-hint">WAV · MP3 · FLAC</div>
  </div>
</div>

<!-- Кнопка чата (FAB) и панель AI-помощника — показываются при загруженном файле -->
<button class="chat-fab" id="chatFab" title="Чат с AI-помощником по мастерингу" style="display:none" aria-label="Открыть чат">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
  </svg>
</button>
<div class="chat-panel" id="chatPanel">
  <div class="chat-panel-hd">
    <span>✨ AI-помощник</span>
    <button id="chatClose" aria-label="Закрыть чат">×</button>
  </div>
  <div class="chat-pro-notice" id="chatProNotice" style="display:none">
    Чат доступен в тарифах Pro и Studio. <a href="/pricing" class="chat-pro-link">Перейти на тарифы</a>
  </div>
  <div class="chat-msgs" id="chatMsgs">
    <div class="chat-msg system">Спросите что-нибудь о мастеринге треков</div>
  </div>
  <div class="chat-input-row">
    <input type="text" id="chatInput" placeholder="Ваш вопрос…" maxlength="500" autocomplete="off">
    <button class="chat-send-btn" id="chatSend" aria-label="Отправить сообщение">↑</button>
  </div>
</div>

<!-- Upgrade Modal -->
<div class="upgrade-overlay" id="upgradeOverlay" role="dialog" aria-modal="true" aria-labelledby="upgradeTitle">
  <div class="upgrade-box">
    <button class="upgrade-close" id="upgradeClose" aria-label="Закрыть">✕</button>
    <div class="upgrade-icon" id="upgradeModalIcon">⚡</div>
    <h3 class="upgrade-title" id="upgradeTitle">Это функция Pro</h3>
    <p class="upgrade-desc" id="upgradeDesc">Жанровые пресеты EDM, Hip-Hop, Classical, Podcast, Lo-fi, House и экспорт MP3/FLAC доступны в тарифах Pro и Studio.</p>
    <div class="upgrade-features">
      <div class="upgrade-feature">Все жанровые пресеты (7 стилей)</div>
      <div class="upgrade-feature">Экспорт MP3 и FLAC</div>
      <div class="upgrade-feature">Безлимитное количество мастерингов</div>
      <div class="upgrade-feature">Расширенный редактор цепочки</div>
    </div>
    <div class="upgrade-btns">
      <a href="/pricing" class="btn-go-pro">Смотреть тарифы Pro →</a>
      <button type="button" class="btn-stay-free" id="upgradeCancel">Остаться на Free</button>
    </div>
  </div>
</div>

<script src="app.js"></script>
<!-- Inline script extracted to app.js; uncomment below if app.js is missing
<script>
/* ═══════ DOM ═══════ */
const API         = '';
const wdeco       = document.getElementById('wdeco');
const drop        = document.getElementById('drop');
const fileInput   = document.getElementById('fileInput');
const fileInfo    = document.getElementById('fileInfo');
const fileName    = document.getElementById('fileName');
const fileMeta    = document.getElementById('fileMeta');
const btnReset    = document.getElementById('btnReset');
const playerEl    = document.getElementById('player');
const waveWrap    = document.getElementById('waveWrap');
const waveCanvas  = document.getElementById('waveCanvas');
const btnPP       = document.getElementById('btnPP');
const iconPlay    = document.getElementById('iconPlay');
const iconPause   = document.getElementById('iconPause');
const tElapsed    = document.getElementById('tElapsed');
const tTotal      = document.getElementById('tTotal');
const tScrub      = document.getElementById('tScrub');
const tFill       = document.getElementById('tFill');
const audioMeta   = document.getElementById('audioMeta');
const amDur       = document.getElementById('amDur');
const amSr        = document.getElementById('amSr');
const amCh        = document.getElementById('amCh');
const amPeak      = document.getElementById('amPeak');
const vu          = document.getElementById('vu');
const meterVal    = document.getElementById('meterVal');
const btnMeasure  = document.getElementById('btnMeasure');
const stMeasure   = document.getElementById('stMeasure');
const outFormat   = document.getElementById('outFormat');
const styleGrid     = document.getElementById('styleGrid');
const targetLufsInput= document.getElementById('targetLufsInput');
const abWrap        = document.getElementById('abWrap');
const btnABa        = document.getElementById('btnAB-a');
const btnABb        = document.getElementById('btnAB-b');
const btnMaster     = document.getElementById('btnMaster');
const btnMasterTxt  = document.getElementById('btnMasterTxt');

let selectedStyle   = 'standard';
let masteredBuffer  = null;  // decoded AudioBuffer of mastered file
let abMode          = 'a';   // 'a' = original, 'b' = mastered
const pipeline    = document.getElementById('pipeline');
const progWrap    = document.getElementById('progWrap');
const progFill    = document.getElementById('progFill');
const progPct     = document.getElementById('progPct');
const progMsg     = document.getElementById('progMsg');
const resultPanel = document.getElementById('resultPanel');
const rBefore     = document.getElementById('rBefore');
const rAfter      = document.getElementById('rAfter');
const rDelta      = document.getElementById('rDelta');
const stMaster    = document.getElementById('stMaster');
const dawCard     = document.getElementById('dawCard');
const dawRuler    = document.getElementById('dawRuler');
const dawCanvasA  = document.getElementById('dawCanvasA');
const dawCanvasB  = document.getElementById('dawCanvasB');
const dawStatLufsA= document.getElementById('dawStatLufsA');
const dawStatLufsB= document.getElementById('dawStatLufsB');

let currentFile = null;

/* ═══════ CANVAS RESIZE OBSERVER ═══════ */
const canvasRO = new ResizeObserver(() => {
  if (audioBuffer) drawWaveform(getCurrentFrac());
  if (dawCard.classList.contains('visible') && lastDawState) {
    showDawComparison(lastDawState.origBuf, lastDawState.masteredBuf, lastDawState.lufsA, lastDawState.lufsB);
  }
});
canvasRO.observe(waveCanvas);
if (dawCard) canvasRO.observe(dawCard);

function getCurrentFrac() {
  if (!audioBuffer) return 0;
  if (isPlaying) return Math.min(1, (getCtx().currentTime - startedAt) / audioBuffer.duration);
  return pauseOffset > 0 ? Math.min(1, pauseOffset / audioBuffer.duration) : 0;
}

/* ═══════ TOASTS ═══════ */
const toastWrap = document.getElementById('toastWrap');

/**
 * Преобразует техническое сообщение об ошибке в читаемый текст.
 * Для ошибок ffprobe/ffmpeg добавляет инструкцию по установке.
 */
function friendlyError(msg) {
  if (!msg) return msg;
  if (msg.includes('ffprobe') || msg.includes('ffmpeg') || msg.includes('ffmpeg')) {
    const base = msg.replace(/\[Errno \d+\][^.]*\.\s*/g, '').trim();
    return base + ' → <code style="font-family:\'JetBrains Mono\',monospace;font-size:.85em;background:rgba(255,255,255,0.08);padding:1px 5px;border-radius:4px">sudo apt-get install -y ffmpeg</code>';
  }
  return msg;
}

function toast(msg, type = 'inf', dur = 3000) {
  const icons = {
    ok:  '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>',
    err: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
    inf: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="8"/><line x1="12" y1="12" x2="12" y2="16"/></svg>',
  };
  const el = document.createElement('div');
  el.className = `toast toast-${type}`;
  el.innerHTML = icons[type] + `<span>${msg}</span>`;
  toastWrap.appendChild(el);
  const remove = () => {
    el.classList.add('out');
    setTimeout(() => el.remove(), 260);
  };
  setTimeout(remove, dur);
  el.addEventListener('click', remove);
}

/* ═══════ PAGE-WIDE DRAG & DROP ═══════ */
const dropOverlay = document.getElementById('dropOverlay');
let dragDepth = 0;
document.addEventListener('dragenter', e => {
  e.preventDefault();
  dragDepth++;
  if (dragDepth === 1) dropOverlay.classList.add('visible');
});
document.addEventListener('dragleave', () => {
  dragDepth--;
  if (dragDepth <= 0) { dragDepth = 0; dropOverlay.classList.remove('visible'); }
});
document.addEventListener('dragover', e => e.preventDefault());
document.addEventListener('drop', e => {
  e.preventDefault();
  dragDepth = 0;
  dropOverlay.classList.remove('visible');
  const f = e.dataTransfer?.files?.[0];
  if (f && /\.(wav|mp3|flac)$/i.test(f.name)) {
    setFile(f);
    toast('Файл загружен: ' + f.name, 'ok');
  } else if (f) {
    toast('Формат не поддерживается. Используйте WAV, MP3, FLAC', 'err');
  }
});

/* ═══════ HISTORY ═══════ */
const HIST_KEY  = 'mm_history_v1';
const HIST_MAX  = 8;
const histList  = document.getElementById('histList');
const histCount = document.getElementById('histCount');
const histBody  = document.getElementById('histBody');
const histHead  = document.getElementById('histHead');
const histChev  = document.getElementById('histChevron');
const histClear = document.getElementById('histClear');

function getHistory() {
  try { return JSON.parse(localStorage.getItem(HIST_KEY) || '[]'); }
  catch { return []; }
}
function saveToHistory(entry) {
  const h = getHistory();
  h.unshift(entry);
  if (h.length > HIST_MAX) h.length = HIST_MAX;
  try { localStorage.setItem(HIST_KEY, JSON.stringify(h)); } catch {}
  renderHistory();
}
function renderHistory() {
  const h = getHistory();
  histCount.textContent = h.length;
  if (!h.length) {
    histList.innerHTML = '<div class="hist-empty">Нет обработанных файлов</div>';
    return;
  }
  histList.innerHTML = h.map(e => {
    const delta = e.after != null && e.before != null
      ? (e.after - e.before).toFixed(1)
      : null;
    const sign = delta > 0 ? '+' : '';
    return `
    <div class="hist-entry">
      <div>
        <div class="he-name">${e.name}</div>
        <div class="he-meta">${e.fmt?.toUpperCase() || 'WAV'} · ${e.size || ''} · Цель ${e.target} LUFS</div>
      </div>
      <div>
        <div class="he-lufs">${e.after != null ? e.after.toFixed(1)+' LUFS' : '—'}${delta != null ? ' <span style="color:var(--text-dim);font-weight:400">('+sign+delta+' dB)</span>' : ''}</div>
        <div class="he-date">${e.date || ''}</div>
      </div>
    </div>`;
  }).join('');
}
function fmtDate(ts) {
  const d = new Date(ts);
  return d.toLocaleDateString('ru-RU', {day:'2-digit', month:'2-digit'}) + ' ' +
         d.toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'});
}

histHead.addEventListener('click', () => {
  const open = histBody.classList.toggle('open');
  histChev.classList.toggle('open', open);
});
histClear.addEventListener('click', e => {
  e.stopPropagation();
  try { localStorage.removeItem(HIST_KEY); } catch {}
  renderHistory();
  toast('История очищена', 'inf');
});

// Init
renderHistory();

/* ═══════ WEB AUDIO API ═══════ */
let audioCtx    = null;
let audioBuffer = null;   // decoded AudioBuffer
let srcNode     = null;   // current AudioBufferSourceNode
let isPlaying   = false;
let startedAt   = 0;      // audioCtx.currentTime when play started
let pauseOffset = 0;      // offset in seconds where we paused
let rafId       = null;

function getCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}

/* ─── Decode and draw ─── */
async function loadAudio(file) {
  try {
    const ctx = getCtx();
    const ab  = await file.arrayBuffer();
    audioBuffer = await ctx.decodeAudioData(ab);
    pauseOffset = 0;
    // Wait two frames so the player element has rendered and canvas has a size
    await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
    drawWaveform(0);
    updateTransport();
    // show meta row
    const dur = audioBuffer.duration;
    amDur.textContent  = fmtTime(dur);
    amSr.textContent   = (audioBuffer.sampleRate / 1000).toFixed(1) + ' kHz';
    amCh.textContent   = audioBuffer.numberOfChannels === 1 ? 'Mono' : 'Stereo';
    // peak dBFS from channel data
    let peak = 0;
    for (let c = 0; c < audioBuffer.numberOfChannels; c++) {
      const d = audioBuffer.getChannelData(c);
      for (let i = 0; i < d.length; i++) { const a = Math.abs(d[i]); if (a > peak) peak = a; }
    }
    amPeak.textContent = peak > 1e-9 ? (20 * Math.log10(peak)).toFixed(1) + ' dB' : '—';
    audioMeta.classList.add('visible');
    tTotal.textContent = fmtTime(dur);
    // Update file badge with duration
    fileMeta.textContent = fmtSize(file.size) + '  ·  ' + fmtTime(dur);
  } catch(e) {
    console.warn('Audio decode failed:', e);
  }
}

/* ─── Waveform drawing ─── */
function drawWaveform(playPosFrac) {
  if (!audioBuffer) return;
  const dpr = window.devicePixelRatio || 1;
  const rect = waveCanvas.getBoundingClientRect();
  const W = Math.floor(rect.width  * dpr) || 460 * dpr;
  const H = Math.floor(rect.height * dpr) || 58  * dpr;
  if (waveCanvas.width !== W || waveCanvas.height !== H) {
    waveCanvas.width  = W;
    waveCanvas.height = H;
  }
  const ctx = waveCanvas.getContext('2d');
  ctx.clearRect(0, 0, W, H);

  // Average channels
  const n  = audioBuffer.numberOfChannels;
  const len = audioBuffer.length;
  const spp = Math.max(1, Math.floor(len / W)); // samples per pixel
  const mid = H / 2;

  // Gradient: played = brighter accent, unplayed = dimmer
  const playedX = Math.floor(playPosFrac * W);

  for (let x = 0; x < W; x++) {
    const s0 = x * spp;
    let maxAmp = 0;
    for (let i = 0; i < spp; i++) {
      let sum = 0;
      for (let c = 0; c < n; c++) sum += Math.abs(audioBuffer.getChannelData(c)[s0 + i] || 0);
      const a = sum / n;
      if (a > maxAmp) maxAmp = a;
    }
    const h = Math.max(1, maxAmp * mid * 0.93);
    const played = x < playedX;
    ctx.fillStyle = played
      ? `rgba(108,75,255,${0.55 + maxAmp * 0.45})`
      : `rgba(108,75,255,${0.18 + maxAmp * 0.22})`;
    ctx.fillRect(x, mid - h, 1, h * 2);
  }

  // Playhead line
  if (playPosFrac > 0 && playPosFrac < 1) {
    const px = Math.floor(playPosFrac * W);
    ctx.fillStyle = 'rgba(255,255,255,0.75)';
    ctx.fillRect(px, 0, Math.max(1, dpr), H);
    // glow
    ctx.fillStyle = 'rgba(108,75,255,0.35)';
    ctx.fillRect(Math.max(0, px - 2 * dpr), 0, 4 * dpr, H);
  }
}

/* ─── DAW comparison (ruler, waveforms, stats) ─── */
let lastDawState = null;

function dawDrawWaveform(ctx, buffer, w, h, rgb) {
  if (!buffer || buffer.length === 0) return;
  const [r, g, b] = rgb;
  const n = buffer.numberOfChannels;
  const len = buffer.length;
  const spp = Math.max(1, Math.floor(len / w));
  const mid = h / 2;
  for (let x = 0; x < w; x++) {
    const s0 = x * spp;
    let maxAmp = 0;
    for (let i = 0; i < spp; i++) {
      let sum = 0;
      for (let c = 0; c < n; c++) sum += Math.abs(buffer.getChannelData(c)[s0 + i] || 0);
      maxAmp = Math.max(maxAmp, sum / n);
    }
    const barH = Math.max(1, maxAmp * mid * 0.92);
    ctx.fillStyle = `rgba(${r},${g},${b},${0.2 + maxAmp * 0.6})`;
    ctx.fillRect(x, mid - barH, 1, barH * 2);
  }
}

function dawDrawRuler(canvas, duration) {
  if (!duration || duration <= 0) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const w = canvas.width;
  const h = canvas.height;
  ctx.clearRect(0, 0, w, h);
  ctx.font = '10px JetBrains Mono, monospace';
  ctx.fillStyle = 'rgba(255,255,255,0.35)';
  ctx.textBaseline = 'top';
  const step = duration <= 30 ? 5 : duration <= 120 ? 15 : 30;
  for (let t = 0; t <= duration; t += step) {
    const x = (t / duration) * w;
    const m = Math.floor(t / 60), s = Math.floor(t % 60);
    const label = m + ':' + String(s).padStart(2, '0');
    ctx.fillText(label, x + 3, 2);
  }
}

function dawComputeStats(lufsA, lufsB) {
  dawStatLufsA.textContent = lufsA != null ? lufsA.toFixed(1) + ' LUFS' : '—';
  dawStatLufsB.textContent = lufsB != null ? lufsB.toFixed(1) + ' LUFS' : '—';
}

function showDawComparison(origBuf, masteredBuf, lufsA, lufsB) {
  if (!origBuf || !masteredBuf) return;
  lastDawState = { origBuf, masteredBuf, lufsA, lufsB };
  const wrap = dawRuler.parentElement;
  const width = wrap.getBoundingClientRect().width;
  const dpr = window.devicePixelRatio || 1;
  const W = Math.floor(width * dpr) || 400;
  const trackH = 52;
  const rulerH = 20;
  dawRuler.width = W;
  dawRuler.height = Math.floor(rulerH * dpr);
  dawCanvasA.width = W;
  dawCanvasA.height = Math.floor(trackH * dpr);
  dawCanvasB.width = W;
  dawCanvasB.height = Math.floor(trackH * dpr);

  const duration = Math.max(origBuf.duration, masteredBuf.duration);
  dawDrawRuler(dawRuler, duration);

  const ctxA = dawCanvasA.getContext('2d');
  ctxA.clearRect(0, 0, W, Math.floor(trackH * dpr));
  dawDrawWaveform(ctxA, origBuf, W, Math.floor(trackH * dpr), [108, 75, 255]);

  const ctxB = dawCanvasB.getContext('2d');
  ctxB.clearRect(0, 0, W, Math.floor(trackH * dpr));
  dawDrawWaveform(ctxB, masteredBuf, W, Math.floor(trackH * dpr), [52, 211, 153]);

  dawComputeStats(lufsA, lufsB);
  dawCard.classList.add('visible');
}

/* ─── Time formatting ─── */
function fmtTime(sec) {
  const s = Math.floor(sec);
  return Math.floor(s / 60) + ':' + String(s % 60).padStart(2, '0');
}

/* ─── Playback ─── */
function playFrom(offset) {
  if (!audioBuffer) return;
  const ctx = getCtx();
  if (ctx.state === 'suspended') ctx.resume();
  if (srcNode) { try { srcNode.stop(); } catch(e){} srcNode = null; }
  srcNode = ctx.createBufferSource();
  srcNode.buffer = audioBuffer;
  srcNode.connect(ctx.destination);
  srcNode.start(0, offset);
  startedAt   = ctx.currentTime - offset;
  isPlaying   = true;
  srcNode.onended = () => { if (isPlaying) stopAll(); };
  startRaf();
  updateTransport();
}

function pauseAudio() {
  if (!isPlaying) return;
  pauseOffset = getCtx().currentTime - startedAt;
  if (srcNode) { try { srcNode.stop(); } catch(e){} srcNode = null; }
  isPlaying = false;
  stopRaf();
  updateTransport();
}

function stopAll() {
  pauseOffset = 0; isPlaying = false;
  if (srcNode) { try { srcNode.stop(); } catch(e){} srcNode = null; }
  stopRaf();
  drawWaveform(0);
  tElapsed.textContent = '0:00';
  tFill.style.width = '0%';
  updateTransport();
}

function togglePlay() {
  if (!audioBuffer) return;
  if (isPlaying) pauseAudio(); else playFrom(pauseOffset);
}

function updateTransport() {
  iconPlay.style.display  = isPlaying ? 'none'  : '';
  iconPause.style.display = isPlaying ? '' : 'none';
}

/* ─── RAF loop ─── */
function startRaf() {
  stopRaf();
  function loop() {
    if (!isPlaying || !audioBuffer) return;
    const pos = (getCtx().currentTime - startedAt);
    const dur = audioBuffer.duration;
    const frac = Math.min(1, pos / dur);
    drawWaveform(frac);
    tElapsed.textContent = fmtTime(Math.min(pos, dur));
    tFill.style.width = (frac * 100).toFixed(2) + '%';
    waveWrap.setAttribute('data-time', fmtTime(Math.min(pos, dur)));
    rafId = requestAnimationFrame(loop);
  }
  rafId = requestAnimationFrame(loop);
}
function stopRaf() { if (rafId) { cancelAnimationFrame(rafId); rafId = null; } }

/* ─── Click on waveform to seek ─── */
waveWrap.addEventListener('click', e => {
  if (!audioBuffer) return;
  const rect = waveWrap.getBoundingClientRect();
  const frac = (e.clientX - rect.left) / rect.width;
  const newOffset = frac * audioBuffer.duration;
  pauseOffset = newOffset;
  if (isPlaying) playFrom(newOffset);
  else { drawWaveform(frac); tElapsed.textContent = fmtTime(newOffset); tFill.style.width = (frac*100)+'%'; }
});

/* ─── Click on scrub bar ─── */
tScrub.addEventListener('click', e => {
  if (!audioBuffer) return;
  const rect = tScrub.getBoundingClientRect();
  const frac = (e.clientX - rect.left) / rect.width;
  const newOffset = frac * audioBuffer.duration;
  pauseOffset = newOffset;
  if (isPlaying) playFrom(newOffset);
  else { drawWaveform(frac); tElapsed.textContent = fmtTime(newOffset); tFill.style.width = (frac*100)+'%'; }
});

btnPP.addEventListener('click', e => { e.stopPropagation(); togglePlay(); });

/* ─── Keyboard shortcuts ─── */
document.addEventListener('keydown', e => {
  // Don't fire when typing in inputs
  if (['INPUT','SELECT','TEXTAREA'].includes(e.target.tagName)) return;
  if (e.code === 'Space') { e.preventDefault(); if (audioBuffer) togglePlay(); }
  if (e.code === 'Enter' && !btnMaster.disabled) { e.preventDefault(); btnMaster.click(); }
});

/* ═══════ VU Bar (28 segs) ═══════ */
const VU_N = 28;
for (let i=0;i<VU_N;i++) {
  const s = document.createElement('div');
  s.className = 'vu-s';
  vu.appendChild(s);
}
function setVu(lufs) {
  const segs = vu.children;
  const pct = lufs==null ? 0 : Math.min(1, Math.max(0,(lufs+60)/60));
  const lit = Math.round(pct*VU_N);
  Array.from(segs).forEach((s,i)=>{
    s.classList.remove('g','a','r');
    const pos=(i+1)/VU_N;
    if(i<lit){
      if(pos<.72)      s.classList.add('g');
      else if(pos<.88) s.classList.add('a');
      else             s.classList.add('r');
    }
  });
}
function setMeter(lufs) {
  if(lufs==null||isNaN(lufs)){
    meterVal.textContent='— LUFS'; meterVal.className='meter-val empty'; setVu(null); return;
  }
  meterVal.textContent = lufs.toFixed(1)+' LUFS';
  meterVal.className = 'meter-val '+(lufs>-9?'hot':lufs>-14?'warn':'good');
  setVu(lufs);
}

/* ═══════ Status ═══════ */
function setStatus(el,txt,type){
  el.textContent=txt; el.className='status'+(type?' '+type:'');
}

/* ═══════ Progress ═══════ */
function setProgress(pct,msg){
  progFill.style.width=pct+'%';
  progPct.textContent=Math.round(pct);
  progMsg.textContent=msg||'Обработка…';
  updatePipelineSteps(pct,msg);
}

/* ═══════ Pipeline step visualiser ═══════ */
const PIPE_MAP = [
  {step:'dc',      from:5,  to:20,  keys:['dc','смещени']},
  {step:'eq',      from:20, to:35,  keys:['eq','частот','equalizer']},
  {step:'dyn',     from:35, to:70,  keys:['динамик','максимайз','полос','dynamics']},
  {step:'lufs',    from:70, to:78,  keys:['lufs','нормализ']},
  {step:'final',   from:78, to:88,  keys:['финальн','спектр','жанр']},
  {step:'exciter', from:88, to:91,  keys:['эксайтер','exciter']},
  {step:'imager',  from:91, to:95,  keys:['стерео','imager','расширен']},
];
function updatePipelineSteps(pct,msg){
  const msgL=(msg||'').toLowerCase();
  PIPE_MAP.forEach(({step,from,to,keys})=>{
    const el=pipeline.querySelector(`[data-step="${step}"]`);
    if(!el) return;
    const matchMsg = keys.some(k=>msgL.includes(k));
    const inRange  = pct>=from && pct<to;
    const done     = pct>=to;
    el.classList.toggle('active', (inRange||matchMsg) && !done);
    el.classList.toggle('done',   done);
  });
}
function resetPipelineSteps(){
  pipeline.querySelectorAll('.pipe-step').forEach(el=>{
    el.classList.remove('active','done');
  });
}
function updateOzoneSteps(style){
  const isHouse = style === 'house_basic';
  const exciterEl = document.getElementById('pipeExciter');
  const imagerEl  = document.getElementById('pipeImager');
  if(exciterEl) exciterEl.style.display = isHouse ? '' : 'none';
  if(imagerEl)  imagerEl.style.display  = isHouse ? '' : 'none';
}

/* ═══════ Dropzone ═══════ */
drop.addEventListener('click', ()=>fileInput.click());
drop.addEventListener('dragover', e=>{e.preventDefault(); drop.classList.add('over')});
drop.addEventListener('dragleave', ()=>drop.classList.remove('over'));
drop.addEventListener('drop', e=>{
  e.preventDefault(); drop.classList.remove('over');
  const f=e.dataTransfer.files[0];
  if(f&&/\.(wav|mp3|flac)$/i.test(f.name)){ fileInput.files=e.dataTransfer.files; setFile(f); }
});
fileInput.addEventListener('change',()=>{ if(fileInput.files[0]) setFile(fileInput.files[0]); });

btnReset.addEventListener('click', e=>{
  e.stopPropagation();
  resetAll();
});

function fmtSize(bytes){
  if(bytes<1024*1024) return (bytes/1024).toFixed(0)+' KB';
  return (bytes/1024/1024).toFixed(1)+' MB';
}

function setFile(f){
  currentFile=f;
  fileName.textContent=f.name;
  fileMeta.textContent=fmtSize(f.size);
  fileInfo.classList.add('visible');
  drop.classList.add('has-file');
  btnMeasure.disabled=false;
  btnMaster.disabled=false;
  setMeter(null);
  setStatus(stMeasure,'');
  setStatus(stMaster,'');
  progWrap.classList.remove('on');
  pipeline.classList.remove('visible');
  resultPanel.classList.remove('visible');
  resetPipelineSteps();
  updateOzoneSteps(selectedStyle);
  // reset audio state
  stopAll();
  audioBuffer=null;
  masteredBuffer=null;
  abMode='a';
  abWrap.classList.remove('visible');
  dawCard.classList.remove('visible');
  lastDawState = null;
  btnABa.classList.add('active'); btnABb.classList.remove('active');
  audioMeta.classList.remove('visible');
  tTotal.textContent='0:00';
  playerEl.classList.add('visible');
  // decode async
  loadAudio(f);
}

function resetAll(){
  currentFile=null;
  fileInput.value='';
  fileName.textContent='';
  fileMeta.textContent='';
  fileInfo.classList.remove('visible');
  drop.classList.remove('has-file');
  btnMeasure.disabled=true;
  btnMaster.disabled=true;
  setMeter(null);
  setStatus(stMeasure,'');
  setStatus(stMaster,'');
  progWrap.classList.remove('on');
  pipeline.classList.remove('visible');
  resultPanel.classList.remove('visible');
  resetPipelineSteps();
  updateOzoneSteps(selectedStyle);
  // reset player
  stopAll();
  audioBuffer=null;
  masteredBuffer=null;
  abMode='a';
  abWrap.classList.remove('visible');
  dawCard.classList.remove('visible');
  lastDawState = null;
  btnABa.classList.add('active'); btnABb.classList.remove('active');
  playerEl.classList.remove('visible');
  audioMeta.classList.remove('visible');
  // clear canvas
  const ctx2=waveCanvas.getContext('2d');
  ctx2.clearRect(0,0,waveCanvas.width,waveCanvas.height);
}

/* ═══════ Style cards ═══════ */
styleGrid.addEventListener('click', e => {
  const card = e.target.closest('.style-card');
  if (!card) return;
  styleGrid.querySelectorAll('.style-card').forEach(c => c.classList.remove('active'));
  card.classList.add('active');
  selectedStyle = card.dataset.style;
  targetLufsInput.value = card.dataset.lufs;
  updateOzoneSteps(selectedStyle);
});

/* ═══════ A/B comparison ═══════ */
function setAB(mode) {
  abMode = mode;
  btnABa.classList.toggle('active', mode === 'a');
  btnABb.classList.toggle('active', mode === 'b');
  const buf = mode === 'b' && masteredBuffer ? masteredBuffer : audioBuffer;
  if (!buf) return;
  const wasPlaying = isPlaying;
  const pos = wasPlaying ? (getCtx().currentTime - startedAt) : pauseOffset;
  stopAll();
  // swap buffer reference temporarily for drawing
  const orig = audioBuffer;
  audioBuffer = buf;
  drawWaveform(buf.duration > 0 ? Math.min(pos / buf.duration, 1) : 0);
  pauseOffset = Math.min(pos, buf.duration);
  if (wasPlaying) playFrom(pauseOffset);
  else audioBuffer = orig; // restore; playFrom will use correct buf
  // keep the swapped buffer active for playback
  audioBuffer = buf;
}
btnABa.addEventListener('click', () => setAB('a'));
btnABb.addEventListener('click', () => setAB('b'));

/* ═══════ Measure ═══════ */
btnMeasure.addEventListener('click', async()=>{
  if(!currentFile) return;
  btnMeasure.disabled=true;
  wdeco.classList.add('active');
  setStatus(stMeasure,'Измерение уровня…');
  const form=new FormData();
  form.append('file',currentFile);
  try{
    const r=await fetch(API+'/api/measure',{method:'POST',body:form});
    const d=await r.json();
    if(!r.ok) throw new Error(d.detail||r.statusText);
    setMeter(d.lufs);
    // Update audio meta with server-side data
    if(d.peak_dbfs!=null) amPeak.textContent = d.peak_dbfs.toFixed(1)+' dB';
    if(d.channels!=null)  amCh.textContent   = d.channels===1?'Mono':'Stereo';
    if(d.sample_rate!=null) amSr.textContent  = (d.sample_rate/1000).toFixed(1)+' kHz';
    if(d.duration!=null)  { amDur.textContent=fmtTime(d.duration); audioMeta.classList.add('visible'); }
    const peakTxt = d.peak_dbfs!=null ? `  ·  Peak ${d.peak_dbfs.toFixed(1)} dB` : '';
    setStatus(stMeasure, 'Измерение завершено'+peakTxt, 'ok');
  }catch(e){
    const msg = friendlyError(e.message||'Ошибка измерения');
    setStatus(stMeasure, msg, 'err');
    toast(msg, 'err', msg.includes('ffmpeg') ? 8000 : 3000);
    setMeter(null);
  }
  btnMeasure.disabled=false;
  wdeco.classList.remove('active');
});

/* ═══════ Master ═══════ */
btnMaster.addEventListener('click', async()=>{
  if(!currentFile) return;
  let targetLufs = parseFloat(targetLufsInput.value);
  if(isNaN(targetLufs)) targetLufs=-14;

  btnMaster.disabled=true;
  btnMaster.classList.add('processing');
  btnMasterTxt.textContent='Обработка…';
  wdeco.classList.add('active');
  setStatus(stMaster,'');
  resultPanel.classList.remove('visible');
  progWrap.classList.add('on');
  pipeline.classList.add('visible');
  resetPipelineSteps();
  updateOzoneSteps(selectedStyle);
  setProgress(0,'Инициализация…');

  const form=new FormData();
  form.append('file',currentFile);
  form.append('target_lufs',targetLufs);
  form.append('out_format',outFormat.value);
  form.append('style',selectedStyle);

  try{
    const startRes=await fetch(API+'/api/master',{method:'POST',body:form});
    if(!startRes.ok){
      const err=await startRes.json().catch(()=>({}));
      throw new Error(err.detail||startRes.statusText);
    }
    const {job_id}=await startRes.json();
    const poll=()=>fetch(API+'/api/master/status/'+job_id).then(r=>r.json());

    let data;
    do{
      await new Promise(r=>setTimeout(r,300));
      data=await poll();
      setProgress(data.progress||0, data.message||'Обработка…');
      if(data.status==='error') throw new Error(data.error||'Ошибка мастеринга');
    } while(data.status==='running');

    if(data.status!=='done') throw new Error('Неизвестный статус');

    // Download
    const r=await fetch(API+'/api/master/result/'+job_id);
    if(!r.ok) throw new Error('Не удалось скачать результат');
    const blob=await r.blob();
    const name=(currentFile.name.replace(/\.[^.]+$/,'')||'master')+'_mastered.'+outFormat.value;
    // Download
    const dlUrl=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=dlUrl; a.download=name; a.click();
    // Decode mastered for A/B player
    try {
      const mastAB = await blob.arrayBuffer();
      masteredBuffer = await getCtx().decodeAudioData(mastAB);
      abWrap.classList.add('visible');
      // Switch to B (mastered) automatically
      const origBuf = audioBuffer;
      audioBuffer = masteredBuffer;
      await new Promise(rr=>requestAnimationFrame(()=>requestAnimationFrame(rr)));
      drawWaveform(0);
      audioBuffer = origBuf;
      abMode='b'; btnABa.classList.remove('active'); btnABb.classList.add('active');
    } catch(e) { console.warn('A/B decode failed', e); }
    URL.revokeObjectURL(dlUrl);

    // Mark all pipeline steps done
    pipeline.querySelectorAll('.pipe-step').forEach(el=>{ el.classList.remove('active'); el.classList.add('done'); });
    setProgress(100,'Готово!');

    // Show before/after panel
    if(data.before_lufs!=null && data.after_lufs!=null){
      rBefore.textContent = data.before_lufs.toFixed(1)+' LUFS';
      rAfter.textContent  = data.after_lufs.toFixed(1)+' LUFS';
      const delta = data.after_lufs - data.before_lufs;
      const sign  = delta>0?'+':'';
      rDelta.innerHTML = `Изменение: <strong>${sign}${delta.toFixed(1)} dB</strong> · Цель: <strong>${targetLufs} LUFS</strong>`;
      resultPanel.classList.add('visible');
      setMeter(data.after_lufs);
      if (audioBuffer && masteredBuffer) showDawComparison(audioBuffer, masteredBuffer, data.before_lufs, data.after_lufs);
    }

    setStatus(stMaster,'Скачано: '+name,'ok');
    toast('Готово! Файл скачан: '+name, 'ok', 4000);
    // Save to history
    saveToHistory({
      name: currentFile.name,
      size: fmtSize(currentFile.size),
      before: data.before_lufs,
      after:  data.after_lufs,
      target: targetLufs,
      fmt:    outFormat.value,
      date:   fmtDate(Date.now()),
      ts:     Date.now(),
    });
    setTimeout(()=>progWrap.classList.remove('on'), 2500);

  }catch(e){
    const msg = friendlyError(e.message||'Ошибка мастеринга');
    setStatus(stMaster, msg, 'err');
    toast(msg, 'err', msg.includes('ffmpeg') ? 10000 : 3000);
    setProgress(0,'');
    progWrap.classList.remove('on');
    pipeline.classList.remove('visible');
    resetPipelineSteps();
  }

  btnMaster.disabled=false;
  btnMaster.classList.remove('processing');
  btnMasterTxt.textContent='Запустить мастеринг';
  wdeco.classList.remove('active');
});
</script> -->
</body>
</html>
