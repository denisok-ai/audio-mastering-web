# Детальная инструкция для пользователя — Magic Master

Пошаговое руководство по установке, запуску и использованию веб-приложения автоматического мастеринга аудио. Рассчитано на пользователей Ubuntu 22.04 / 24.04 (в том числе новичков).

---

## 1. Для кого эта инструкция

- **Обычный пользователь** — хочет запустить приложение и обработать треки (разделы 2–5).
- **Разработчик / тестировщик** — нужна полная отладка: тесты, самодиагностика, ручная проверка (раздел 7).

---

## 2. Требования к системе

- **ОС:** Ubuntu 22.04 или 24.04 (или другой дистрибутив с Python 3.10+ и FFmpeg).
- **Python:** версия 3.10 или выше.
- **FFmpeg** — обязателен для загрузки и экспорта MP3/FLAC.
- **Браузер:** любой современный (Chrome, Firefox, Edge и т.п.).

Проверка версий в терминале:

```bash
python3 --version    # должно быть 3.10 или выше
ffmpeg -version     # если команда не найдена — FFmpeg нужно установить
```

---

## 3. Установка (один раз)

### 3.1. Установка системных пакетов

Откройте терминал (Ctrl+Alt+T) и выполните (потребуется пароль администратора):

```bash
sudo apt update
sudo apt install -y ffmpeg libatomic1 python3.10-venv python3-pip
```

- **ffmpeg** — работа с аудио (MP3, FLAC, WAV).
- **libatomic1** — библиотека для работы приложения.
- **python3.10-venv** — создание виртуального окружения Python.

Если у вас уже установлен другой способ получения Python 3.10+ (например, pyenv), пакет `python3.10-venv` можно заменить на соответствующий для вашей версии Python.

### 3.2. Переход в каталог проекта

Подставьте свой путь к проекту вместо `~/projects/audio-mastering-web`:

```bash
cd ~/projects/audio-mastering-web
```

Или, если проект лежит, например, в `Документы`:

```bash
cd ~/Документы/audio-mastering-web
```

### 3.3. Создание виртуального окружения и установка зависимостей (если запускаете вручную)

Если используете скрипт `start.sh` (раздел 4.1), этот шаг выполняется автоматически. Если хотите настроить всё вручную:

```bash
cd backend
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

После этого окружение создано, зависимости установлены. Команду `source venv/bin/activate` нужно выполнять каждый раз в новом терминале, если вы запускаете сервер вручную (см. раздел 4.2).

---

## 4. Запуск приложения

### 4.1. Простой способ (рекомендуется)

Из **корня** проекта (каталог `audio-mastering-web`):

```bash
./start.sh
```

Скрипт сам:
- проверит наличие FFmpeg и при необходимости предложит установить пакеты;
- создаст или обновит виртуальное окружение в `backend/venv`;
- установит зависимости из `requirements.txt`;
- запустит сервер.

В консоли появится сообщение вроде:
«Сервер запущен. Откройте в браузере: http://localhost:8000».

- Откройте в браузере: **http://localhost:8000**
- Остановка сервера: в терминале нажмите **Ctrl+C**.

### 4.2. Запуск вручную (без start.sh)

Если вы уже создали venv и установили зависимости (раздел 3.3):

```bash
cd backend
source venv/bin/activate
python run.py
```

Либо без активации venv:

```bash
cd backend
./venv/bin/python run.py
```

Затем откройте в браузере: **http://localhost:8000**.

### 4.3. Режим отладки (все функции без входа)

Чтобы пользоваться всеми жанрами, экспортом в MP3/FLAC и без лимита мастерингов **без регистрации**, запустите:

```bash
MAGIC_MASTER_DEBUG=1 ./start.sh
```

Или из каталога `backend`:

```bash
MAGIC_MASTER_DEBUG=1 ./venv/bin/python run.py
```

В интерфейсе появится жёлтый бейдж «Режим отладки · все функции без входа». Используйте только локально.

---

## 5. Как пользоваться интерфейсом

### 5.1. Главная страница и навигация

- **/** — лендинг (главная страница сайта).
- **/app** — само приложение мастеринга (загрузка файла, замер, мастеринг).
- В шапке приложения есть ссылки: «На главную», «Войти / Зарегистрироваться», «Дашборд» (если вы вошли).

### 5.2. Загрузка файла

1. На странице приложения нажмите зону «Перетащите файл сюда или нажмите для выбора» или выберите файл через диалог.
2. Поддерживаемые форматы: **WAV, MP3, FLAC**. Максимальный размер — по умолчанию 100 МБ (настраивается на сервере).
3. После выбора отобразятся имя файла, размер и станут активными кнопки «Измерить громкость» и «Запустить мастеринг».

### 5.3. Измерение громкости (LUFS)

1. Загрузите файл (п. 5.2).
2. Нажмите **«Измерить громкость»**.
3. Дождитесь ответа сервера. Появятся:
   - интегральный **LUFS** (уровень громкости);
   - при необходимости — **график LUFS по времени**, **спектр**, **векторскоп**, **стерео-корреляция** (для стерео).
4. После замера станет доступна кнопка **«Скачать отчёт»** (текстовый отчёт) и **«JSON»** (те же данные в формате JSON).

### 5.4. Выбор стиля и целевого LUFS

- В блоке с карточками выберите **стиль** (Stream, EDM, Hip-Hop, Classical и т.д.). У каждого стиля свой целевой LUFS (например, −14 для стриминга).
- Целевой LUFS можно скорректировать в поле рядом (если интерфейс это позволяет).
- На тарифе Free часть стилей может быть заблокирована (иконка замка); разблокировка — через регистрацию/Pro или режим отладки (п. 4.3).

### 5.5. Цепочка модулей (расширенные настройки)

- Раскройте блок **«Цепочка модулей»**.
- Внутри отображаются модули обработки (EQ, динамика, реверб, эксайтер и т.д.).
- Можно менять **порядок** перетаскиванием, **Amount** (глубину эффекта), **режим фазы** (Min. фаза / Linear phase), **тип реверберации**, при необходимости — **M/S**, **oversampling** и т.д.
- Для сохранения и загрузки своих настроек (пресетов) используйте блок **«Сохранить пресет»** / **«Загрузить пресет»** (доступен после входа в аккаунт).

### 5.6. Запуск мастеринга и скачивание результата

1. Убедитесь, что файл загружен, при необходимости выберите стиль и целевой LUFS (и при желании настройте цепочку).
2. В блоке **«Параметры»** выберите формат экспорта: **WAV**, **MP3** или **FLAC** (MP3/FLAC могут быть доступны только на Pro или в режиме отладки).
3. Нажмите **«Запустить мастеринг»**.
4. Дождитесь окончания обработки (прогресс отображается на экране).
5. По завершении начнётся **скачивание** обработанного файла; в интерфейсе появятся блоки «До» / «После» с LUFS и переключатель A/B для сравнения оригинала и мастера.

### 5.7. Сравнение до/после (A/B)

После успешного мастеринга становятся доступны кнопки **A** (оригинал) и **B** (обработанный вариант). Рядом отображаются значения LUFS для A и B. Переключая A/B, можно прослушивать и сравнивать оба варианта.

### 5.8. Тарифы и ограничения

- **Free (без входа):** ограниченное число мастерингов в день (например, 3), часть стилей и экспорт только в WAV могут быть ограничены.
- **Pro (после входа):** больше возможностей, сохранение пресетов, приоритетная очередь, экспорт в MP3/FLAC и т.д.
- Текущий тариф и остаток мастерингов отображаются в шапке приложения. Подробнее — в разделе «Тарифы» на сайте и в [doc/ФУНКЦИИ_И_УРОВНИ.md](doc/ФУНКЦИИ_И_УРОВНИ.md).

---

## 6. Частые проблемы и решение

| Проблема | Что сделать |
|----------|-------------|
| «Команда не найдена: python3» или «venv» | Установите Python 3.10+ и пакет `python3.10-venv`: `sudo apt install python3.10-venv`. |
| «ffmpeg не найден» или ошибки при загрузке MP3/FLAC | Установите FFmpeg: `sudo apt install ffmpeg`. |
| Ошибка при `pip install -r requirements.txt` | Убедитесь, что активировано окружение: `source venv/bin/activate`; при необходимости обновите pip: `pip install --upgrade pip`. |
| Сервер не открывается по http://localhost:8000 | Проверьте, что сервер действительно запущен в терминале и нет ошибок; попробуйте другой браузер или очистить кэш. |
| «Лимит исчерпан» (429) | Это ограничение тарифа Free. Войдите в аккаунт (Pro) или запустите в режиме отладки: `MAGIC_MASTER_DEBUG=1 ./start.sh`. |
| Кнопки «Измерить громкость» / «Запустить мастеринг» не активны | Сначала загрузите файл (WAV, MP3 или FLAC). |

---

## 7. Полная отладка кода (для разработчиков)

Если вы дорабатываете проект или хотите убедиться, что все проверки проходят, выполните шаги ниже.

### 7.1. Зависимости для тестов

В `backend/requirements.txt` уже должны быть указаны: `pytest`, `httpx`, `anyio`. Если вы только что клонировали репозиторий, установите зависимости:

```bash
cd backend
./venv/bin/pip install -r requirements.txt
```

### 7.2. Запуск API-тестов (pytest)

```bash
cd backend
./venv/bin/python -m pytest tests/ -v --tb=short
```

Ожидается: все тесты завершаются успешно (exit code 0). При падениях смотрите вывод pytest (traceback) и исправляйте код в `backend/app/` или тесты в `backend/tests/`.

### 7.3. Самодиагностика конвейера

Проверка конвейера по критериям LUFS, True Peak и отсутствию NaN:

```bash
cd backend
./venv/bin/python run_self_diagnosis.py
```

Без аргументов скрипт генерирует тестовый тон и выводит отчёт. Ожидаемая строка в конце: **«Итог: самодиагностика пройдена.»** и код возврата 0.

Проверка своего файла и целевого LUFS (например, −14):

```bash
./venv/bin/python run_self_diagnosis.py /путь/к/вашему/файлу.wav -14
```

### 7.4. Ручная проверка в браузере

1. Запустите сервер: из корня проекта `./start.sh` или из `backend`: `./venv/bin/python run.py`.
2. Откройте в браузере **http://localhost:8000** (приложение — по ссылке /app или с главной).
3. Пройдите сценарии:
   - загрузка файла → «Измерить громкость» → проверка LUFS, спектра, графика LUFS по времени, стерео-корреляции;
   - выбор стиля/целевого LUFS, при необходимости изменение цепочки (phase_mode, reverb_type и т.д.) → «Запустить мастеринг» → дождаться завершения → скачивание результата;
   - при ошибках смотрите вкладку **Network** в инструментах разработчика (F12) и логи сервера в терминале.

### 7.5. Опциональные скрипты

- **Генерация тестового сигнала и мастеринг, сохранение WAV:**

  ```bash
  cd backend
  ./venv/bin/python run_test_master.py
  ```

  Результат сохраняется в каталог `test_output/` в корне проекта.

- **Диагностика своего файла (LUFS до/после, сохранение мастер-файла):**

  ```bash
  ./venv/bin/python run_diagnose_file.py /путь/к/файлу.wav
  ```

  Рядом с исходным файлом будет создан файл `*_mastered.wav`.

---

## 8. Полезные ссылки

- **Документация API:** после запуска сервера откройте в браузере **http://localhost:8000/docs**.
- **Статус плана разработки:** в футере приложения — ссылка «Статус плана» или файл [PROGRESS.md](PROGRESS.md).
- **Развёртывание на сервере:** [DEPLOY.md](DEPLOY.md).
- **История изменений:** [CHANGELOG.md](CHANGELOG.md).
- **Функции по тарифам:** [doc/ФУНКЦИИ_И_УРОВНИ.md](doc/ФУНКЦИИ_И_УРОВНИ.md).

---

**Кратко:** установите FFmpeg и зависимости (раздел 3), запустите `./start.sh` (раздел 4), откройте http://localhost:8000, загрузите файл, при необходимости нажмите «Измерить громкость», затем «Запустить мастеринг» и скачайте результат. При проблемах — раздел 6; для полной отладки кода — раздел 7.
