# Аудит: редизайн админ-панели

**Дата:** 2026-02-28  
**План:** редизайн_админ-панели_7031516d

## 1. Аудит кода

### 1.1 Реализовано

- **БД и слой настроек:** таблица `system_settings`, модель `SystemSetting`; модуль `settings_store.py` с `get_setting`, `set_setting`, `get_all_overrides`, типизированные обёртки (`get_setting_int`, `get_setting_bool` и т.д.). Чтение в `main.py` для `max_upload_mb`, `temp_dir`, `jobs_done_ttl_seconds`, `default_target_lufs`; в `helpers.py` для `allowed_extensions`.
- **API настроек:** `PATCH /api/admin/settings` с секциями app, smtp, yookassa, telegram, llm; запись в `system_settings`, AuditLog; маскирование секретов в GET.
- **UI настроек:** табы Общие | SMTP | YooKassa | Telegram | LLM; формы с сохранением; тосты при успехе/ошибке.
- **Промпты:** таблица `prompt_templates` (slug, body, is_active, version, created_by); API GET/POST промптов, история, activate, reset; `ai.py` читает промпты из БД → env → встроенные. UI: блок «Промпты» во вкладке LLM, модалки редактирования и истории.
- **Отчётность — данные:** таблицы `ai_usage_log`, `mastering_job_events`; вызовы `log_ai_usage` в эндпоинтах AI; `log_mastering_job_start`/`log_mastering_job_end` в задачах мастеринга.
- **Отчётность — API и UI:** 10 отчётов (registrations_by_day, tier_distribution, revenue_by_period, masterings_by_day, avg_lufs_by_style, ai_usage_by_type, errors_failures, popular_styles, user_activity, export_raw); `GET /api/admin/reports/list`, `GET /api/admin/reports/{id}`, `POST /api/admin/reports/{id}/summarize`, экспорт CSV с авторизацией; страница «Отчётность» в сайдбаре с фильтрами и кнопкой «Резюме LLM».
- **Доп. настройки:** флаги и уведомления (feature_ai_enabled, maintenance_mode, notify_* и т.д.) в форме «Общие» и в `system_settings`.

### 1.2 Выявленные проблемы и исправления

| Проблема | Решение |
|----------|---------|
| **ai.py не читал LLM-настройки из БД** — после смены ключа/бэкенда в админке использовался только .env | Добавлена `_get_llm_setting()` в `ai.py` с приоритетом settings_store → config; `_get_llm_client()` и `get_ai_limit_for_tier()` переведены на чтение из слоя настроек. |
| **log_ai_usage принимал user_id как строку (JWT sub)** — риск несовместимости с типом колонки | В `main.py` перед вызовом `log_ai_usage` выполняется безопасное приведение `user_id` к int с обработкой исключений. |
| **План предполагал отдельный пункт «LLM» в сайдбаре** | Реализовано как вкладка «LLM» внутри «Настройки» (Подключение + Промпты). Отдельный пункт меню «LLM» можно добавить при желании. |

### 1.3 Оставшиеся замечания по коду

- **maintenance_mode:** флаг сохраняется в БД и отображается в форме, но **логика 503 / страница «На обслуживании» в main.py не реализована**. Рекомендация: добавить middleware или проверку `settings_store.get_setting_bool("maintenance_mode")` для не-админских маршрутов.
- **feature_ai_enabled / feature_batch_enabled / feature_registration_enabled:** сохранение и отображение есть; **проверки на бэкенде и скрытие блоков на фронте** по этим флагам не добавлены. Рекомендация: в API мастеринга/AI и регистрации проверять флаги; в `app.js`/страницах — скрывать соответствующие блоки при `feature_* === false`.
- **Журнал действий (AuditLog):** в плане указан раздел с фильтром по действию и дате; в админке наличие раздела «Журнал» не проверялось — при отсутствии его стоит добавить.
- **Валидация PATCH настроек:** ограничения (например, `max_upload_mb` 1–500) заданы на фронте; на бэкенде в Pydantic можно добавить `Field(ge=1, le=500)` и т.п. для согласованности.

---

## 2. Аудит дизайна и UX

### 2.1 Соответствие плану

- Навигация: Dashboard, Пользователи, Транзакции, Новости, Рассылки, **Отчётность**, Настройки. Подраздел LLM внутри Настроек (таб) — соответствует описанию «подраздел внутри Настройки с табами».
- Формы: группировка по карточкам, секреты без отображения текущего значения, подписи к полям, тосты при сохранении — выполнено.
- Промпты: список из четырёх слотов, кнопки Редактировать / История / Восстановить, модальное редактирование с «Сохранить как новую версию» — выполнено. Опциональные «именованные шаблоны» (template_name) в плане не реализованы.
- Отчётность: список отчётов, фильтры по датам, таблица результата, «Резюме LLM», экспорт CSV для export_raw — выполнено. Сортировка по колонкам в таблице отчёта не реализована (можно добавить на фронте).

### 2.2 Рекомендации по UX/UI

- **Подсветка активного отчёта:** кнопки выбора отчёта получают класс `active` при выборе — стиль добавлен (`.report-select.active`). Убедиться, что при первом открытии страницы выбран хотя бы один отчёт или показана подсказка «Выберите отчёт».
- **Пустые состояния:** для отчётов выводится «Нет данных за выбранный период» при пустом результате — ок. Для списка промптов при отсутствии версий в истории — «Нет версий» выводится.
- **Доступность:** порядок фокуса и подписи полей в формах соблюдены; при необходимости добавить `aria-label` для кнопок без текста и проверить контраст кнопок.

---

## 3. Корректировка плана разработки

- **Этапы 1–9** из плана в целом выполнены; текущее состояние описано в п. 1.1.
- **Дополнительные задачи** (бэклог):
  1. ✅ **maintenance_mode** — реализовано: middleware в main.py, страница «Сайт на обслуживании» (503) для не-админских маршрутов.
  2. ✅ **Флаги функций** — реализовано: проверки в API (register, ai/*, v2/batch), флаги в /api/health, скрытие блоков на фронте (app.js, login/register).
  3. При необходимости — отдельный пункт сайдбара **«LLM»** с подпунктами Подключение | Промпты вместо только таба в Настройках.
  4. ✅ **Журнал действий** — реализовано: раздел «Журнал» в админке, GET /api/admin/audit с фильтрами action, date_from, date_to, пагинация.
  5. Опционально: **именованные шаблоны промптов** (template_name), кнопка «Применить шаблон» в редакторе промпта.
  6. Опционально: отчёт **«Рекомендации по промптам»** на основе ai_usage_log и активных промптов с советами LLM.
  7. ✅ **Защита от LLM-инъекций:** реализовано — модуль `llm_guard.py`, настраиваемая проверка (запрещённые подстроки, regex, лимиты длины, блокировка роли system в чате); настройки во вкладке LLM админки; интеграция в `nl_to_config` и `chat_assistant`.
