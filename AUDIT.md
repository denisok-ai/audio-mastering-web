# Аудит проекта Magic Master

> Дата: 2026-02-27  
> Цель: оценка текущего состояния, архитектуры и рекомендации по оптимизации.

---

## 1. Обзор проекта

**Magic Master** — веб-приложение автоматического мастеринга аудио. Пользователь загружает файл (WAV/MP3/FLAC), выбирает пресет или целевой LUFS, запускает мастеринг и скачивает результат.

**Стек:**
- **Backend:** Python 3.10+, FastAPI, uvicorn; обработка звука: numpy, scipy, soundfile, pyloudnorm, pydub.
- **Frontend:** одностраничное приложение (HTML + CSS + JS в одном файле), раздаётся через FastAPI StaticFiles.
- **Деплой:** systemd, опционально nginx + HTTPS.

---

## 2. Структура и архитектура

### 2.1 Текущая архитектура

```
audio-mastering-web/
├── backend/
│   ├── app/
│   │   ├── __init__.py
│   │   ├── config.py      # Настройки (Pydantic, env)
│   │   ├── main.py        # FastAPI: API + раздача фронтенда
│   │   └── pipeline.py    # Весь конвейер мастеринга (~400 строк)
│   ├── requirements.txt
│   ├── run.py             # uvicorn с --reload
│   ├── run_production.py  # uvicorn без reload, host/port из env
│   └── run_*.py           # Утилиты: тесты, диагностика
├── frontend/
│   └── index.html        # Всё UI: разметка + стили + логика (~1700+ строк)
├── deploy/
│   ├── nginx/
│   └── systemd/
├── doc/                   # DLL-анализ iZotope (справочно)
├── start.sh               # Быстрый старт (проверка пакетов + venv + run)
├── install_and_run.sh     # Пошаговая установка + run
├── pack_for_deploy.sh     # Упаковка архива для сервера
├── README.md, DEPLOY.md, ROADMAP.md
└── КАК_ЗАПУСТИТЬ.txt
```

**Поток данных:**
1. Пользователь загружает файл → `POST /api/measure` (LUFS) или `POST /api/master` (запуск задачи).
2. Мастеринг выполняется в фоне (`BackgroundTasks` + `asyncio.to_thread`), состояние хранится в словаре `_jobs` в памяти.
3. Клиент опрашивает `GET /api/master/status/{job_id}`, по готовности скачивает `GET /api/master/result/{job_id}`.

### 2.2 Выявленные проблемы архитектуры

| Проблема | Описание | Критичность |
|----------|----------|-------------|
| Монолитный pipeline | Весь конвейер в одном файле `pipeline.py` (DC, EQ, dynamics, maximizer, LUFS, exciter, imager). Сложно тестировать по модулям и расширять новыми алгоритмами. | Средняя |
| Монолитный фронтенд | Один `index.html` с встроенными CSS и JS (~1700+ строк). Нет разделения на компоненты/модули, нет сборки. | Средняя (для текущего масштаба приемлемо) |
| Хранение задач в памяти | `_jobs` — in-memory dict. При перезапуске сервера все задачи теряются. Для одного воркера и текущей нагрузки допустимо, но нет очистки старых записей (если пользователь не скачал результат — запись остаётся навсегда). | Средняя |
| Два префикса переменных окружения | В `config.py`: `MASTERFLOW_*`; в `run_production.py` и DEPLOY: `MAGIC_MASTER_HOST/PORT`. Разные названия продукта в конфиге. | Низкая |
| Неиспользуемые зависимости | В `requirements.txt`: `pedalboard`, в комментарии pipeline — `librosa`; в коде не импортируются. Увеличивают время установки и риск конфликтов. | Низкая |
| Неиспользуемая настройка | `config.default_target_lufs` не используется в API (в Form жёстко -14.0). | Низкая |
| Нет health-check | Для деплоя за балансировщиком или мониторингом удобен endpoint вида `GET /api/health`. | Низкая |

---

## 3. Безопасность и эксплуатация

| Аспект | Состояние | Рекомендация |
|--------|-----------|--------------|
| CORS | `allow_origins=["*"]` | Для публичного инструмента допустимо; при появлении авторизации — ограничить origins. |
| Размер загрузки | Ограничен `max_upload_mb` (по умолчанию 100) | Ок. |
| Валидация форматов | Проверка расширения и наличие ffmpeg для MP3 | Ок. |
| Rate limiting | Отсутствует | При росте нагрузки добавить (например, slowapi или nginx). |
| Очистка задач | Результат удаляется из `_jobs` только после скачивания; иначе запись висит вечно | Добавить TTL или максимум записей в `_jobs` с вытеснением старых. |

---

## 4. Качество кода

- **Плюсы:** типные аннотации, докстринги, разделение API и конвейера, понятная структура роутов.
- **Минусы:** в `pipeline.py` много функций подряд без абстракции (цепочка модулей в ROADMAP v2 как раз это исправляет); во фронтенде всё в одном файле.

---

## 5. Деплой и документация

- **Плюсы:** есть README, DEPLOY.md, ROADMAP.md, start.sh, install_and_run.sh, pack_for_deploy.sh, systemd и nginx шаблоны.
- **Замечания:**
  - В `pack_for_deploy.sh` не включены ROADMAP.md, install_and_run.sh, КАК_ЗАПУСТИТЬ.txt — при необходимости добавить в архив.
  - Единый префикс env (MAGIC_MASTER_) упростит настройку на сервере.

---

## 6. Рекомендуемые изменения архитектуры

### 6.1 Унификация конфигурации

- Привести все переменные окружения к одному префиксу **MAGIC_MASTER_** (или оставить MASTERFLOW_ везде, но единообразно). В отчёте рекомендован MAGIC_MASTER_ как соответствующий названию продукта.
- В API использовать `settings.default_target_lufs` для значения по умолчанию в форме мастеринга.

### 6.2 Backend: управление задачами

- Оставить хранение задач в памяти (без БД/Redis) для текущего масштаба.
- Добавить:
  - **Очистку по времени:** например, удалять задачу из `_jobs` через 1 час после перехода в `done` или `error`, или при следующем запросе статуса.
  - **Ограничение числа задач:** максимум N записей в `_jobs`, при превышении удалять самые старые (по времени создания или последнего доступа).

Это предотвратит неограниченный рост памяти при большом числе пользователей или при забытых задачах.

### 6.3 Backend: модульный конвейер (по ROADMAP v2)

- Ввести слой модулей (`backend/app/modules/`): базовый класс, отдельные файлы под EQ, dynamics, maximizer, exciter, imager и т.д.
- Ввести `MasteringChain` (или аналог), собирающий цепочку из конфига.
- Сохранить совместимость текущего API v1: существующий `run_mastering_pipeline()` может собирать цепочку из дефолтного конфига, так что поведение не изменится.
- Это улучшит тестируемость и подготовит почву для `POST /api/v2/master` с JSON-конфигом цепочки.

### 6.4 Frontend

- **Краткосрочно:** вынести CSS и JS в отдельные файлы (`styles.css`, `app.js`) и подключать их из `index.html`. Это упростит поддержку без смены стека.
- **Долгосрочно (при росте функционала):** рассмотреть лёгкий сборщик (Vite + vanilla JS или минимальный фреймворк) и разбиение на компоненты/экраны.

### 6.5 Зависимости

- **pedalboard:** удалить из `requirements.txt` и из комментария в `pipeline.py`, если не планируется использование в ближайших фазах. Либо оставить и явно использовать хотя бы в одном месте (например, один эффект).
- **librosa:** в коде не используется; в комментарии pipeline указан ошибочно. Удалить из комментария; в requirements его нет.

### 6.6 API

- Добавить **GET /api/health** (или /health), возвращающий `{"status": "ok"}` и, при желании, версию приложения. Удобно для проверки живости сервиса при деплое и мониторинге.

---

## 7. Итоговая сводка

| Категория | Оценка | Комментарий |
|-----------|--------|-------------|
| Функциональность | Хорошо | Мастеринг, пресеты, форматы, прогресс, история работают. |
| Архитектура backend | Удовлетворительно | Монолитный pipeline; модульный рефакторинг уже заложен в ROADMAP. |
| Архитектура frontend | Удовлетворительно | Один файл — приемлемо для текущего объёма; желательно разнести CSS/JS. |
| Конфигурация и env | Удовлетворительно | Разные префиксы; рекомендуется унификация. |
| Безопасность/нагрузка | Удовлетворительно | Нет rate limit и очистки старых задач; для малой нагрузки ок. |
| Деплой и документация | Хорошо | Скрипты и инструкции есть; мелкие дополнения по архиву и health. |
| Зависимости | Удовлетворительно | Есть неиспользуемые (pedalboard); лучше удалить или использовать. |

**Вывод:** кардинальная смена архитектуры не требуется. Целесообразно: (1) унифицировать конфиг и добавить очистку/лимит задач и health endpoint; (2) выполнить модульный рефакторинг конвейера по ROADMAP; (3) вынести CSS/JS фронтенда в отдельные файлы; (4) удалить или задействовать pedalboard. После этого архитектура будет оптимальной для текущего и ближайшего развития проекта.
